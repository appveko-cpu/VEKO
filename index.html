<!DOCTYPE html>
<html lang="fr" data-theme="system">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0f1e">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-TileColor" content="#0a0f1e">
    <title>VEKO - La vision de ce que vous gagnez vraiment</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <style>
    :root {
        --ultra-dark: #0a0f1e;
        --dark-surface: #0d1424;
        --dark-card: #121a2e;
        --dark-elevated: #1a2438;
        --diamond-border: rgba(255, 255, 255, 0.10);
        --diamond-border-hover: rgba(255, 255, 255, 0.18);
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-muted: rgba(255, 255, 255, 0.5);
        --accent-green: #10b981;
        --accent-blue: #3b82f6;
        --accent-purple: #8b5cf6;
        --accent-orange: #f59e0b;
        --accent-red: #ef4444;
        --accent-cyan: #06b6d4;
        --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.14);
        --blur-amount: 18px;
        --card-radius: 24px;
    }
    
    [data-theme="light"] {
        --ultra-dark: #f0f4f8;
        --dark-surface: #ffffff;
        --dark-card: #ffffff;
        --dark-elevated: #f8fafc;
        --diamond-border: rgba(0, 0, 0, 0.08);
        --diamond-border-hover: rgba(0, 0, 0, 0.15);
        --text-primary: #1a1a2e;
        --text-secondary: rgba(26, 26, 46, 0.7);
        --text-muted: rgba(26, 26, 46, 0.5);
        --glass-bg: rgba(255, 255, 255, 0.8);
        --glass-border: rgba(0, 0, 0, 0.08);
    }

    [data-theme="system"] {
        /* Herite du systeme via prefers-color-scheme */
    }

    @media (prefers-color-scheme: light) {
        [data-theme="system"] {
            --ultra-dark: #f0f4f8;
            --dark-surface: #ffffff;
            --dark-card: #ffffff;
            --dark-elevated: #f8fafc;
            --diamond-border: rgba(0, 0, 0, 0.08);
            --diamond-border-hover: rgba(0, 0, 0, 0.15);
            --text-primary: #1a1a2e;
            --text-secondary: rgba(26, 26, 46, 0.7);
            --text-muted: rgba(26, 26, 46, 0.5);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.08);
        }
    }

    @media (prefers-color-scheme: dark) {
        [data-theme="system"] {
            --ultra-dark: #0a0f1e;
            --dark-surface: #0d1424;
            --dark-card: #121a2e;
            --dark-elevated: #1a2438;
            --diamond-border: rgba(255, 255, 255, 0.10);
            --diamond-border-hover: rgba(255, 255, 255, 0.18);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.14);
        }
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: 'Inter', system-ui, sans-serif;
        background: var(--ultra-dark);
        min-height: 100vh;
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    /* SKELETON LOADING - Premium */
    .skeleton {
        background: linear-gradient(
            90deg, 
            var(--dark-card) 0%, 
            var(--dark-elevated) 20%, 
            rgba(255, 255, 255, 0.08) 50%, 
            var(--dark-elevated) 80%, 
            var(--dark-card) 100%
        );
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
        border-radius: 12px;
        border: 1px solid var(--diamond-border);
    }
    
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .skeleton-text { 
        height: 16px; 
        margin-bottom: 8px; 
        border-radius: 8px;
    }
    .skeleton-title { 
        height: 28px; 
        width: 60%; 
        margin-bottom: 12px; 
        border-radius: 10px;
    }
    .skeleton-card { 
        height: 120px; 
        margin-bottom: 16px; 
        border-radius: 20px;
    }
    .skeleton-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 12px;
    }
    .skeleton-btn {
        height: 48px;
        width: 100%;
        border-radius: 14px;
    }

    /* GLASSMORPHISM CARDS */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur-amount));
        -webkit-backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        border-radius: var(--card-radius);
        padding: 24px;
        margin-bottom: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .glass-card:hover {
        border-color: var(--diamond-border-hover);
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    /* BENTO GRID */
    .bento-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .bento-grid .bento-item {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur-amount));
        -webkit-backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        border-radius: var(--card-radius);
        padding: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .bento-grid .bento-item:hover {
        border-color: var(--diamond-border-hover);
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    }

    .bento-grid .bento-item.bento-large {
        grid-column: span 2;
    }

    .bento-grid .bento-item.bento-tall {
        grid-row: span 2;
    }

    .bento-item-title {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .bento-item-value {
        font-size: 24px;
        font-weight: 900;
        color: var(--text-primary);
    }

    .bento-item-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin-bottom: 12px;
    }

    /* PINTEREST CARDS */
    .pin-grid {
        column-count: 2;
        column-gap: 16px;
    }

    .pin-card {
        break-inside: avoid;
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur-amount));
        -webkit-backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        border-radius: var(--card-radius);
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }

    .pin-card:hover {
        border-color: var(--diamond-border-hover);
        transform: translateY(-4px);
        box-shadow: 0 16px 48px rgba(0,0,0,0.3);
    }

    .pin-card-image {
        width: 100%;
        border-radius: 16px;
        margin-bottom: 12px;
        object-fit: cover;
    }

    .pin-card-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 6px;
        line-height: 1.3;
    }

    .pin-card-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 10px;
    }

    .pin-card-price {
        font-size: 18px;
        font-weight: 900;
        color: var(--accent-green);
    }

    .pin-card-badge {
        display: inline-block;
        padding: 4px 10px;
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent-blue);
        border-radius: 8px;
        font-size: 10px;
        font-weight: 700;
        margin-top: 8px;
    }

    /* ACTIVITY RING - Apple Watch Style */
    .activity-ring-container {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto 20px;
    }
    
    .activity-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        fill: none;
        stroke-linecap: round;
    }
    
    .activity-ring-bg {
        stroke: rgba(255, 255, 255, 0.08);
    }
    
    .activity-ring-progress {
        transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .ring-benefice { stroke: var(--accent-green); }
    .ring-ca { stroke: var(--accent-blue); }
    .ring-ventes { stroke: var(--accent-purple); }
    
    .activity-ring-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .activity-ring-value {
        font-size: 28px;
        font-weight: 900;
        color: var(--text-primary);
    }
    
    .activity-ring-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .activity-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 16px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--text-secondary);
    }
    
    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    /* MICRO-BADGES */
    .micro-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .badge-bronze {
        background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
        color: white;
    }
    
    .badge-silver {
        background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
        color: #1a1a1a;
    }
    
    .badge-gold {
        background: linear-gradient(135deg, #ffd700 0%, #daa520 100%);
        color: #1a1a1a;
    }
    
    .badge-platinum {
        background: linear-gradient(135deg, #e5e4e2 0%, #a0a0a0 100%);
        color: #1a1a1a;
    }
    
    .badge-diamond {
        background: linear-gradient(135deg, #b9f2ff 0%, #4dd0e1 50%, #00bcd4 100%);
        color: #1a1a1a;
        box-shadow: 0 0 20px rgba(77, 208, 225, 0.5);
    }

    /* FAB - Floating Action Button */
    .fab-container {
        position: fixed;
        bottom: 90px;
        right: 20px;
        z-index: 500;
    }
    
    .fab-main {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--gradient-primary);
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 8px 30px rgba(59, 130, 246, 0.5);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .fab-main:hover {
        transform: scale(1.1) rotate(45deg);
    }
    
    .fab-main.active {
        transform: rotate(45deg);
        background: var(--accent-red);
    }
    
    .fab-menu {
        position: absolute;
        bottom: 70px;
        right: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fab-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .fab-item {
        display: flex;
        align-items: center;
        gap: 10px;
        white-space: nowrap;
    }
    
    .fab-item button {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: all 0.2s;
    }
    
    .fab-item span {
        background: var(--dark-elevated);
        color: var(--text-primary);
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* MORNING BRIEF STORY */
    .story-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--ultra-dark);
        z-index: 10000;
        display: none;
        flex-direction: column;
    }
    
    .story-overlay.show {
        display: flex;
        animation: fadeIn 0.3s ease-out;
    }
    
    .story-progress-bar {
        height: 4px;
        background: rgba(255,255,255,0.2);
        margin: 20px;
        border-radius: 2px;
        overflow: hidden;
    }
    
    .story-progress-fill {
        height: 100%;
        background: var(--accent-blue);
        width: 0%;
        transition: width 5s linear;
    }
    
    .story-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 24px;
        text-align: center;
    }
    
    .story-greeting {
        font-size: 18px;
        color: var(--text-muted);
        margin-bottom: 8px;
    }
    
    .story-title {
        font-size: 32px;
        font-weight: 900;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 40px;
    }
    
    .story-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        width: 100%;
        max-width: 350px;
        margin-bottom: 40px;
    }
    
    .story-stat {
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 16px;
        padding: 20px;
    }
    
    .story-stat-value {
        font-size: 28px;
        font-weight: 900;
        color: var(--accent-green);
        margin-bottom: 4px;
    }
    
    .story-stat-label {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
    }
    
    .story-alert {
        background: rgba(245, 158, 11, 0.15);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 30px;
        max-width: 350px;
    }
    
    .story-alert i {
        color: var(--accent-orange);
        margin-right: 8px;
    }
    
    .story-alert-text {
        color: var(--accent-orange);
        font-size: 14px;
        font-weight: 600;
    }
    
    .story-btn {
        padding: 18px 40px;
        background: var(--gradient-primary);
        border: none;
        border-radius: 30px;
        color: white;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        transition: all 0.3s;
    }
    
    .story-btn:hover {
        transform: scale(1.05);
    }

    /* EVENING RECALL MODAL */
    .evening-modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--dark-card);
        border-top-left-radius: var(--card-radius);
        border-top-right-radius: var(--card-radius);
        padding: 24px;
        z-index: 9000;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
    }
    
    .evening-modal.show {
        transform: translateY(0);
    }
    
    .evening-modal-handle {
        width: 40px;
        height: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 2px;
        margin: 0 auto 20px;
    }
    
    .evening-modal-title {
        font-size: 18px;
        font-weight: 800;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .evening-modal-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 20px;
    }

    /* COUNTER ANIMATION */
    .counter-animate {
        display: inline-block;
    }

    /* TOOLTIPS */
    .tooltip-trigger {
        position: relative;
        cursor: help;
    }
    
    .tooltip-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: var(--text-muted);
        margin-left: 6px;
        transition: all 0.2s;
    }
    
    .tooltip-icon:hover {
        background: var(--accent-blue);
        color: white;
    }
    
    .tooltip-content {
        position: absolute;
        bottom: calc(100% + 10px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--dark-elevated);
        border: 1px solid var(--diamond-border);
        border-radius: 12px;
        padding: 12px 16px;
        width: 250px;
        font-size: 12px;
        line-height: 1.5;
        color: var(--text-secondary);
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    
    .tooltip-trigger:hover .tooltip-content {
        opacity: 1;
        visibility: visible;
    }

    /* NOTIFICATIONS PANEL */
    .notif-panel {
        position: fixed;
        top: 0;
        right: -100%;
        width: 100%;
        max-width: 400px;
        height: 100%;
        background: var(--dark-surface);
        z-index: 8000;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: -10px 0 40px rgba(0,0,0,0.5);
    }
    
    .notif-panel.show {
        right: 0;
    }
    
    .notif-panel-header {
        padding: 20px;
        border-bottom: 1px solid var(--diamond-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .notif-tabs {
        display: flex;
        gap: 8px;
        padding: 16px 20px;
        border-bottom: 1px solid var(--diamond-border);
    }
    
    .notif-tab {
        flex: 1;
        padding: 12px;
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 10px;
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .notif-tab.active {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }
    
    .notif-list {
        padding: 20px;
        overflow-y: auto;
        height: calc(100% - 140px);
    }
    
    .notif-item {
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
    }
    
    .notif-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 7999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    
    .notif-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    /* LOCK SCREEN - Ultra Dark Theme */
    #lockScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: var(--ultra-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    .lock-container {
        text-align: center;
        animation: slideDown 0.6s ease-out;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-50px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .lock-logo {
        width: 100px;
        height: 100px;
        margin: 0 auto 24px;
        background: var(--gradient-primary);
        border-radius: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .lock-logo i {
        font-size: 42px;
        color: white;
    }
    
    .lock-title {
        font-size: 42px;
        font-weight: 900;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
        letter-spacing: 6px;
    }
    
    .lock-subtitle {
        color: var(--text-muted);
        font-size: 13px;
        margin-bottom: 40px;
        letter-spacing: 2px;
        text-transform: uppercase;
    }
    
    .lock-input {
        width: 320px;
        padding: 18px 24px;
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 16px;
        color: var(--text-primary);
        font-size: 16px;
        text-align: center;
        letter-spacing: 4px;
        font-weight: 600;
        transition: all 0.3s;
        font-family: 'Inter', sans-serif;
    }
    
    .lock-input:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.2);
    }
    
    .lock-input::placeholder {
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    .lock-btn {
        width: 320px;
        padding: 18px;
        margin-top: 20px;
        background: var(--gradient-primary);
        border: none;
        border-radius: 16px;
        color: white;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 2px;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        font-family: 'Inter', sans-serif;
    }
    
    .lock-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
    }
    
    .lock-error {
        margin-top: 20px;
        padding: 12px 24px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 10px;
        color: var(--accent-red);
        font-size: 13px;
        display: none;
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
    
    .security-badge {
        position: absolute;
        top: 30px;
        right: 30px;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        color: var(--accent-green);
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* MAIN APP */
    #mainApp {
        display: none;
    }
    
    .user-badge {
        position: fixed;
        top: 16px;
        right: 16px;
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        color: var(--text-secondary);
    }
    
    .user-badge.admin {
        background: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.3);
        color: var(--accent-green);
    }
    
    .user-badge.user {
        background: rgba(59, 130, 246, 0.15);
        border-color: rgba(59, 130, 246, 0.3);
        color: var(--accent-blue);
    }
    
    .logout-btn {
        padding: 5px 10px;
        background: rgba(255,255,255,0.1);
        border: none;
        border-radius: 6px;
        color: inherit;
        font-size: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .logout-btn:hover {
        background: rgba(255,255,255,0.2);
    }

    /* CONTAINER & RESPONSIVE */
    .container {
        max-width: 500px;
        margin: 0 auto;
        padding: 0 16px;
    }
    
    @media (min-width: 1024px) {
        .desktop-sidebar {
            position: fixed !important;
            left: 0;
            top: 0;
            width: 70px;
            height: 100vh;
            background: var(--dark-surface);
            border-right: 1px solid var(--diamond-border);
            z-index: 100;
            padding: 20px 0;
            overflow: hidden;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .desktop-sidebar:hover {
            width: 250px;
        }
        
        .desktop-sidebar:hover .nav-text {
            opacity: 1;
        }
        
        .desktop-sidebar:hover .sidebar-slogan {
            opacity: 1;
        }
        
        .desktop-sidebar:hover .sidebar-btn-text {
            display: inline;
        }
        
        .desktop-nav-item {
            padding: 16px 23px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 600;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .desktop-nav-item i {
            width: 24px;
            min-width: 24px;
            text-align: center;
            font-size: 18px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .nav-text {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .desktop-nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--accent-blue);
        }
        
        .desktop-nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
            border-left-color: var(--accent-blue);
        }
        
        .container {
            margin-left: 70px;
            max-width: calc(100% - 100px);
            padding: 20px 30px;
            transition: margin-left 0.3s;
        }
        
        .desktop-sidebar:hover ~ .container {
            margin-left: 250px;
        }
        
        .bottom-nav {
            display: none !important;
        }
        
        .top-bar-mobile {
            display: none !important;
        }
        
        .top-bar-desktop {
            display: block !important;
            position: fixed;
            top: 0;
            left: 70px;
            right: 0;
            background: var(--dark-surface);
            border-bottom: 1px solid var(--diamond-border);
            z-index: 150;
            padding: 12px 24px;
            backdrop-filter: blur(var(--blur-amount));
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .desktop-sidebar:hover ~ .container .top-bar-desktop,
        .desktop-sidebar:hover + .container .top-bar-desktop {
            left: 250px;
        }

        .bento-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .pin-grid {
            column-count: 3;
        }
    }

    @media (min-width: 1440px) {
        .pin-grid {
            column-count: 4;
        }
    }
    
    /* MOBILE RESPONSIVE - Small screens */
    @media (max-width: 400px) {
        .container {
            padding: 0 10px;
        }
        
        .card {
            padding: 14px;
            border-radius: 16px;
        }
        
        .grid-2 {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .bento-grid {
            grid-template-columns: 1fr;
        }

        .bento-grid .bento-item.bento-large {
            grid-column: span 1;
        }

        .pin-grid {
            column-count: 1;
        }
        
        .top-bar-logo {
            font-size: 16px;
            letter-spacing: 2px;
        }
        
        .profile-card {
            padding: 16px;
        }
        
        .activity-ring-container {
            width: 140px;
            height: 140px;
        }
        
        .activity-ring-container svg {
            width: 140px;
            height: 140px;
        }
        
        .activity-ring-value {
            font-size: 22px;
        }
        
        .btn {
            font-size: 12px;
            padding: 12px 16px;
        }
        
        .nav-tab span {
            font-size: 8px;
        }
        
        .nav-tab i {
            font-size: 16px;
        }
        
        .stat-value {
            font-size: 18px;
        }
        
        .section-title {
            font-size: 14px;
        }
        
        .top-bar-btn {
            padding: 6px 10px;
            font-size: 11px;
        }
        
        .top-bar-icon {
            width: 34px;
            height: 34px;
            font-size: 14px;
        }
        
        .modal-content {
            padding: 20px;
            margin: 20px auto;
        }
        
        .lock-input, .lock-btn {
            width: 280px;
        }
        
        .lock-title {
            font-size: 32px;
        }
    }
    
    /* Medium mobile screens */
    @media (min-width: 401px) and (max-width: 480px) {
        .container {
            padding: 0 14px;
        }
        
        .grid-2 {
            gap: 10px;
        }
        
        .stat-value {
            font-size: 20px;
        }
    }
    
    /* Landscape mobile */
    @media (max-height: 500px) and (orientation: landscape) {
        .main-content {
            padding-top: 60px;
            padding-bottom: 70px;
        }
        
        .activity-ring-container {
            width: 120px;
            height: 120px;
        }
        
        .activity-ring-container svg {
            width: 120px;
            height: 120px;
        }
        
        .profile-card {
            padding: 12px;
        }
        
        .profile-avatar {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
    }
    
    /* iPhone with notch safe areas */
    @supports (padding: max(0px)) {
        .main-content {
            padding-top: max(70px, calc(env(safe-area-inset-top) + 60px));
            padding-bottom: max(90px, calc(env(safe-area-inset-bottom) + 80px));
        }
        
        .top-bar {
            padding-top: max(12px, env(safe-area-inset-top));
        }
        
        .bottom-nav {
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }
    }

    /* TOP BAR */
    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--dark-surface);
        border-bottom: 1px solid var(--diamond-border);
        z-index: 200;
        padding: 12px 20px;
        backdrop-filter: blur(var(--blur-amount));
    }
    
    .top-bar-content {
        max-width: 500px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .top-bar-logo {
        font-size: 22px;
        font-weight: 900;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: 3px;
    }
    
    .top-bar-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .top-bar-btn {
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .top-bar-btn:hover {
        border-color: var(--diamond-border-hover);
        background: rgba(255,255,255,0.08);
    }
    
    .top-bar-icon {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        border: 2px solid var(--accent-green);
        background: var(--dark-elevated);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        color: var(--accent-green);
        transition: all 0.2s;
    }
    
    .top-bar-icon.mode-admin {
        border-color: var(--accent-green) !important;
        color: var(--accent-green) !important;
    }
    
    .top-bar-icon.mode-admin:hover {
        background: var(--accent-green);
        color: white !important;
    }
    
    .top-bar-icon.mode-user {
        border-color: var(--accent-blue) !important;
        color: var(--accent-blue) !important;
    }
    
    .top-bar-icon.mode-user:hover {
        background: var(--accent-blue);
        color: white !important;
    }
    
    .top-bar-icon:hover {
        background: var(--accent-green);
        color: white;
    }
    
    .notif-btn {
        position: relative;
    }
    
    .notif-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 18px;
        height: 18px;
        background: var(--accent-red);
        border-radius: 50%;
        font-size: 10px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    /* CARDS - Premium Style */
    .card {
        background: var(--dark-card);
        backdrop-filter: blur(var(--blur-amount));
        -webkit-backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        border-radius: var(--card-radius);
        padding: 24px;
        margin-bottom: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .card:hover {
        border-color: var(--diamond-border-hover);
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
    }
    
    .card:active {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .card-gradient {
        background: var(--gradient-primary);
        border: none;
        color: white;
    }
    
    .card-glass {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur-amount));
        -webkit-backdrop-filter: blur(var(--blur-amount));
    }

    /* SECTION TITLE */
    .section-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title i {
        color: var(--accent-blue);
    }

    /* INPUTS */
    .input-group {
        margin-bottom: 16px;
    }
    
    .label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .input {
        width: 100%;
        padding: 14px 18px;
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        color: var(--text-primary);
        transition: all 0.2s;
        font-family: 'Inter', sans-serif;
    }
    
    .input:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .input::placeholder {
        color: var(--text-muted);
    }
    
    select.input {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 18px;
        padding-right: 40px;
    }

    /* BUTTONS */
    .btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 14px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-family: 'Inter', sans-serif;
    }
    
    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    .btn-success {
        background: var(--gradient-success);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    
    .btn-secondary {
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        color: var(--text-secondary);
    }
    
    .btn-secondary:hover {
        background: rgba(255,255,255,0.08);
        border-color: var(--diamond-border-hover);
    }

    /* RESULT BOX */
    .result-box {
        background: var(--dark-elevated);
        border: 1px solid var(--diamond-border);
        padding: 20px;
        border-radius: 16px;
        margin-top: 20px;
    }
    
    .result-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 6px;
    }
    
    .result-value {
        font-size: 32px;
        font-weight: 900;
        color: var(--accent-green);
    }
    
    .result-value.negative {
        color: var(--accent-red);
    }

    /* INFO ROWS */
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--diamond-border);
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        color: var(--text-muted);
        font-size: 13px;
    }
    
    .info-value {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 13px;
    }

    /* STATS */
    .stat-card {
        background: var(--dark-card);
        border: 1px solid var(--diamond-border);
        border-radius: 16px;
        padding: 18px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 26px;
        font-weight: 900;
        color: var(--text-primary);
        margin-bottom: 4px;
    }
    
    .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }

    /* COMMANDE ITEMS - Premium Card Style */
    .commande-item {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur-amount));
        -webkit-backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        border-radius: 20px;
        padding: 18px;
        margin-bottom: 12px;
        border-left: 4px solid var(--accent-blue);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .commande-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
        border-color: var(--diamond-border-hover);
    }
    
    .commande-item:active {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .commande-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }
    
    .commande-date {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 600;
    }
    
    .commande-benefice {
        font-size: 18px;
        font-weight: 900;
        color: var(--accent-green);
    }
    
    .commande-benefice.negative {
        color: var(--accent-red);
    }
    
    .commande-details {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.7;
    }

    /* BADGES */
    .badge {
        display: inline-block;
        padding: 4px 10px;
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent-blue);
        border-radius: 6px;
        font-size: 10px;
        font-weight: 700;
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.3;
    }

    /* BOTTOM NAVIGATION */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--dark-surface);
        border-top: 1px solid var(--diamond-border);
        z-index: 100;
        padding: 8px 0;
        padding-bottom: max(8px, env(safe-area-inset-bottom));
        backdrop-filter: blur(var(--blur-amount));
    }
    
    .bottom-nav-content {
        max-width: 500px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 2px;
        padding: 0 4px;
    }
    
    .nav-tab {
        background: none;
        border: none;
        padding: 8px 4px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        border-radius: 10px;
        transition: all 0.2s;
    }
    
    .nav-tab i {
        font-size: 18px;
        color: var(--text-muted);
        transition: color 0.2s;
    }
    
    .nav-tab span {
        font-size: 9px;
        font-weight: 700;
        color: var(--text-muted);
        transition: color 0.2s;
    }
    
    .nav-tab.active {
        background: rgba(59, 130, 246, 0.1);
    }
    
    .nav-tab.active i,
    .nav-tab.active span {
        color: var(--accent-blue);
    }

    /* PAGES */
    .page {
        display: none;
    }
    
    .page.active {
        display: block;
    }
    
    .hidden {
        display: none !important;
    }

    /* MODALS */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 300;
        padding: 20px;
        overflow-y: auto;
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background: var(--dark-card);
        border: 1px solid var(--diamond-border);
        border-radius: var(--card-radius);
        padding: 28px;
        max-width: 420px;
        margin: 50px auto;
        box-shadow: 0 25px 80px rgba(0,0,0,0.5);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .modal-title {
        font-size: 18px;
        font-weight: 800;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .modal-title i {
        color: var(--accent-blue);
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-muted);
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .modal-close:hover {
        color: var(--text-primary);
    }
    
    /* TOGGLE SWITCH */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        transition: 0.4s;
        border-radius: 28px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 3px;
        background-color: var(--text-muted);
        transition: 0.4s;
        border-radius: 50%;
    }
    
    .toggle-switch input:checked + .toggle-slider {
        background-color: var(--accent-green);
        border-color: var(--accent-green);
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
        background-color: white;
    }
    
    /* THEME BUTTONS */
    .theme-btn.active {
        background: var(--gradient-primary) !important;
        color: white !important;
    }
    
    /* MODE ECONOMIE DE DONNEES */
    .mode-economie * {
        animation: none !important;
        transition: none !important;
    }
    
    .mode-economie .activity-ring-progress {
        transition: stroke-dashoffset 0s !important;
    }
    
    .mode-economie .counter-animate {
        animation: none !important;
    }
    
    .mode-economie::after {
        content: '';
    }

    /* PROFILE CARD */
    .profile-card {
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: var(--card-radius);
        padding: 24px;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--gradient-primary);
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: white;
        border: 3px solid var(--diamond-border);
    }
    
    .profile-name {
        font-size: 20px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 4px;
    }
    
    .profile-role {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* SCROLLBAR STYLING */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    ::-webkit-scrollbar-track {
        background: var(--dark-surface);
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--diamond-border);
        border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--diamond-border-hover);
    }

    /* MAIN CONTENT SPACING */
    .main-content {
        margin-top: 70px;
        margin-bottom: 100px;
        padding-top: 10px;
    }
    
    /* DESKTOP TOP BAR - Hidden by default on mobile */
    .top-bar-desktop {
        display: none;
    }

    /* PROFILE DROPDOWN MENU */
    .profile-dropdown-container {
        position: relative;
    }
    
    .profile-dropdown {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        width: 280px;
        background: var(--dark-card);
        backdrop-filter: blur(var(--blur-amount));
        -webkit-backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        border-radius: 20px;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1002;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
    
    .profile-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .profile-dropdown-header {
        text-align: center;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--diamond-border);
        margin-bottom: 16px;
    }
    
    .profile-dropdown-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--gradient-primary);
        margin: 0 auto 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }
    
    .profile-dropdown-name {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }
    
    .profile-dropdown-role {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    
    .profile-dropdown-level {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
    }
    
    .profile-dropdown-section {
        margin-bottom: 16px;
    }
    
    .profile-dropdown-section-title {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    /* THEME SLIDER */
    .theme-slider-container {
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 12px;
        padding: 4px;
        display: flex;
        position: relative;
    }
    
    .theme-slider-option {
        flex: 1;
        padding: 10px 8px;
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.3s;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    
    .theme-slider-option i {
        font-size: 14px;
    }
    
    .theme-slider-option.active {
        color: white;
    }
    
    .theme-slider-indicator {
        position: absolute;
        top: 4px;
        bottom: 4px;
        width: calc(33.33% - 3px);
        background: var(--gradient-primary);
        border-radius: 10px;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .theme-slider-indicator.pos-0 {
        transform: translateX(0);
    }
    
    .theme-slider-indicator.pos-1 {
        transform: translateX(100%);
    }
    
    .theme-slider-indicator.pos-2 {
        transform: translateX(200%);
    }
    
    /* DATA SAVER TOGGLE */
    .data-saver-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 12px;
    }
    
    .data-saver-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
    }
    
    .data-saver-label i {
        color: var(--accent-green);
    }
    
    .profile-dropdown-logout {
        width: 100%;
        padding: 12px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 12px;
        color: var(--accent-red);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .profile-dropdown-logout:hover {
        background: rgba(239, 68, 68, 0.2);
    }
    
    .profile-dropdown-section,
    .profile-dropdown-header,
    .profile-dropdown-logout {
        position: relative;
        z-index: 10;
    }
    
    .theme-slider-container {
        position: relative;
        z-index: 11;
    }
    
    .theme-slider-option {
        cursor: pointer !important;
        pointer-events: auto !important;
        position: relative;
        z-index: 12;
    }
    
    .data-saver-row {
        position: relative;
        z-index: 11;
    }
    
    .toggle-switch {
        position: relative;
        z-index: 12;
        cursor: pointer !important;
        pointer-events: auto !important;
    }
    
    .profile-dropdown-logout {
        cursor: pointer !important;
        pointer-events: auto !important;
    }

    /* DAILY DIGEST NOTIFICATION */
    .daily-digest {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: var(--dark-card);
        backdrop-filter: blur(var(--blur-amount));
        border: 1px solid var(--diamond-border);
        border-radius: 16px;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 500;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 90%;
    }
    
    .daily-digest.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
    }
    
    .daily-digest-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--gradient-success);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
        flex-shrink: 0;
    }
    
    .daily-digest-text {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.4;
    }
    
    .daily-digest-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        font-size: 16px;
    }

    /* COUNTER ANIMATION */
    @keyframes countUp {
        from { opacity: 0.5; }
        to { opacity: 1; }
    }
    
    .counting {
        animation: countUp 0.5s ease-out;
    }

    /* PERIOD SELECTOR */
    .period-selector {
        display: flex;
        gap: 6px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .period-btn {
        padding: 8px 14px;
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .period-btn.active {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }
    
    .period-btn:hover:not(.active) {
        border-color: var(--diamond-border-hover);
    }

    /* OBJECTIVE CALENDAR PICKER */
    .calendar-input {
        position: relative;
    }
    
    .calendar-input input {
        padding-right: 40px;
    }
    
    .calendar-input i {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
    }

    /* OBJECTIVE SLIDER */
    .objective-slider {
        position: relative;
        overflow: hidden;
    }
    
    .objective-slide {
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    
    .objective-slide.active {
        display: block;
    }
    
    .slider-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--diamond-border);
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .slider-dot.active {
        background: var(--accent-blue);
        width: 24px;
        border-radius: 4px;
    }
    
    /* Desktop: Horizontal slider layout */
    @media (min-width: 1024px) {
        .objective-slider-desktop {
            display: flex;
            gap: 20px;
        }
        
        .objective-slider-desktop .objective-slide {
            display: block !important;
            flex: 1;
            min-width: 0;
            border-right: 1px solid var(--diamond-border);
        }
        
        .objective-slider-desktop .objective-slide:last-child {
            border-right: none;
        }
        
        .slider-dots-container {
            display: none !important;
        }
    }
    
    .objective-empty {
        text-align: center;
        padding: 20px;
    }
    
    .objective-empty-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--glass-bg);
        border: 2px dashed var(--diamond-border);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: var(--text-muted);
        font-size: 24px;
    }
    
    .objective-empty-btn {
        padding: 12px 24px;
        background: var(--gradient-primary);
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 700;
        cursor: pointer;
        margin-top: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    /* KPI CLICKABLE */
    .kpi-clickable {
        cursor: pointer;
        position: relative;
    }
    
    .kpi-clickable:hover {
        transform: translateY(-4px) scale(1.02);
    }
    
    .kpi-hint {
        position: absolute;
        top: 10px;
        right: 10px;
        color: var(--text-muted);
        font-size: 12px;
        opacity: 0.5;
        transition: opacity 0.2s;
    }
    
    .kpi-clickable:hover .kpi-hint {
        opacity: 1;
        color: var(--accent-blue);
    }
    
    /* KPI EXPLAIN MODAL */
    .kpi-explain-modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--dark-card);
        border-top-left-radius: 24px;
        border-top-right-radius: 24px;
        padding: 20px;
        z-index: 8000;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.4);
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .kpi-explain-modal.show {
        transform: translateY(0);
    }
    
    .kpi-explain-handle {
        width: 40px;
        height: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 2px;
        margin: 0 auto 16px;
    }
    
    .kpi-explain-title {
        font-size: 18px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .kpi-explain-content {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.7;
    }
    
    .kpi-explain-formula {
        background: var(--glass-bg);
        border: 1px solid var(--diamond-border);
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
        font-family: monospace;
        font-size: 13px;
        color: var(--accent-cyan);
    }

    #fixateurPrixCard strong { color: var(--text-primary); }
    #fixateurPrixCard .input { color: var(--text-primary); background: var(--dark-elevated); border-color: var(--diamond-border); }
    #fixateurPrixCard .input::placeholder { color: var(--text-muted); }
    #fixateurPrixCard .input:disabled { opacity: 0.4; }
    #fixRapport strong { color: var(--text-primary); }
    #fixRapport #fixAnalysePrix div { color: var(--text-secondary); }
    #fixRapport #fixDetailCouts span { color: var(--text-secondary); }
    #fixRapport #fixGrilleContenu span { color: var(--text-secondary); }
    #fixRapport #fixPointMortMsg { color: var(--text-secondary); }
    #fixRapport #fixConseilVeko { color: var(--text-secondary); }
    #fixRapport #fixScenarioAligneMsg { color: var(--text-secondary); }
    #fixRapport #fixScenarioPocheMsg { color: var(--text-secondary); }
    #fixRapport #fixScenarioEquilibreMsg { color: var(--text-secondary); }
    #fixJustifierContenu span { color: var(--text-secondary); }
</style>

</head>
<body>

<!-- DAILY DIGEST NOTIFICATION -->
<div class="daily-digest" id="dailyDigest">
    <div class="daily-digest-icon">
        <i class="fas fa-trophy"></i>
    </div>
    <div class="daily-digest-text" id="dailyDigestText">
        Felicitations ! Vous avez realise 3 ventes de plus qu'hier.
    </div>
    <button class="daily-digest-close" onclick="closeDailyDigest()">
        <i class="fas fa-times"></i>
    </button>
</div>

<!-- MORNING BRIEF STORY -->
<div id="morningStory" class="story-overlay">
    <div class="story-progress-bar">
        <div class="story-progress-fill" id="storyProgressFill"></div>
    </div>
    <div class="story-content">
        <div class="story-greeting" id="storyGreeting">Bonjour</div>
        <div class="story-title" id="storyUserName">Boss</div>
        
        <div class="story-stats">
            <div class="story-stat">
                <div class="story-stat-value" id="storyBenefHier">0 F</div>
                <div class="story-stat-label">Benefice hier</div>
            </div>
            <div class="story-stat">
                <div class="story-stat-value" id="storyVentesHier">0</div>
                <div class="story-stat-label">Ventes hier</div>
            </div>
        </div>
        
        <div class="story-alert" id="storyAlert" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span class="story-alert-text" id="storyAlertText">N'oublie pas de repartir ta pub d'hier !</span>
        </div>
        
        <button class="story-btn" onclick="closeMorningStory()">
            C'est parti !
        </button>
    </div>
</div>

<!-- EVENING RECALL MODAL -->
<div id="eveningRecall" class="evening-modal">
    <div class="evening-modal-handle"></div>
    <div class="evening-modal-title">
        <i class="fas fa-moon" style="color: var(--accent-purple);"></i>
        Bilan du jour
    </div>
    <div class="evening-modal-subtitle">
        Tu as des ventes sans budget pub. Saisis ton budget pub Meta du jour pour finaliser tes benefices.
    </div>
    
    <div class="input-group">
        <label class="label">Devise Meta Ads</label>
        <select id="eveningDeviseMeta" class="input">
            <option value="XAF">FCFA / XAF</option>
            <option value="XOF">XOF (Afrique Ouest)</option>
            <option value="USD">USD (Dollar US)</option>
            <option value="EUR">EUR (Euro)</option>
            <option value="GBP">GBP (Livre Sterling)</option>
            <option value="CAD">CAD (Dollar Canadien)</option>
            <option value="CHF">CHF (Franc Suisse)</option>
            <option value="MAD">MAD (Dirham Marocain)</option>
            <option value="DZD">DZD (Dinar Algerien)</option>
            <option value="TND">TND (Dinar Tunisien)</option>
            <option value="EGP">EGP (Livre Egyptienne)</option>
            <option value="NGN">NGN (Naira Nigerian)</option>
            <option value="GHS">GHS (Cedi Ghaneen)</option>
            <option value="KES">KES (Shilling Kenyan)</option>
            <option value="ZAR">ZAR (Rand Sud-Africain)</option>
            <option value="GNF">GNF (Franc Guineen)</option>
            <option value="CDF">CDF (Franc Congolais)</option>
            <option value="RWF">RWF (Franc Rwandais)</option>
            <option value="BIF">BIF (Franc Burundais)</option>
            <option value="AOA">AOA (Kwanza Angolais)</option>
            <option value="MZN">MZN (Metical Mozambique)</option>
            <option value="TZS">TZS (Shilling Tanzanien)</option>
            <option value="UGX">UGX (Shilling Ougandais)</option>
            <option value="AED">AED (Dirham Emirats)</option>
            <option value="SAR">SAR (Riyal Saoudien)</option>
            <option value="INR">INR (Roupie Indienne)</option>
            <option value="CNY">CNY (Yuan Chinois)</option>
            <option value="JPY">JPY (Yen Japonais)</option>
            <option value="BRL">BRL (Real Bresilien)</option>
            <option value="MXN">MXN (Peso Mexicain)</option>
        </select>
    </div>
    
    <div class="input-group">
        <label class="label">Budget pub du jour</label>
        <input type="number" id="eveningBudgetPub" class="input" placeholder="10000">
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeEveningRecall()">Plus tard</button>
        <button class="btn btn-primary" onclick="submitEveningPub()">Valider</button>
    </div>
</div>

<!-- NOTIFICATIONS PANEL -->
<div class="notif-overlay" id="notifOverlay" onclick="closeNotifPanel()"></div>
<div class="notif-panel" id="notifPanel">
    <div class="notif-panel-header">
        <span style="font-size: 18px; font-weight: 800;">Notifications</span>
        <button onclick="closeNotifPanel()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="notif-tabs">
        <button class="notif-tab active" onclick="switchNotifTab('notifs')" id="tabNotifs">
            <i class="fas fa-bell"></i> Alertes
        </button>
        <button class="notif-tab" onclick="switchNotifTab('conseils')" id="tabConseils">
            <i class="fas fa-lightbulb"></i> Conseils
        </button>
    </div>
    
    <div class="notif-list" id="notifListNotifs">
        <!-- Notifications will be inserted here -->
    </div>
    
    <div class="notif-list" id="notifListConseils" style="display: none;">
        <!-- Conseils VEKO will be inserted here -->
    </div>
</div>

<!-- KPI EXPLAIN MODAL -->
<div class="kpi-explain-modal" id="kpiExplainModal">
    <div class="kpi-explain-handle" onclick="closeKPIExplain()"></div>
    <div class="kpi-explain-title" id="kpiExplainTitle">
        <i class="fas fa-info-circle"></i>
        <span>Titre</span>
    </div>
    <div class="kpi-explain-content" id="kpiExplainContent">
        Contenu explicatif
    </div>
</div>
<div class="notif-overlay" id="kpiExplainOverlay" onclick="closeKPIExplain()"></div>

<!-- AUTH SCREEN -->
<div id="authScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0a0f1e 0%, #1a1a3e 50%, #0d1424 100%); display: flex; align-items: center; justify-content: center; z-index: 99999; padding: 20px;">
    <div style="width: 100%; max-width: 380px; background: rgba(255,255,255,0.06); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.12); border-radius: 28px; padding: 40px 28px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 18px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
            <i class="fas fa-chart-line" style="font-size: 28px; color: white;"></i>
        </div>
        <h1 style="font-size: 28px; font-weight: 900; color: white; margin: 0 0 6px; letter-spacing: 2px;">VEKO</h1>
        <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin: 0 0 32px;">La vision de ce que vous gagnez vraiment</p>

        <div id="authForm">
            <div style="margin-bottom: 16px;">
                <input type="email" id="authEmail" placeholder="Entrez votre adresse email" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; font-size: 14px; outline: none; font-family: 'Inter', sans-serif; transition: border-color 0.3s;" onfocus="this.style.borderColor='#8b5cf6'" onblur="this.style.borderColor='rgba(255,255,255,0.15)'">
            </div>

            <button id="authSubmitBtn" onclick="loginWithEmail()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; gap: 8px; transition: opacity 0.2s;" onmousedown="this.style.opacity='0.85'" onmouseup="this.style.opacity='1'">
                <i class="fas fa-paper-plane"></i> Recevoir mon acc&#232;s
            </button>
        </div>

        <div id="authMessage" style="display: none; margin-top: 20px; padding: 16px; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.2); border-radius: 12px;">
            <i class="fas fa-envelope-open-text" style="color: #8b5cf6; font-size: 20px; display: block; margin-bottom: 8px;"></i>
            <span id="authMessageText" style="font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.6;"></span>
        </div>

        <div id="authError" style="display: none; margin-top: 12px; padding: 14px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 12px;">
            <i class="fas fa-exclamation-circle" style="color: #ef4444; margin-right: 6px;"></i>
            <span id="authErrorText" style="font-size: 12px; color: #ef4444;"></span>
        </div>

        <p style="font-size: 10px; color: rgba(255,255,255,0.25); margin-top: 24px;">Un lien magique sera envoy&#233; &#224; votre email.<br>Aucun mot de passe requis.</p>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp">
    <div id="userBadge" class="user-badge" style="display: none;"></div>

    <!-- DESKTOP SIDEBAR -->
    <div class="desktop-sidebar" style="display: none;">
        <div style="padding: 20px; text-align: center; border-bottom: 1px solid var(--diamond-border); margin-bottom: 20px;">
            <div style="font-size: 24px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 3px;">VEKO</div>
            <div class="sidebar-slogan" style="font-size: 9px; color: var(--text-muted); margin-top: 6px; opacity: 0; transition: opacity 0.3s; line-height: 1.3;">La vision de ce que<br>vous gagnez vraiment</div>
        </div>
        
        <div class="desktop-nav-item active" onclick="showTab('dashboard')" data-tab="dashboard">
            <i class="fas fa-chart-line"></i>
            <span class="nav-text">Dashboard</span>
        </div>
        <div class="desktop-nav-item" onclick="showTab('nouvelle')" data-tab="nouvelle">
            <i class="fas fa-calculator"></i>
            <span class="nav-text">Calcul</span>
        </div>
        <div class="desktop-nav-item" onclick="showTab('projets')" data-tab="projets">
            <i class="fas fa-folder"></i>
            <span class="nav-text">Projets</span>
        </div>
        <div class="desktop-nav-item" onclick="showTab('historique')" data-tab="historique">
            <i class="fas fa-history"></i>
            <span class="nav-text">Historique</span>
        </div>
        <div class="desktop-nav-item" onclick="showTab('simulation')" data-tab="simulation">
            <i class="fas fa-flask"></i>
            <span class="nav-text">Laboratoire</span>
        </div>
        
        <div style="position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 12px;">
            <button onclick="exporterDonnees()" style="width: 100%; padding: 10px; background: var(--accent-blue); color: white; border: none; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-download" style="font-size: 16px; min-width: 24px;"></i> <span class="sidebar-btn-text" style="display: none;">Exporter</span>
            </button>
            <button onclick="importerDonnees()" style="width: 100%; padding: 10px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-upload" style="font-size: 16px; min-width: 24px;"></i> <span class="sidebar-btn-text" style="display: none;">Importer</span>
            </button>
        </div>
    </div>

    <div class="container">
        <!-- TOP BAR MOBILE -->
        <div class="top-bar top-bar-mobile">
            <div class="top-bar-content" style="position: relative;">
                <div style="display: flex; flex-direction: column;">
                    <div class="top-bar-logo">VEKO</div>
                </div>
                
                <div style="position: absolute; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center;">
                    <button class="top-bar-btn" onclick="openModalDevise()" style="margin-bottom: 2px;">
                        <i class="fas fa-coins"></i>
                        <span id="deviseActuelle">FCFA</span>
                    </button>
                    <div style="font-size: 10px; color: var(--text-secondary); text-align: center; max-width: 140px; line-height: 1.3; font-weight: 700;">La vision de ce que vous gagnez vraiment</div>
                </div>
                
                <div class="top-bar-actions">
                    <button class="top-bar-btn notif-btn" onclick="openNotifPanel()">
                        <i class="fas fa-bell"></i>
                        <span class="notif-badge" id="notifBadgeCount" style="display: none;">0</span>
                    </button>
                    
                    <div class="profile-dropdown-container">
                        <div class="top-bar-icon" onclick="toggleProfileDropdown()" id="btnModeProfil">
                            <i class="fas fa-user"></i>
                        </div>
                        
                        <div class="profile-dropdown" id="profileDropdown">
                            <button onclick="closeProfileDropdown()" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">&times;</button>
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="profile-dropdown-name" id="dropdownProfileName">Boss</div>
                                <div class="profile-dropdown-role">Entrepreneur</div>
                                <div class="profile-dropdown-level badge-bronze" id="dropdownProfileLevel">
                                    <i class="fas fa-medal"></i> Bronze
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label class="text-xs text-gray-400 uppercase font-bold mb-3 block" style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 12px; display: block;">Apparence</label>
                                <div style="background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1);">
                                    <button onclick="event.stopPropagation(); changerTheme('light');" id="btn-theme-light" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 12px; font-weight: 500; color: var(--text-muted); background: none; border: none; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-sun" style="display: block; margin-bottom: 4px;"></i> Clair
                                    </button>
                                    <button onclick="event.stopPropagation(); changerTheme('dark');" id="btn-theme-dark" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 12px; font-weight: 500; color: var(--text-primary); background: rgba(255,255,255,0.1); border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s;">
                                        <i class="fas fa-moon" style="display: block; margin-bottom: 4px;"></i> Sombre
                                    </button>
                                    <button onclick="event.stopPropagation(); changerTheme('system');" id="btn-theme-system" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 12px; font-weight: 500; color: var(--text-muted); background: none; border: none; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-desktop" style="display: block; margin-bottom: 4px;"></i> Auto
                                    </button>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(16,185,129,0.2); display: flex; align-items: center; justify-content: center; color: var(--accent-green);">
                                            <i class="fas fa-leaf" style="font-size: 12px;"></i>
                                        </div>
                                        <span style="font-size: 13px; font-weight: 500; color: var(--text-secondary);">Economie de donnees</span>
                                    </div>
                                    <label class="toggle-switch" onclick="event.stopPropagation();">
                                        <input type="checkbox" id="toggle-eco-mode" onchange="event.stopPropagation(); toggleEcoMode(this);">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <button onclick="event.stopPropagation(); deconnexion();" style="width: 100%; background: rgba(239,68,68,0.1); padding: 12px; border-radius: 12px; border: 1px solid rgba(239,68,68,0.2); display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--accent-red); cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Se d&#233;connecter</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TOP BAR DESKTOP -->
        <div class="top-bar-desktop">
            <div style="display: flex; justify-content: space-between; align-items: center; max-width: 100%;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button class="top-bar-btn" onclick="openModalDevise()">
                        <i class="fas fa-coins"></i>
                        <span id="deviseActuelleDesktop">FCFA</span>
                    </button>
                    <div style="font-size: 13px; color: var(--text-secondary); font-weight: 700;">La vision de ce que vous gagnez vraiment</div>
                </div>
                
                <div class="top-bar-actions" style="display: flex; align-items: center; gap: 12px;">
                    <button class="top-bar-btn notif-btn" onclick="openNotifPanel()">
                        <i class="fas fa-bell"></i>
                        <span class="notif-badge" id="notifBadgeCountDesktop" style="display: none;">0</span>
                    </button>
                    
                    <div class="profile-dropdown-container">
                        <div class="top-bar-icon" onclick="toggleProfileDropdown()" id="btnModeProfilDesktop">
                            <i class="fas fa-user"></i>
                        </div>
                        
                        <div class="profile-dropdown" id="profileDropdownDesktop">
                            <button onclick="closeProfileDropdown()" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">&times;</button>
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="profile-dropdown-name" id="dropdownProfileNameDesktop">Boss</div>
                                <div class="profile-dropdown-role">Entrepreneur</div>
                                <div class="profile-dropdown-level badge-bronze" id="dropdownProfileLevelDesktop">
                                    <i class="fas fa-medal"></i> Bronze
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 12px; display: block;">Apparence</label>
                                <div style="background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1);">
                                    <button onclick="changerTheme('light')" id="btn-theme-light-desktop" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 12px; font-weight: 500; color: var(--text-muted); background: none; border: none; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-sun" style="display: block; margin-bottom: 4px;"></i> Clair
                                    </button>
                                    <button onclick="changerTheme('dark')" id="btn-theme-dark-desktop" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 12px; font-weight: 500; color: var(--text-primary); background: rgba(255,255,255,0.1); border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s;">
                                        <i class="fas fa-moon" style="display: block; margin-bottom: 4px;"></i> Sombre
                                    </button>
                                    <button onclick="changerTheme('system')" id="btn-theme-system-desktop" style="flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 12px; font-weight: 500; color: var(--text-muted); background: none; border: none; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-desktop" style="display: block; margin-bottom: 4px;"></i> Auto
                                    </button>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(16,185,129,0.2); display: flex; align-items: center; justify-content: center; color: var(--accent-green);">
                                            <i class="fas fa-leaf" style="font-size: 12px;"></i>
                                        </div>
                                        <span style="font-size: 13px; font-weight: 500; color: var(--text-secondary);">Economie de donnees</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="toggle-eco-mode-desktop" onchange="toggleEcoMode(this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <button onclick="deconnexion()" style="width: 100%; background: rgba(239,68,68,0.1); padding: 12px; border-radius: 12px; border: 1px solid rgba(239,68,68,0.2); display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--accent-red); cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Se d&#233;connecter</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- MAIN CONTENT -->
        <div class="main-content">

    <!-- PAGE: DASHBOARD CEO -->
    <div id="page-dashboard" class="page active">
        
        <!-- Objective Slider Section -->
        <div class="card card-glass" style="padding: 0; overflow: hidden;">
            <div class="objective-slider objective-slider-desktop" id="objectiveSlider">
                <!-- Slide 1: Recap CA/Benefice -->
                <div class="objective-slide active" id="slideRecap">
                    <div style="padding: 20px;">
                        <div class="section-title" style="margin-bottom: 16px;">
                            <i class="fas fa-chart-bar"></i>
                            Rcapitulatif
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Chiffre d'Affaires (CA)</div>
                                <div style="font-size: 24px; font-weight: 900; color: var(--accent-blue);" id="recapCA">0 F</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Benefice Net</div>
                                <div style="font-size: 24px; font-weight: 900; color: var(--accent-green);" id="recapBenefice">0 F</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Activity Ring -->
        <div class="card card-glass">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-bullseye"></i>
                    Objectif du Jour
                </div>
                <div id="objectifActions" style="display: none;">
                    <button onclick="openModalObjectif()" style="background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 8px; padding: 6px 10px; color: var(--text-secondary); font-size: 11px; cursor: pointer; margin-right: 6px;">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="supprimerObjectif()" style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 6px 10px; color: var(--accent-red); font-size: 11px; cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <!-- Objectif Personnel Section -->
            <div id="objectifPersonnelSection" style="margin-bottom: 20px; padding: 16px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 16px;">
                <div id="objectifSlideContent">
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-bullseye" style="font-size: 32px; color: var(--text-muted); margin-bottom: 12px;"></i>
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Aucun objectif defini</p>
                        <button onclick="openModalObjectif()" class="btn btn-primary" style="width: auto; padding: 12px 24px;">
                            <i class="fas fa-plus"></i> Definir un objectif
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="activity-ring-container">
                <svg width="180" height="180" class="activity-ring">
                    <!-- Outer Ring - Benefice (Green) -->
                    <circle class="activity-ring-bg" cx="90" cy="90" r="75" stroke-width="12"></circle>
                    <circle class="activity-ring-progress ring-benefice" id="ringBenefice" cx="90" cy="90" r="75" stroke-width="12" 
                            stroke-dasharray="471.24" stroke-dashoffset="471.24" transform="rotate(-90 90 90)"></circle>
                    
                    <!-- Middle Ring - CA (Blue) -->
                    <circle class="activity-ring-bg" cx="90" cy="90" r="60" stroke-width="12"></circle>
                    <circle class="activity-ring-progress ring-ca" id="ringCA" cx="90" cy="90" r="60" stroke-width="12" 
                            stroke-dasharray="376.99" stroke-dashoffset="376.99" transform="rotate(-90 90 90)"></circle>
                    
                    <!-- Inner Ring - Ventes (Purple) -->
                    <circle class="activity-ring-bg" cx="90" cy="90" r="45" stroke-width="12"></circle>
                    <circle class="activity-ring-progress ring-ventes" id="ringVentes" cx="90" cy="90" r="45" stroke-width="12" 
                            stroke-dasharray="282.74" stroke-dashoffset="282.74" transform="rotate(-90 90 90)"></circle>
                </svg>
                
                <div class="activity-ring-center">
                    <div class="activity-ring-value counter-animate" id="ringCenterValue">0%</div>
                    <div class="activity-ring-label">Objectif</div>
                </div>
            </div>
            
            <div class="activity-legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--accent-green);"></div>
                    <span>Benefice</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--accent-blue);"></div>
                    <span>CA</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--accent-purple);"></div>
                    <span>Ventes</span>
                </div>
            </div>
        </div>
        
        <!-- Period Selector -->
        <div class="period-selector" id="periodSelector">
            <button class="period-btn" onclick="changerPeriodeKPI('jour')">Jour</button>
            <button class="period-btn" onclick="changerPeriodeKPI('semaine')">Semaine</button>
            <button class="period-btn active" onclick="changerPeriodeKPI('mois')">Mois</button>
            <button class="period-btn" onclick="changerPeriodeKPI('personnalise')">Personnalise</button>
        </div>
        
        <!-- Date Range (hidden by default) -->
        <div id="dateRangeSelector" style="display: none; margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <div class="calendar-input" style="flex: 1; min-width: 140px;">
                    <input type="date" id="kpiDateDebut" class="input" onchange="updateKPIsByDateRange()">
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="calendar-input" style="flex: 1; min-width: 140px;">
                    <input type="date" id="kpiDateFin" class="input" onchange="updateKPIsByDateRange()">
                    <i class="fas fa-calendar"></i>
                </div>
            </div>
        </div>
        
        <!-- KPIs Bento Grid -->
        <div class="bento-grid" style="margin-bottom: 16px;">
            <div class="bento-item kpi-clickable" onclick="showKPIExplain('ca')">
                <div class="bento-item-icon" style="background: rgba(59, 130, 246, 0.15);">
                    <i class="fas fa-chart-line" style="color: var(--accent-blue);"></i>
                </div>
                <div class="bento-item-title" id="kpiCaLabel">Chiffre d'Affaires</div>
                <div class="bento-item-value counter-animate" id="kpiCaMois" style="color: var(--accent-blue);">0 F</div>
                <div class="kpi-hint"><i class="fas fa-info-circle"></i></div>
            </div>
            <div class="bento-item kpi-clickable" onclick="showKPIExplain('benefice')">
                <div class="bento-item-icon" style="background: rgba(16, 185, 129, 0.15);">
                    <i class="fas fa-coins" style="color: var(--accent-green);"></i>
                </div>
                <div class="bento-item-title" id="kpiBeneficeLabel">Benefice Net</div>
                <div class="bento-item-value counter-animate" id="kpiBeneficeMois" style="color: var(--accent-green);">0 F</div>
                <div class="kpi-hint"><i class="fas fa-info-circle"></i></div>
            </div>
            <div class="bento-item kpi-clickable" onclick="showKPIExplain('marge')">
                <div class="bento-item-icon" style="background: rgba(245, 158, 11, 0.15);">
                    <i class="fas fa-percentage" style="color: var(--accent-orange);"></i>
                </div>
                <div class="bento-item-title">Marge Moyenne</div>
                <div class="bento-item-value counter-animate" id="kpiMargeMoyenne" style="color: var(--accent-orange);">0%</div>
                <div class="kpi-hint"><i class="fas fa-info-circle"></i></div>
            </div>
            <div class="bento-item kpi-clickable" onclick="showKPIExplain('ventes')">
                <div class="bento-item-icon" style="background: rgba(139, 92, 246, 0.15);">
                    <i class="fas fa-shopping-bag" style="color: var(--accent-purple);"></i>
                </div>
                <div class="bento-item-title" id="kpiVentesLabel">Ventes</div>
                <div class="bento-item-value counter-animate" id="kpiNbVentes" style="color: var(--accent-purple);">0</div>
                <div class="kpi-hint"><i class="fas fa-info-circle"></i></div>
            </div>
        </div>
        
        <!-- Objectif du Mois -->
        <div class="card" id="cardObjectif" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    <i class="fas fa-bullseye" style="color: var(--accent-orange); margin-right: 8px;"></i>
                    Objectif Mensuel
                </h3>
                <button onclick="definirObjectif()" style="padding: 6px 12px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-edit"></i> Modifier
                </button>
            </div>
            <div id="objectifDetails"></div>
        </div>
        
        <!-- Produit Top -->
        <div class="card">
            <h3 style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">
                <i class="fas fa-trophy" style="color: var(--accent-orange); margin-right: 8px;"></i>
                Produit le Plus Rentable
            </h3>
            <div id="produitTopPerf">
                <div class="skeleton skeleton-card"></div>
            </div>
        </div>
        
        <!-- Taux de Retour -->
        <div class="card">
            <h3 style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">
                <i class="fas fa-box" style="color: var(--accent-purple); margin-right: 8px;"></i>
                Taux de Retour
            </h3>
            <div id="tauxRetour">
                <div class="skeleton skeleton-text" style="width: 80%;"></div>
            </div>
        </div>
        
        <!-- Graphique Evolution -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    <i class="fas fa-chart-line" style="color: var(--accent-blue); margin-right: 8px;"></i>
                    Evolution
                </h3>
                <div style="display: flex; gap: 8px;">
                    <select id="chartPeriodSelect" class="input" style="padding: 8px 12px; font-size: 11px; width: auto;" onchange="chargerGraphiqueEvolution()">
                        <option value="7">7 jours</option>
                        <option value="14">14 jours</option>
                        <option value="30">30 jours</option>
                    </select>
                    <select id="chartProduitSelect" class="input" style="padding: 8px 12px; font-size: 11px; width: auto;" onchange="chargerGraphiqueEvolution()">
                        <option value="">Tous</option>
                    </select>
                </div>
            </div>
            <div id="chartStatsContainer"></div>
            <canvas id="chartEvolution7j" style="max-height: 220px;"></canvas>
        </div>
        
        <!-- Repartition CA -->
        <div class="card" id="cardRepartitionCA" style="display: none;">
            <h3 style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
                <i class="fas fa-chart-pie" style="color: var(--accent-green); margin-right: 8px;"></i>
                Repartition CA par Projet
            </h3>
            <canvas id="chartRepartitionCA" style="max-height: 220px;"></canvas>
        </div>
        
        <!-- Produits en Difficulte -->
        <div class="card" id="cardProduitsRisque" style="display: none;">
            <h3 style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">
                <i class="fas fa-exclamation-triangle" style="color: var(--accent-red); margin-right: 8px;"></i>
                Produits en Difficulte
            </h3>
            <div id="produitsRisque"></div>
        </div>
        
        <!-- Quick Actions -->
        <div class="grid-2">
            <button onclick="showTab('nouvelle')" class="btn btn-primary" style="padding: 14px;">
                <i class="fas fa-plus-circle"></i> Nouvelle Vente
            </button>
            <button onclick="showTab('historique')" class="btn btn-success" style="padding: 14px;">
                <i class="fas fa-history"></i> Historique
            </button>
        </div>
    </div>

    <!-- PAGE: NOUVELLE VENTE -->
    <div id="page-nouvelle" class="page">
        
        <!-- ETAPE 1: Calcul Fournisseur -->
        <div class="card">
            <div class="section-title">
                <i class="fas fa-truck"></i>
                <span id="etape1Title">ETAPE 1 : Calcul Fournisseur</span>
            </div>

            <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                <button type="button" id="btnFournisseur" class="btn btn-primary" style="flex: 1; padding: 12px; font-size: 13px;" onclick="changerTypeCalcul('fournisseur')">
                    <i class="fas fa-truck"></i> Fournisseur
                </button>
                <button type="button" id="btnProduction" class="btn btn-secondary" style="flex: 1; padding: 12px; font-size: 13px;" onclick="changerTypeCalcul('production')">
                    <i class="fas fa-industry"></i> Production
                </button>
            </div>

            <div class="input-group">
                <label class="label">Selectionner un projet existant (optionnel)</label>
                <select id="selectProjet" class="input" onchange="chargerProjetDansCalcul()">
                    <option value="">-- Saisie manuelle --</option>
                </select>
            </div>

            <!-- Formulaire Fournisseur -->
            <div id="formFournisseur">
                <div class="input-group">
                    <label class="label">Prix d'achat unitaire (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="prixAchatUnit" class="input" placeholder="2500" oninput="calculerRevient()">
                </div>

                <div class="input-group">
                    <label class="label">Nombre d'articles achetes</label>
                    <input type="number" id="nbArticlesAchetes" class="input" placeholder="10" oninput="calculerRevient()">
                </div>

                <div class="input-group">
                    <label class="label">Frais de livraison / Transport (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="fraisLivraisonFournisseur" class="input" placeholder="5000" oninput="calculerRevient()">
                </div>
            </div>

            <!-- Formulaire Production -->
            <div id="formProduction" class="hidden">
                <div class="input-group">
                    <label class="label">Cout matieres premieres (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="coutMatieres" class="input" placeholder="15000" oninput="calculerRevient()">
                </div>

                <div class="input-group">
                    <label class="label">Cout main d'oeuvre (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="coutMainOeuvre" class="input" placeholder="5000" oninput="calculerRevient()">
                </div>

                <div class="input-group">
                    <label class="label">Autres frais de production (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="autresFrais" class="input" placeholder="2000" value="0" oninput="calculerRevient()">
                </div>

                <div class="input-group">
                    <label class="label">Nombre de produits fabriques</label>
                    <input type="number" id="nbProduitsProduction" class="input" placeholder="10" oninput="calculerRevient()">
                </div>
            </div>

            <div id="resultRevient" class="hidden">
                <div class="info-row">
                    <span class="info-label">Cout total</span>
                    <span class="info-value"><span id="coutTotalAchat">0</span> <span class="devise-label">F</span></span>
                </div>
                <div class="result-box">
                    <div class="result-label">Prix de revient par article</div>
                    <div class="result-value"><span id="prixRevientUnit">0</span> <span class="devise-label">F</span></div>
                </div>
            </div>
        </div>

        <!-- ETAPE 2: Calcul Commande -->
        <div class="card">
            <div class="section-title">
                <i class="fas fa-shopping-cart"></i>
                ETAPE 2 : Calcul par Commande
            </div>

            <div class="input-group">
                <label class="label">Nom du client (optionnel)</label>
                <input type="text" id="nomClient" class="input" placeholder="Ex: Jean Dupont">
            </div>

            <div class="input-group">
                <label class="label">Telephone du client (optionnel)</label>
                <input type="tel" id="telClient" class="input" placeholder="Ex: 6XX XXX XXX">
            </div>

            <div class="input-group">
                <label class="label">Nombre de pieces commandees</label>
                <input type="number" id="nbPiecesCommande" class="input" placeholder="2" oninput="calculerCommande()">
            </div>

            <div class="input-group">
                <label class="label">Prix de vente unitaire (<span class="devise-label">FCFA</span>)</label>
                <input type="number" id="prixVenteUnit" class="input" placeholder="15000" oninput="calculerCommande()">
            </div>

            <div class="input-group">
                <label class="label">Budget pub depense aujourd'hui (<span class="devise-label">FCFA</span>)</label>
                <select id="budgetPubOption" class="input" onchange="toggleBudgetPubInput()" style="margin-bottom: 8px;">
                    <option value="montant">Entrer un montant</option>
                    <option value="aucun">Pas de frais publicitaires</option>
                </select>
                <input type="number" id="budgetPub" class="input" placeholder="10000" value="0" oninput="calculerCommande()">
            </div>

            <div class="input-group">
                <label class="label">Frais de livraison au client (<span class="devise-label">FCFA</span>)</label>
                <input type="number" id="fraisLivraisonClient" class="input" placeholder="2000" value="0" oninput="calculerCommande()">
            </div>

            <div class="input-group">
                <label class="label">Commission gestionnaire de stock (<span class="devise-label">FCFA</span>/article)</label>
                <select id="commissionOption" class="input" onchange="toggleCommissionInput()" style="margin-bottom: 8px;">
                    <option value="montant">Entrer un montant</option>
                    <option value="moi-meme">Moi-meme (pas de gestionnaire)</option>
                </select>
                <input type="number" id="commissionStock" class="input" placeholder="1000" value="1000" oninput="calculerCommande()">
            </div>

            <div id="resultCommande" class="hidden">
                <div class="info-row">
                    <span class="info-label">Chiffre d'affaires</span>
                    <span class="info-value" id="ca">0 F</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Cout d'acquisition total</span>
                    <span class="info-value" id="coutAcquisition">0 F</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Commission totale</span>
                    <span class="info-value" id="commissionTotale">0 F</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Budget pub</span>
                    <span class="info-value" id="pubTotal">0 F</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Livraison client</span>
                    <span class="info-value" id="livraisonTotal">0 F</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total depenses</span>
                    <span class="info-value" id="depensesTotales">0 F</span>
                </div>

                <div class="result-box" style="margin-top: 16px;">
                    <div class="result-label">Benefice Net</div>
                    <div class="result-value" id="beneficeNet">0 F</div>
                </div>

                <button class="btn btn-success" onclick="enregistrerVente()" style="margin-top: 20px;">
                    <i class="fas fa-save"></i>
                    Enregistrer cette vente
                </button>
            </div>
        </div>
    </div>

    <!-- PAGE: SIMULATION -->
    <div id="page-simulation" class="page">
        
        <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border: none; color: white; text-align: center; padding: 24px;">
            <i class="fas fa-flask" style="font-size: 32px; margin-bottom: 12px;"></i>
            <h2 style="font-size: 18px; font-weight: 900; margin: 0;">Laboratoire</h2>
            <p style="font-size: 12px; opacity: 0.9; margin-top: 8px;">Vos outils intelligents pour optimiser vos prix</p>
        </div>

        <!-- FIXATEUR DE PRIX -->
        <div class="card" id="fixateurPrixCard">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-crosshairs" style="font-size: 20px; color: white;"></i>
                </div>
                <div>
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">OUTIL</div>
                    <div style="font-size: 17px; font-weight: 900; color: var(--text-primary);">Fixateur de Prix</div>
                </div>
            </div>

            <div id="fixStepIndicator" style="display: flex; align-items: center; gap: 0; margin-bottom: 24px;">
                <div id="fixStep1Dot" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #ec4899); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 800; color: white;">1</div>
                <div style="flex: 1; height: 3px; background: var(--glass-bg); border-radius: 2px; margin: 0 4px;">
                    <div id="fixProgressBar1" style="width: 0%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 2px; transition: width 0.4s;"></div>
                </div>
                <div id="fixStep2Dot" style="width: 32px; height: 32px; border-radius: 50%; background: var(--glass-bg); border: 2px solid var(--diamond-border); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 800; color: var(--text-muted);">2</div>
                <div style="flex: 1; height: 3px; background: var(--glass-bg); border-radius: 2px; margin: 0 4px;">
                    <div id="fixProgressBar2" style="width: 0%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 2px; transition: width 0.4s;"></div>
                </div>
                <div id="fixStep3Dot" style="width: 32px; height: 32px; border-radius: 50%; background: var(--glass-bg); border: 2px solid var(--diamond-border); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 800; color: var(--text-muted);">3</div>
            </div>

            <!-- ETAPE 1 : La Vision -->
            <div id="fixEtape1">
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 800; color: var(--text-primary); margin-bottom: 4px;">
                        <i class="fas fa-eye" style="color: #8b5cf6; margin-right: 6px;"></i>&#201;tape 1 : La Vision
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">D&#233;finissez votre produit et votre ambition de prix.</div>
                </div>

                <div class="input-group">
                    <label class="label">Nom du produit</label>
                    <input type="text" id="fixNomProduit" class="input" placeholder="Ex: Sac &#224; main cuir">
                </div>

                <div class="input-group">
                    <label class="label">&#192; combien souhaitez-vous le vendre ? (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="fixPrixObjectif" class="input" placeholder="25000">
                </div>

                <div class="input-group">
                    <label class="label">&#192; combien les concurrents le vendent-ils ? (<span class="devise-label">FCFA</span>)</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="fixPrixConcurrence" class="input" placeholder="Laisser vide si inconnu" style="flex: 1;" oninput="fixToggleConcurrence()">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap; font-size: 12px; color: var(--text-muted);">
                            <input type="checkbox" id="fixConcurrenceInconnu" onchange="fixToggleInconnu()" style="accent-color: #8b5cf6; width: 16px; height: 16px;">
                            Je ne sais pas
                        </label>
                    </div>
                </div>

                <button onclick="fixAllerEtape2()" class="btn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; border: none; font-weight: 700; font-size: 14px; border-radius: 12px; cursor: pointer; margin-top: 8px;">
                    Continuer <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
                </button>
            </div>

            <!-- ETAPE 2 : La Source d'Acquisition -->
            <div id="fixEtape2" class="hidden">
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 800; color: var(--text-primary); margin-bottom: 4px;">
                        <i class="fas fa-boxes" style="color: #8b5cf6; margin-right: 6px;"></i>&#201;tape 2 : La Source d&#8217;Acquisition
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">Comment vous procurez-vous <strong id="fixNomProduitEtape2"></strong> ?</div>
                </div>

                <!-- 3 Choix Radio -->
                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <label onclick="fixChoisirSource('local')" id="fixRadioLocal" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--glass-bg); border: 2px solid var(--diamond-border); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--diamond-border); display: flex; align-items: center; justify-content: center; flex-shrink: 0;" id="fixDotLocal">
                            <div style="width: 10px; height: 10px; border-radius: 50; display: none;" id="fixDotLocalInner"></div>
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);"><i class="fas fa-store" style="color: var(--accent-blue); margin-right: 6px;"></i>Achat Local</div>
                            <div style="font-size: 10px; color: var(--text-muted);">Revendeur local, march&#233;, boutique</div>
                        </div>
                    </label>

                    <label onclick="fixChoisirSource('import')" id="fixRadioImport" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--glass-bg); border: 2px solid var(--diamond-border); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--diamond-border); display: flex; align-items: center; justify-content: center; flex-shrink: 0;" id="fixDotImport">
                            <div style="width: 10px; height: 10px; border-radius: 50%; display: none;" id="fixDotImportInner"></div>
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);"><i class="fas fa-plane" style="color: var(--accent-orange); margin-right: 6px;"></i>Importation</div>
                            <div style="font-size: 10px; color: var(--text-muted);">International, Chine, Turquie, Dubai...</div>
                        </div>
                    </label>

                    <label onclick="fixChoisirSource('production')" id="fixRadioProduction" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--glass-bg); border: 2px solid var(--diamond-border); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--diamond-border); display: flex; align-items: center; justify-content: center; flex-shrink: 0;" id="fixDotProduction">
                            <div style="width: 10px; height: 10px; border-radius: 50%; display: none;" id="fixDotProductionInner"></div>
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);"><i class="fas fa-hammer" style="color: var(--accent-purple); margin-right: 6px;"></i>Production / Fabrication</div>
                            <div style="font-size: 10px; color: var(--text-muted);">Fait main, atelier, confection</div>
                        </div>
                    </label>
                </div>

                <!-- ZONE A : Achat Local -->
                <div id="fixZoneLocal" class="hidden">
                    <div class="input-group">
                        <label class="label">Prix d'achat unitaire (<span class="devise-label">FCFA</span>)</label>
                        <input type="number" id="fixLocalPrixAchat" class="input" placeholder="2500">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="label" style="margin-bottom: 10px; display: block;">Frais de transport / r&#233;cup&#233;ration pour ce stock ?</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label onclick="fixChoisirTransport('gratuit')" id="fixRadioTransportGratuit" style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--glass-bg); border: 2px solid var(--diamond-border); border-radius: 10px; cursor: pointer; transition: all 0.3s;">
                                <div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--diamond-border); flex-shrink: 0;" id="fixDotTransGratuit"></div>
                                <span style="font-size: 12px; color: var(--text-primary);">0F (Sur place / Inclus)</span>
                            </label>
                            <label onclick="fixChoisirTransport('paye')" id="fixRadioTransportPaye" style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--glass-bg); border: 2px solid var(--diamond-border); border-radius: 10px; cursor: pointer; transition: all 0.3s;">
                                <div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--diamond-border); flex-shrink: 0;" id="fixDotTransPaye"></div>
                                <span style="font-size: 12px; color: var(--text-primary);">J&#8217;ai pay&#233; la livraison / le taxi</span>
                            </label>
                        </div>
                    </div>

                    <div id="fixZoneTransportPaye" class="hidden">
                        <div class="input-group">
                            <label class="label">Montant total pay&#233; (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixLocalTransportMontant" class="input" placeholder="3000">
                        </div>
                        <div class="input-group">
                            <label class="label">Combien d&#8217;articles transport&#233;s ?</label>
                            <input type="number" id="fixLocalTransportNb" class="input" placeholder="10">
                        </div>
                    </div>
                </div>

                <!-- ZONE B : Importation -->
                <div id="fixZoneImport" class="hidden">
                    <div style="margin-bottom: 16px;">
                        <label class="label" style="margin-bottom: 10px; display: block;">Connaissez-vous le co&#251;t global ou le d&#233;tail ?</label>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" id="fixBtnImportGlobal" class="btn btn-secondary" style="flex: 1; padding: 12px; font-size: 12px;" onclick="fixChoisirImportMode('global')">
                                <i class="fas fa-box"></i> Co&#251;t Global
                            </button>
                            <button type="button" id="fixBtnImportDetail" class="btn btn-secondary" style="flex: 1; padding: 12px; font-size: 12px;" onclick="fixChoisirImportMode('detail')">
                                <i class="fas fa-list"></i> D&#233;tail
                            </button>
                        </div>
                    </div>

                    <div id="fixZoneImportGlobal" class="hidden">
                        <div class="input-group">
                            <label class="label">Co&#251;t total du colis (Achat + Transport + Douane) (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixImportCoutGlobal" class="input" placeholder="150000">
                        </div>
                        <div class="input-group">
                            <label class="label">Nombre d'articles dans le colis</label>
                            <input type="number" id="fixImportNbGlobal" class="input" placeholder="20">
                        </div>
                    </div>

                    <div id="fixZoneImportDetail" class="hidden">
                        <div class="input-group">
                            <label class="label">Prix d'achat unitaire (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixImportPrixUnit" class="input" placeholder="3000">
                        </div>
                        <div class="input-group">
                            <label class="label">Frais logistiques globaux (transport + douane) (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixImportFraisLog" class="input" placeholder="50000">
                        </div>
                        <div class="input-group">
                            <label class="label">Nombre d'articles</label>
                            <input type="number" id="fixImportNbDetail" class="input" placeholder="20">
                        </div>
                    </div>
                </div>

                <!-- ZONE C : Production -->
                <div id="fixZoneProduction" class="hidden">
                    <div class="input-group">
                        <label class="label">Co&#251;t des mat&#233;riaux (<span class="devise-label">FCFA</span>)</label>
                        <input type="number" id="fixProdCoutMateriaux" class="input" placeholder="8000">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="fixProdFacturerTemps" onchange="fixToggleTemps()" style="accent-color: #8b5cf6; width: 18px; height: 18px;">
                            <span style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Facturer mon temps ?</span>
                        </label>
                    </div>

                    <div id="fixZoneTemps" class="hidden">
                        <div class="input-group">
                            <label class="label">Temps pass&#233; (heures)</label>
                            <input type="number" id="fixProdHeures" class="input" placeholder="3" step="0.5">
                        </div>
                        <div class="input-group">
                            <label class="label">Prix de votre heure (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixProdPrixHeure" class="input" placeholder="2000">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button onclick="fixRetourEtape1()" class="btn btn-secondary" style="padding: 14px 20px; font-size: 13px;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button onclick="fixAllerEtape3()" class="btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; border: none; font-weight: 700; font-size: 14px; border-radius: 12px; cursor: pointer;">
                        Continuer <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
                    </button>
                </div>
            </div>

            <!-- ETAPE 3 : La Realite des Charges -->
            <div id="fixEtape3" class="hidden">
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 800; color: var(--text-primary); margin-bottom: 4px;">
                        <i class="fas fa-calculator" style="color: #8b5cf6; margin-right: 6px;"></i>&#201;tape 3 : La R&#233;alit&#233; des Charges
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">Comment vendez-vous <strong id="fixNomProduitEtape3"></strong> ?</div>
                </div>

                <!-- Canal de Vente (Multi-choix) -->
                <div style="margin-bottom: 20px;">
                    <label class="label" style="margin-bottom: 10px; display: block;">Canal de vente (plusieurs choix possibles)</label>

                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--glass-bg); border: 2px solid var(--diamond-border); border-radius: 10px; cursor: pointer; transition: all 0.3s;" id="fixCanalBoutiqueLabel">
                            <input type="checkbox" id="fixCanalBoutique" onchange="fixToggleCanal()" style="accent-color: #8b5cf6; width: 18px; height: 18px;">
                            <div>
                                <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);"><i class="fas fa-store-alt" style="color: var(--accent-blue); margin-right: 6px;"></i>Boutique Physique</div>
                                <div style="font-size: 10px; color: var(--text-muted);">Magasin, stand, march&#233;</div>
                            </div>
                        </label>

                        <label style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--glass-bg); border: 2px solid var(--diamond-border); border-radius: 10px; cursor: pointer; transition: all 0.3s;" id="fixCanalEnLigneLabel">
                            <input type="checkbox" id="fixCanalEnLigne" onchange="fixToggleCanal()" style="accent-color: #8b5cf6; width: 18px; height: 18px;">
                            <div>
                                <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);"><i class="fas fa-globe" style="color: var(--accent-orange); margin-right: 6px;"></i>Vente en Ligne</div>
                                <div style="font-size: 10px; color: var(--text-muted);">Facebook, TikTok, Instagram, Site web</div>
                            </div>
                        </label>

                        <button type="button" onclick="fixCocherLesDeux()" class="btn btn-secondary" style="padding: 10px; font-size: 12px; font-weight: 700; border-style: dashed;">
                            <i class="fas fa-check-double" style="margin-right: 6px; color: #8b5cf6;"></i>Les deux
                        </button>
                    </div>
                </div>

                <!-- SECTION BOUTIQUE PHYSIQUE -->
                <div id="fixZoneBoutique" class="hidden">
                    <div style="padding: 16px; background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.15); border-radius: 14px; margin-bottom: 16px;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--accent-blue); margin-bottom: 14px;">
                            <i class="fas fa-store-alt" style="margin-right: 6px;"></i>Loyer & Charges Fixes
                        </div>

                        <div class="input-group">
                            <label class="label">Montant total mensuel (Loyer + &#201;lectricit&#233; + Eau) (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixBoutiqueLoyerMensuel" class="input" placeholder="50000">
                        </div>

                        <div style="margin-bottom: 14px;">
                            <label class="label" style="margin-bottom: 10px; display: block;">Ce produit est-il le seul vendu dans votre boutique ?</label>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" id="fixBtnProduitSeulOui" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirProduitSeul('oui')">
                                    Oui, le seul
                                </button>
                                <button type="button" id="fixBtnProduitSeulNon" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirProduitSeul('non')">
                                    Non, d'autres aussi
                                </button>
                            </div>
                        </div>

                        <!-- Si OUI : volume de vente -->
                        <div id="fixZoneProduitSeul" class="hidden">
                            <div class="input-group">
                                <label class="label">Combien comptez-vous en vendre ce mois-ci ?</label>
                                <input type="number" id="fixBoutiqueVolumeSeul" class="input" placeholder="30">
                            </div>
                        </div>

                        <!-- Si NON : combien d'autres produits -->
                        <div id="fixZoneProduitMultiple" class="hidden">
                            <div style="margin-bottom: 14px;">
                                <label class="label" style="margin-bottom: 10px; display: block;">Combien d'autres types de produits vendez-vous ?</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;" id="fixPaliersAutresProduits">
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 14px; font-size: 11px;" onclick="fixChoisirPalier(10)">~10</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 14px; font-size: 11px;" onclick="fixChoisirPalier(20)">~20</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 14px; font-size: 11px;" onclick="fixChoisirPalier(50)">~50</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 14px; font-size: 11px;" onclick="fixChoisirPalier(100)">100+</button>
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 14px; font-size: 11px;" onclick="fixChoisirPalier(-1)">Je ne sais pas</button>
                                </div>
                            </div>

                            <!-- Si "Je ne sais pas" : choisir % du loyer -->
                            <div id="fixZonePourcentLoyer" class="hidden">
                                <label class="label" style="margin-bottom: 10px; display: block;">Quel pourcentage du loyer ce produit doit-il payer ?</label>
                                <div style="display: flex; gap: 8px;" id="fixPourcentBtns">
                                    <button type="button" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirPourcent(5)">5%</button>
                                    <button type="button" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirPourcent(10)">10%</button>
                                    <button type="button" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirPourcent(20)">20%</button>
                                    <button type="button" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirPourcent(50)">50%</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION VENTE EN LIGNE -->
                <div id="fixZoneEnLigne" class="hidden">
                    <div style="padding: 16px; background: rgba(245,158,11,0.06); border: 1px solid rgba(245,158,11,0.15); border-radius: 14px; margin-bottom: 16px;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--accent-orange); margin-bottom: 14px;">
                            <i class="fas fa-globe" style="margin-right: 6px;"></i>Budget Pub & Volume
                        </div>

                        <div style="margin-bottom: 14px;">
                            <label class="label" style="margin-bottom: 10px; display: block;">D&#233;pensez-vous de l&#8217;argent en publicit&#233; (Facebook/Google) ?</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                                <button type="button" id="fixBtnPubOui" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirPub('oui')">
                                    <i class="fas fa-ad"></i> Oui, je fais de la pub
                                </button>
                                <button type="button" id="fixBtnPubNon" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 12px;" onclick="fixChoisirPub('non')">
                                    <i class="fas fa-seedling"></i> Non, organique
                                </button>
                            </div>
                        </div>

                        <div id="fixZonePubOui" class="hidden">
                            <div style="margin-bottom: 14px;">
                                <label class="label" style="margin-bottom: 10px; display: block;">Budget publicit&#233; pr&#233;vu pour ce stock (<span class="devise-label">FCFA</span>)</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="fixEnLigneBudgetPub" class="input" placeholder="15000" style="flex: 1;" oninput="fixTogglePubInput()">
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap; font-size: 11px; color: var(--text-muted);">
                                        <input type="checkbox" id="fixPubInconnu" onchange="fixTogglePubInconnu()" style="accent-color: #8b5cf6; width: 16px; height: 16px;">
                                        Je ne sais pas trop
                                    </label>
                                </div>
                            </div>

                            <div id="fixZonePubJour" class="hidden">
                                <div class="input-group">
                                    <label class="label">Combien pouvez-vous payer en moyenne par jour en pub ? (<span class="devise-label">FCFA</span>)</label>
                                    <input type="number" id="fixEnLignePubJour" class="input" placeholder="2000">
                                </div>
                            </div>
                        </div>

                        <div id="fixZonePubNon" class="hidden" style="padding: 12px; background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.15); border-radius: 10px; margin-bottom: 14px;">
                            <div style="font-size: 11px; color: var(--accent-green); font-weight: 600;"><i class="fas fa-check-circle" style="margin-right: 6px;"></i>Bravo ! Vous misez sur la cr&#233;ation de contenu organique.</div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Votre co&#251;t d&#8217;acquisition est de 0F.</div>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label class="label" style="margin-bottom: 10px; display: block;">Combien de produits pensez-vous vendre ce mois-ci ?</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" id="fixEnLigneVolume" class="input" placeholder="20" style="flex: 1;" oninput="fixToggleVolumeInput()">
                                <button type="button" id="fixBtnVolumeInconnu" class="btn btn-secondary" onclick="fixToggleVolumeInconnu()" style="padding: 8px 12px; font-size: 10px; white-space: nowrap;">
                                    Je ne sais pas
                                </button>
                            </div>
                            <div id="fixZoneVolumeInconnu" class="hidden" style="padding: 10px; background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.15); border-radius: 10px; margin-top: 10px;">
                                <div style="font-size: 10px; color: var(--accent-blue);"><i class="fas fa-info-circle" style="margin-right: 4px;"></i>On utilisera une base prudente de 10 unit&#233;s/mois et on calculera votre seuil de rentabilit&#233;.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION STAFF -->
                <div style="padding: 16px; background: rgba(6,182,212,0.06); border: 1px solid rgba(6,182,212,0.15); border-radius: 14px; margin-bottom: 16px;">
                    <div style="font-size: 12px; font-weight: 700; color: var(--accent-cyan); margin-bottom: 14px;">
                        <i class="fas fa-users" style="margin-right: 6px;"></i>Staff &amp; Aide &#224; la vente
                    </div>

                    <div style="margin-bottom: 14px;">
                        <label class="label" style="margin-bottom: 10px; display: block;">Avez-vous de l&#8217;aide pour g&#233;rer vos ventes ?</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button type="button" id="fixBtnStaffNon" class="btn btn-secondary" style="padding: 10px; font-size: 12px; text-align: left;" onclick="fixChoisirStaff('non')">
                                <i class="fas fa-user" style="margin-right: 6px; color: var(--text-muted);"></i>Non, je g&#232;re seul
                            </button>
                            <button type="button" id="fixBtnStaffSalaire" class="btn btn-secondary" style="padding: 10px; font-size: 12px; text-align: left;" onclick="fixChoisirStaff('salaire')">
                                <i class="fas fa-money-bill-wave" style="margin-right: 6px; color: var(--accent-orange);"></i>Oui, salaire fixe mensuel
                            </button>
                            <button type="button" id="fixBtnStaffCommission" class="btn btn-secondary" style="padding: 10px; font-size: 12px; text-align: left;" onclick="fixChoisirStaff('commission')">
                                <i class="fas fa-handshake" style="margin-right: 6px; color: var(--accent-cyan);"></i>Oui, commission par vente
                            </button>
                        </div>
                    </div>

                    <div id="fixZoneStaffSalaire" class="hidden">
                        <div class="input-group">
                            <label class="label">Montant total des salaires par mois (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixStaffSalaireMontant" class="input" placeholder="50000">
                        </div>
                    </div>

                    <div id="fixZoneStaffCommission" class="hidden">
                        <div class="input-group">
                            <label class="label">Combien donnez-vous par vente conclue ? (<span class="devise-label">FCFA</span>)</label>
                            <input type="number" id="fixStaffCommissionMontant" class="input" placeholder="1000">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 8px;">
                    <button onclick="fixRetourEtape2()" class="btn btn-secondary" style="padding: 14px 20px; font-size: 13px;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button onclick="fixValiderEtape3()" class="btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; border: none; font-weight: 700; font-size: 14px; border-radius: 12px; cursor: pointer;">
                        Voir le Verdict <i class="fas fa-magic" style="margin-left: 8px;"></i>
                    </button>
                </div>
            </div>

            <!-- ETAPE 4 : Rapport Strategique -->
            <div id="fixRapport" class="hidden">
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 800; color: var(--text-primary); margin-bottom: 4px;">
                        <i class="fas fa-chart-pie" style="color: #8b5cf6; margin-right: 6px;"></i>Rapport Strategique
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">Analyse compl&#232;te pour <strong id="fixRapportNom"></strong></div>
                </div>

                <div id="fixAlerteConcurrence" class="hidden" style="padding: 14px 16px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--accent-red);"><i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>Attention</div>
                    <div id="fixAlerteConcurrenceMsg" style="font-size: 11px; color: var(--accent-red); margin-top: 4px;"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                    <div style="padding: 14px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 14px;">
                        <div style="font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px;">Co&#251;t de Revient R&#233;el</div>
                        <div id="fixRapportCoutRevient" style="font-size: 22px; font-weight: 900; color: var(--accent-red);">0 F</div>
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Ce que le produit vous co&#251;te vraiment</div>
                    </div>
                    <div style="padding: 14px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 14px;">
                        <div style="font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px;">Prix Souhaite</div>
                        <div id="fixRapportPrixSouhaite" style="font-size: 22px; font-weight: 900; color: var(--accent-blue);">0 F</div>
                        <div id="fixRapportMargeVoulue" style="font-size: 9px; color: var(--text-muted); margin-top: 4px;"></div>
                    </div>
                    <div style="padding: 14px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 14px;">
                        <div style="font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px;">B&#233;n&#233;fice / Vente</div>
                        <div id="fixRapportBenefUnit" style="font-size: 22px; font-weight: 900; color: var(--accent-green);">0 F</div>
                        <div id="fixRapportMargePct" style="font-size: 9px; margin-top: 4px;"></div>
                    </div>
                    <div id="fixRapportConcurrentBox" style="padding: 14px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 14px; display: none;">
                        <div style="font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px;">Prix Concurrent</div>
                        <div id="fixRapportPrixConcurrent" style="font-size: 22px; font-weight: 900; color: var(--accent-orange);">0 F</div>
                        <div id="fixRapportEcartConcurrent" style="font-size: 9px; margin-top: 4px;"></div>
                    </div>
                </div>

                <div id="fixAnalysePrix" style="padding: 14px 16px; border-radius: 12px; margin-bottom: 16px;"></div>

                <div style="padding: 14px 16px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 14px; margin-bottom: 16px;">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px;">
                        <i class="fas fa-search-dollar" style="color: #8b5cf6; margin-right: 6px;"></i>Scanner de Co&#251;ts
                    </div>
                    <div id="fixDetailCouts" style="display: flex; flex-direction: column; gap: 6px;"></div>
                </div>

                <div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--text-primary); margin-bottom: 12px;">
                        <i class="fas fa-tags" style="color: #8b5cf6; margin-right: 6px;"></i>Grille Tarifaire
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="padding: 14px 16px; background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.15); border-radius: 12px; border-left: 4px solid var(--accent-red);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 12px; font-weight: 700; color: var(--accent-red);">Minimale (Break-even)</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">Prix coutant exact - 0% marge</div>
                                </div>
                                <div id="fixPrixBreakeven" style="font-size: 20px; font-weight: 900; color: var(--accent-red);">0 F</div>
                            </div>
                        </div>
                        <div style="padding: 14px 16px; background: rgba(245,158,11,0.06); border: 1px solid rgba(245,158,11,0.15); border-radius: 12px; border-left: 4px solid var(--accent-orange);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 12px; font-weight: 700; color: var(--accent-orange);">Prix S&#233;curit&#233;</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">Marge ~15% - couvre tout</div>
                                </div>
                                <div id="fixPrixSecurite" style="font-size: 20px; font-weight: 900; color: var(--accent-orange);">0 F</div>
                            </div>
                        </div>
                        <div style="padding: 14px 16px; background: rgba(16,185,129,0.06); border: 1px solid rgba(16,185,129,0.15); border-radius: 12px; border-left: 4px solid var(--accent-green);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 12px; font-weight: 700; color: var(--accent-green);">Prix Conseill&#233;</div>
                                    <div id="fixPrixConseilleDesc" style="font-size: 10px; color: var(--text-muted);">Marge 30-40%</div>
                                </div>
                                <div id="fixPrixConseille" style="font-size: 20px; font-weight: 900; color: var(--accent-green);">0 F</div>
                            </div>
                        </div>
                        <div style="padding: 14px 16px; background: rgba(139,92,246,0.06); border: 1px solid rgba(139,92,246,0.15); border-radius: 12px; border-left: 4px solid #8b5cf6;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 12px; font-weight: 700; color: #8b5cf6;">Prix Croissance (Premium)</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">Marge 60%+ - gros profit</div>
                                </div>
                                <div id="fixPrixPremium" style="font-size: 20px; font-weight: 900; color: #8b5cf6;">0 F</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Point Mort -->
                <div id="fixPointMort" style="padding: 14px 16px; background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.15); border-radius: 14px; margin-bottom: 16px; display: none;">
                    <div style="font-size: 11px; font-weight: 700; color: var(--accent-blue); margin-bottom: 8px;">
                        <i class="fas fa-crosshairs" style="margin-right: 6px;"></i>Point Mort (Seuil de Rentabilit&#233;)
                    </div>
                    <div id="fixPointMortMsg" style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;"></div>
                </div>

                <!-- Grille de Benefices -->
                <div id="fixGrilleBenefices" style="padding: 14px 16px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 14px; margin-bottom: 16px; display: none;">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px;">
                        <i class="fas fa-table" style="color: #8b5cf6; margin-right: 6px;"></i>Grille de B&#233;n&#233;fices
                    </div>
                    <div id="fixGrilleContenu"></div>
                </div>

                <div style="padding: 16px; background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(236,72,153,0.08)); border: 1px solid rgba(139,92,246,0.2); border-radius: 14px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6, #ec4899); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-robot" style="font-size: 16px; color: white;"></i>
                        </div>
                        <div style="font-size: 12px; font-weight: 800; color: var(--text-primary);">Conseil VEKO</div>
                    </div>
                    <div id="fixConseilVeko" style="font-size: 12px; line-height: 1.7; color: var(--text-secondary);"></div>
                </div>

                <!-- Scenarios de Vie -->
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--text-primary); margin-bottom: 12px;">
                        <i class="fas fa-lightbulb" style="color: #8b5cf6; margin-right: 6px;"></i>Sc&#233;narios de Vie
                    </div>

                    <div id="fixScenarioAligne" style="padding: 14px 16px; background: rgba(245,158,11,0.06); border: 1px solid rgba(245,158,11,0.15); border-radius: 12px; border-left: 4px solid var(--accent-orange); margin-bottom: 10px; display: none;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--accent-orange); margin-bottom: 6px;">Sc&#233;nario ALIGN&#201; (prix concurrent)</div>
                        <div id="fixScenarioAligneMsg" style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;"></div>
                    </div>

                    <div style="padding: 14px 16px; background: rgba(16,185,129,0.06); border: 1px solid rgba(16,185,129,0.15); border-radius: 12px; border-left: 4px solid var(--accent-green); margin-bottom: 10px;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--accent-green); margin-bottom: 6px;">Sc&#233;nario POCHE (votre objectif net)</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <input type="number" id="fixScenarioPocheInput" class="input" placeholder="Montant net souhait&#233; par vente" style="flex: 1; font-size: 12px; padding: 10px;" oninput="fixCalculerPoche()">
                            <span class="devise-label" style="font-size: 11px; color: var(--text-muted);">FCFA</span>
                        </div>
                        <div id="fixScenarioPocheMsg" style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;"></div>
                    </div>

                    <div style="padding: 14px 16px; background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.15); border-radius: 12px; border-left: 4px solid var(--accent-blue); margin-bottom: 10px;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--accent-blue); margin-bottom: 6px;">Sc&#233;nario &#201;QUILIBRE (+20% s&#233;curit&#233;)</div>
                        <div id="fixScenarioEquilibreMsg" style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;"></div>
                    </div>
                </div>

                <!-- Comment justifier ce prix -->
                <div id="fixJustifierPrix" style="padding: 16px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 14px; margin-bottom: 16px; display: none;">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px;">
                        <i class="fas fa-gem" style="color: #ec4899; margin-right: 6px;"></i>Comment justifier un prix plus haut ?
                    </div>
                    <div id="fixJustifierContenu" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>

                <button onclick="fixRecommencer()" class="btn btn-secondary" style="width: 100%; padding: 14px; font-size: 13px;">
                    <i class="fas fa-redo" style="margin-right: 8px;"></i>Nouvelle analyse
                </button>
            </div>
        </div>

    </div>
    <div id="page-projets" class="page">
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="section-title" style="margin: 0;">
                    <i class="fas fa-folder-open"></i>
                    Catalogue Produits
                </div>
                <button onclick="openModalProjet()" style="padding: 10px 18px; background: var(--gradient-success); color: white; border: none; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <i class="fas fa-plus"></i> Nouveau
                </button>
            </div>
            
            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                Enregistrez vos produits pour automatiser vos calculs.
            </p>
            
            <div id="listeProjets">
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <p>Aucun produit enregistre.<br>Cliquez sur "Nouveau" pour commencer !</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE: HISTORIQUE -->
    <div id="page-historique" class="page">
        
        <!-- Export PDF -->
        <div class="card" style="background: var(--gradient-primary); border: none; padding: 18px;">
            <button onclick="genererRapportPDF()" style="width: 100%; background: white; color: var(--accent-blue); border: none; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <i class="fas fa-file-pdf" style="font-size: 18px;"></i>
                Generer mon Rapport CEO
            </button>
            <div style="font-size: 11px; color: white; opacity: 0.9; text-align: center; margin-top: 10px;">
                Exportez vos statistiques en PDF professionnel
            </div>
        </div>
        
        <!-- Filtres periode -->
        <div class="card">
            <div class="section-title">
                <i class="fas fa-calendar"></i>
                Periode
            </div>
            <div class="grid-2">
                <button class="btn btn-primary" onclick="filtrerPeriode('jour')" id="btn-jour">Aujourd'hui</button>
                <button class="btn btn-secondary" onclick="filtrerPeriode('semaine')" id="btn-semaine">Cette Semaine</button>
                <button class="btn btn-secondary" onclick="filtrerPeriode('mois')" id="btn-mois">Ce Mois</button>
                <button class="btn btn-secondary" onclick="filtrerPeriode('tout')" id="btn-tout">Tout</button>
            </div>
        </div>

        <!-- Stats resume -->
        <div class="grid-2">
            <div class="stat-card">
                <div class="stat-value counter-animate" id="statNbVentes">0</div>
                <div class="stat-label">Ventes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value counter-animate" id="statBenefice" style="color: var(--accent-green);">0 F</div>
                <div class="stat-label">Benefice Total</div>
            </div>
        </div>

        <!-- Resume financier -->
        <div class="card">
            <div class="section-title">
                <i class="fas fa-chart-line"></i>
                Resume Financier
            </div>
            <div class="info-row">
                <span class="info-label">Chiffre d'affaires</span>
                <span class="info-value" id="statCA">0 F</span>
            </div>
            <div class="info-row">
                <span class="info-label">Total depenses</span>
                <span class="info-value" id="statDepenses">0 F</span>
            </div>
            <div class="info-row">
                <span class="info-label">Marge nette</span>
                <span class="info-value" id="statMarge">0%</span>
            </div>
        </div>

        <!-- Performance par Projet -->
        <div class="card" id="cardPerformanceProjets" style="display: none;">
            <div class="section-title">
                <i class="fas fa-chart-pie"></i>
                Performance par Projet
            </div>
            <div id="performanceProjets"></div>
        </div>

        <!-- Repartir la pub -->
        <div class="card" id="cardRepartirPub" style="display: none;">
            <div class="section-title">
                <i class="fas fa-bullhorn"></i>
                Repartir la Pub du Jour
            </div>
            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                Entrez le montant depense sur Meta Ads.
            </p>
            
            <div class="input-group">
                <label class="label">Devise utilisee sur Meta Ads</label>
                <select id="deviseMeta" class="input" onchange="calculerConversionPub()">
                    <option value="XAF">FCFA / XAF</option>
                    <option value="USD">USD (Dollar US)</option>
                    <option value="EUR">EUR (Euro)</option>
                    <option value="GBP">GBP (Livre Sterling)</option>
                    <option value="CAD">CAD (Dollar Canadien)</option>
                    <option value="AUD">AUD (Dollar Australien)</option>
                    <option value="CHF">CHF (Franc Suisse)</option>
                    <option value="JPY">JPY (Yen Japonais)</option>
                    <option value="CNY">CNY (Yuan Chinois)</option>
                    <option value="INR">INR (Roupie Indienne)</option>
                    <option value="BRL">BRL (Real Bresilien)</option>
                    <option value="MXN">MXN (Peso Mexicain)</option>
                    <option value="ZAR">ZAR (Rand Sud-Africain)</option>
                    <option value="NGN">NGN (Naira Nigerian)</option>
                    <option value="GHS">GHS (Cedi Ghaneen)</option>
                    <option value="KES">KES (Shilling Kenyan)</option>
                    <option value="MAD">MAD (Dirham Marocain)</option>
                    <option value="TND">TND (Dinar Tunisien)</option>
                    <option value="EGP">EGP (Livre Egyptienne)</option>
                    <option value="AED">AED (Dirham Emirats)</option>
                    <option value="SAR">SAR (Riyal Saoudien)</option>
                    <option value="NZD">NZD (Dollar Neo-Zelandais)</option>
                    <option value="SGD">SGD (Dollar Singapour)</option>
                    <option value="HKD">HKD (Dollar Hong Kong)</option>
                    <option value="SEK">SEK (Couronne Suedoise)</option>
                    <option value="NOK">NOK (Couronne Norvegienne)</option>
                    <option value="DKK">DKK (Couronne Danoise)</option>
                    <option value="PLN">PLN (Zloty Polonais)</option>
                    <option value="TRY">TRY (Livre Turque)</option>
                    <option value="THB">THB (Baht Thailandais)</option>
                    <option value="MYR">MYR (Ringgit Malaisien)</option>
                    <option value="IDR">IDR (Roupie Indonesienne)</option>
                    <option value="PHP">PHP (Peso Philippin)</option>
                    <option value="VND">VND (Dong Vietnamien)</option>
                    <option value="KRW">KRW (Won Sud-Coreen)</option>
                    <option value="COP">COP (Peso Colombien)</option>
                    <option value="ARS">ARS (Peso Argentin)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label class="label">Montant depense en <span id="deviseMetaLabel">FCFA</span></label>
                <input type="number" id="budgetPubJour" class="input" placeholder="10000" oninput="calculerConversionPub()">
            </div>
            
            <div id="resultatConversion" style="display: none; background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 16px; border-left: 4px solid var(--accent-green);">
                <div style="font-size: 11px; color: var(--accent-green); font-weight: 600; margin-bottom: 4px;">
                    Montant converti
                </div>
                <div style="font-size: 20px; color: var(--accent-green); font-weight: 900;" id="montantConverti">0 FCFA</div>
            </div>
            
            <button class="btn btn-success" onclick="repartirPubJour()">
                <i class="fas fa-calculator"></i> Calculer et Repartir
            </button>
        </div>

        <!-- Liste des ventes -->
        <div class="card">
            <div class="section-title">
                <i class="fas fa-list"></i>
                Detail des Ventes
            </div>
            <div id="listeVentes">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>Aucune vente enregistree</p>
                </div>
            </div>
        </div>
    </div>

        </div> <!-- End main-content -->

    <!-- FAB (Floating Action Button) - Direct to nouvelle vente -->
    <div class="fab-container">
        <button class="fab-main" id="fabMain" onclick="showTab('nouvelle'); hapticFeedback();">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <div class="bottom-nav-content">
            <button id="navDashboard" class="nav-tab active" onclick="showTab('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </button>
            <button id="navCalcul" class="nav-tab" onclick="showTab('nouvelle')">
                <i class="fas fa-calculator"></i>
                <span>Calcul</span>
            </button>
            <button id="navProjets" class="nav-tab" onclick="showTab('projets')">
                <i class="fas fa-folder"></i>
                <span>Projets</span>
            </button>
            <button id="navHistorique" class="nav-tab" onclick="showTab('historique')">
                <i class="fas fa-history"></i>
                <span>Historique</span>
            </button>
            <button id="navSimulation" class="nav-tab" onclick="showTab('simulation')">
                <i class="fas fa-flask"></i>
                <span>Labo</span>
            </button>
        </div>
    </nav>

    <!-- MODAL: Nouveau Projet -->
    <div id="modalProjet" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-folder-plus"></i>
                    Nouveau Produit
                </div>
                <button class="modal-close" onclick="closeModalProjet()">&times;</button>
            </div>
            
            <div class="input-group">
                <label class="label">Nom du produit</label>
                <input type="text" id="projetNom" class="input" placeholder="Ex: Chaussures Nike">
            </div>

            <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                <button type="button" id="btnProjetFournisseur" class="btn btn-primary" style="flex: 1; padding: 12px; font-size: 13px;" onclick="changerTypeProjet('fournisseur')">
                    <i class="fas fa-truck"></i> Fournisseur
                </button>
                <button type="button" id="btnProjetProduction" class="btn btn-secondary" style="flex: 1; padding: 12px; font-size: 13px;" onclick="changerTypeProjet('production')">
                    <i class="fas fa-industry"></i> Production
                </button>
            </div>

            <div id="projetFormFournisseur">
                <div class="input-group">
                    <label class="label">Prix d'achat unitaire (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="projetPrixAchat" class="input" placeholder="2500">
                </div>
                
                <div class="input-group">
                    <label class="label">Nombre d'articles achetes</label>
                    <input type="number" id="projetNbArticles" class="input" placeholder="10">
                </div>
                
                <div class="input-group">
                    <label class="label">Frais de livraison / Transport (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="projetFraisLivraison" class="input" placeholder="5000" value="0">
                </div>
            </div>

            <div id="projetFormProduction" class="hidden">
                <div class="input-group">
                    <label class="label">Cout matieres premieres (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="projetCoutMatieres" class="input" placeholder="15000">
                </div>
                
                <div class="input-group">
                    <label class="label">Cout main d'oeuvre (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="projetCoutMainOeuvre" class="input" placeholder="5000">
                </div>
                
                <div class="input-group">
                    <label class="label">Autres frais de production (<span class="devise-label">FCFA</span>)</label>
                    <input type="number" id="projetAutresFrais" class="input" placeholder="2000" value="0">
                </div>
                
                <div class="input-group">
                    <label class="label">Nombre de produits fabriques</label>
                    <input type="number" id="projetNbProduits" class="input" placeholder="10">
                </div>
            </div>
            
            <button class="btn btn-success" onclick="sauvegarderProjet()">
                <i class="fas fa-save"></i>
                Enregistrer le produit
            </button>
        </div>
    </div>

    <!-- MODAL: Devise -->
    <div id="modalDevise" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-coins"></i>
                    Devise d'Affichage
                </div>
                <button class="modal-close" onclick="closeModalDevise()">&times;</button>
            </div>
            
            <div class="input-group">
                <label class="label">Selectionnez votre devise</label>
                <select id="selectDevise" class="input">
                    <option value="FCFA">FCFA (Franc CFA)</option>
                    <option value="EUR">EUR (Euro)</option>
                    <option value="USD">USD (Dollar US)</option>
                    <option value="CAD">CAD (Dollar Canadien)</option>
                    <option value="GBP">GBP (Livre Sterling)</option>
                    <option value="MAD">MAD (Dirham Marocain)</option>
                    <option value="XOF">XOF (Franc CFA BCEAO)</option>
                    <option value="GNF">GNF (Franc Guineen)</option>
                    <option value="NGN">NGN (Naira Nigerian)</option>
                    <option value="ZAR">ZAR (Rand Sud-Africain)</option>
                    <option value="KES">KES (Shilling Kenyan)</option>
                    <option value="TZS">TZS (Shilling Tanzanien)</option>
                    <option value="UGX">UGX (Shilling Ougandais)</option>
                    <option value="RWF">RWF (Franc Rwandais)</option>
                    <option value="BIF">BIF (Franc Burundais)</option>
                    <option value="CDF">CDF (Franc Congolais)</option>
                    <option value="AOA">AOA (Kwanza Angolais)</option>
                    <option value="MZN">MZN (Metical Mozambicain)</option>
                    <option value="EGP">EGP (Livre Egyptienne)</option>
                    <option value="DZD">DZD (Dinar Algerien)</option>
                    <option value="TND">TND (Dinar Tunisien)</option>
                    <option value="CHF">CHF (Franc Suisse)</option>
                    <option value="INR">INR (Roupie Indienne)</option>
                    <option value="CNY">CNY (Yuan Chinois)</option>
                    <option value="JPY">JPY (Yen Japonais)</option>
                    <option value="AED">AED (Dirham Emirats)</option>
                    <option value="SAR">SAR (Riyal Saoudien)</option>
                    <option value="BRL">BRL (Real Bresilien)</option>
                    <option value="MXN">MXN (Peso Mexicain)</option>
                    <option value="ARS">ARS (Peso Argentin)</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="saveDevise()">
                <i class="fas fa-check"></i>
                Confirmer
            </button>
        </div>
    </div>

    <!-- MODAL: Objectif -->
    <div id="modalObjectif" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-bullseye"></i>
                    Definir un Objectif
                </div>
                <button class="modal-close" onclick="closeModalObjectif()">&times;</button>
            </div>
            
            <div class="input-group">
                <label class="label">Type d'objectif</label>
                <select id="objectifType" class="input">
                    <option value="CA">Chiffre d'Affaires (CA)</option>
                    <option value="Benefice">Benefice Net</option>
                    <option value="Ventes">Nombre de Ventes</option>
                </select>
            </div>
            
            <div class="input-group">
                <label class="label">Montant de l'objectif</label>
                <input type="number" id="objectifMontant" class="input" placeholder="Ex: 500000">
            </div>
            
            <div class="input-group">
                <label class="label">Date de debut</label>
                <div class="calendar-input">
                    <input type="date" id="objectifDateDebut" class="input">
                    <i class="fas fa-calendar"></i>
                </div>
            </div>
            
            <div class="input-group">
                <label class="label">Date de fin</label>
                <div class="calendar-input">
                    <input type="date" id="objectifDateFin" class="input">
                    <i class="fas fa-calendar"></i>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="saveObjectif()">
                <i class="fas fa-check"></i>
                Valider l'objectif
            </button>
        </div>
    </div>

    <!-- MODAL: Profil -->
    <div id="modalProfil" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Personnaliser le Profil
                </div>
                <button class="modal-close" onclick="closeModalProfil()">&times;</button>
            </div>
            
            <div class="input-group">
                <label class="label">Votre nom / pseudo</label>
                <input type="text" id="inputNomProfil" class="input" placeholder="Ex: Jean, Boss, Patron...">
            </div>
            
            <div class="input-group">
                <label class="label">Objectif journalier (<span class="devise-label">FCFA</span>)</label>
                <input type="number" id="inputObjectifJour" class="input" placeholder="50000" value="50000">
            </div>
            
            <!-- Theme Selector -->
            <div class="input-group">
                <label class="label">Theme de l'application</label>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button type="button" id="themeDark" class="btn btn-secondary theme-btn" style="flex: 1; padding: 12px;" onclick="setTheme('dark')">
                        <i class="fas fa-moon"></i> Sombre
                    </button>
                    <button type="button" id="themeLight" class="btn btn-secondary theme-btn" style="flex: 1; padding: 12px;" onclick="setTheme('light')">
                        <i class="fas fa-sun"></i> Jour
                    </button>
                    <button type="button" id="themeAuto" class="btn btn-secondary theme-btn" style="flex: 1; padding: 12px;" onclick="setTheme('auto')">
                        <i class="fas fa-adjust"></i> Auto
                    </button>
                </div>
            </div>
            
            <!-- Mode Economie de donnees -->
            <div class="input-group">
                <label class="label">Mode Economie de donnees</label>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px; padding: 12px; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--diamond-border);">
                    <div>
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Basse consommation</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Desactive animations et polices externes</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modeEconomie" onchange="toggleModeEconomie()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="sauvegarderProfil()">
                <i class="fas fa-save"></i>
                Enregistrer
            </button>
        </div>
    </div>

    </div> <!-- End container -->
</div> <!-- End mainApp -->

<script>
// ============================================
// VARIABLES GLOBALES
// ============================================
let ventes = [];
let projets = [];
let prixRevient = 0;
let typeCalcul = 'fournisseur';
let periodeActive = 'jour';
let deviseActuelle = 'FCFA';
let objectifJournalier = 50000;
let objectifPersonnel = null;
let nomUtilisateur = 'Boss';

// Taux de change vers FCFA (approximatifs)
const tauxDeChange = {
    'XAF': 1,
    'FCFA': 1,
    'XOF': 1,
    'EUR': 656,
    'USD': 610,
    'CAD': 450,
    'GBP': 770,
    'MAD': 60,
    'GNF': 0.07,
    'NGN': 0.75,
    'GHS': 50,
    'ZAR': 32,
    'KES': 4.5,
    'TZS': 0.24,
    'UGX': 0.16,
    'RWF': 0.5,
    'BIF': 0.21,
    'CDF': 0.22,
    'AOA': 0.7,
    'MZN': 9.5,
    'EGP': 13,
    'DZD': 4.5,
    'TND': 195,
    'CHF': 680,
    'INR': 7.3,
    'CNY': 85,
    'JPY': 4,
    'AED': 166,
    'SAR': 163,
    'BRL': 125,
    'MXN': 35,
    'ARS': 0.7,
    'AUD': 395,
    'NZD': 365,
    'SGD': 455,
    'HKD': 78,
    'SEK': 58,
    'NOK': 57,
    'DKK': 88,
    'PLN': 152,
    'CZK': 26,
    'HUF': 1.7,
    'RUB': 6.8,
    'TRY': 19,
    'THB': 17,
    'MYR': 130,
    'IDR': 0.039,
    'PHP': 11,
    'VND': 0.025,
    'KRW': 0.46,
    'TWD': 19,
    'COP': 0.15,
    'PEN': 165,
    'CLP': 0.68
};

// ============================================
// SUPABASE AUTH
// ============================================
const supabaseUrl = 'https://qeimizgeiqwtppzaecdz.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlaW1pemdlaXF3dHBwemFlY2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzk5MTksImV4cCI6MjA4NTk1NTkxOX0._2x1hduAY1a6-ZqeLn8lV9M9qC4Ds7hOCMjXE468QKc';
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

let modeUtilisateur = 'user';
let currentTheme = 'system';
let modeEconomieDonnees = false;

// ============================================
// PROFILE DROPDOWN
// ============================================
function toggleProfileDropdown() {
    const dropdowns = document.querySelectorAll('.profile-dropdown');
    
    dropdowns.forEach(dropdown => {
        dropdown.classList.add('show');
    });
    hapticFeedback();
}

function closeProfileDropdown() {
    const dropdowns = document.querySelectorAll('.profile-dropdown');
    
    dropdowns.forEach(dropdown => {
        dropdown.classList.remove('show');
    });
}

function updateProfileDropdown() {
    const nameEls = document.querySelectorAll('[id^="dropdownProfileName"]');
    const levelEls = document.querySelectorAll('[id^="dropdownProfileLevel"]');
    const iconEls = document.querySelectorAll('[id^="btnModeProfil"]');
    
    nameEls.forEach(el => el.textContent = nomUtilisateur);
    
    const beneficeTotal = calculerBeneficeTotal();
    const niveau = getNiveauUtilisateur(beneficeTotal);
    
    levelEls.forEach(el => {
        el.className = 'profile-dropdown-level ' + niveau.badge;
        el.innerHTML = '<i class="fas fa-medal"></i> ' + niveau.nom;
    });
    
    iconEls.forEach(el => {
        el.classList.remove('mode-admin', 'mode-user');
        if (modeUtilisateur === 'admin') {
            el.classList.add('mode-admin');
        } else {
            el.classList.add('mode-user');
        }
    });
}

function getNiveauUtilisateur(benefice) {
    if (benefice >= 10000000) return { nom: 'Diamant', badge: 'badge-diamond' };
    if (benefice >= 5000000) return { nom: 'Platine', badge: 'badge-platinum' };
    if (benefice >= 1000000) return { nom: 'Or', badge: 'badge-gold' };
    if (benefice >= 500000) return { nom: 'Argent', badge: 'badge-silver' };
    return { nom: 'Bronze', badge: 'badge-bronze' };
}

// ============================================
// THEME MANAGEMENT
// ============================================
function changerTheme(mode) {
    const body = document.body;
    const btns = ['btn-theme-light', 'btn-theme-dark', 'btn-theme-system'];
    const btnsDesktop = ['btn-theme-light-desktop', 'btn-theme-dark-desktop', 'btn-theme-system-desktop'];
    
    localStorage.setItem('veko_theme', mode);
    currentTheme = mode;

    if (mode === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
    } else if (mode === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
    } else {
        document.documentElement.setAttribute('data-theme', 'system');
    }

    btns.forEach(id => {
        const btn = document.getElementById(id);
        if(btn) {
            if (id === 'btn-theme-' + mode) {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.color = 'var(--text-primary)';
                btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
            } else {
                btn.style.background = 'none';
                btn.style.color = 'var(--text-muted)';
                btn.style.boxShadow = 'none';
            }
        }
    });
    
    btnsDesktop.forEach(id => {
        const btn = document.getElementById(id);
        if(btn) {
            if (id === 'btn-theme-' + mode + '-desktop') {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.color = 'var(--text-primary)';
                btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
            } else {
                btn.style.background = 'none';
                btn.style.color = 'var(--text-muted)';
                btn.style.boxShadow = 'none';
            }
        }
    });
    
    hapticFeedback();
}

function setTheme(theme) {
    changerTheme(theme);
}

function applyTheme(theme) {
    const html = document.documentElement;
    
    if (theme === 'system') {
        html.setAttribute('data-theme', 'system');
    } else {
        html.setAttribute('data-theme', theme);
    }
}

function updateThemeSlider(theme) {
    const indicators = document.querySelectorAll('[id^="themeIndicator"]');
    const options = document.querySelectorAll('.theme-slider-option');
    
    options.forEach(opt => opt.classList.remove('active'));
    
    if (theme === 'light') {
        indicators.forEach(ind => ind.className = 'theme-slider-indicator pos-0');
        document.querySelectorAll('[data-theme="light"]').forEach(el => el.classList.add('active'));
    } else if (theme === 'dark') {
        indicators.forEach(ind => ind.className = 'theme-slider-indicator pos-1');
        document.querySelectorAll('[data-theme="dark"]').forEach(el => el.classList.add('active'));
    } else {
        indicators.forEach(ind => ind.className = 'theme-slider-indicator pos-2');
        document.querySelectorAll('[data-theme="system"]').forEach(el => el.classList.add('active'));
    }
}

function updateThemeButtons() {
    updateThemeSlider(currentTheme);
}

function loadTheme() {
    const savedTheme = localStorage.getItem('veko_theme') || 'system';
    currentTheme = savedTheme;
    changerTheme(savedTheme);
    
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (currentTheme === 'system') {
            changerTheme('system');
        }
    });
    
    const ecoSaved = localStorage.getItem('veko_eco_mode') === 'true';
    const toggle = document.getElementById('toggle-eco-mode');
    const toggleDesktop = document.getElementById('toggle-eco-mode-desktop');
    if(toggle) toggle.checked = ecoSaved;
    if(toggleDesktop) toggleDesktop.checked = ecoSaved;
    if(ecoSaved) {
        document.body.classList.add('low-data');
        document.documentElement.classList.add('mode-economie');
        modeEconomieDonnees = true;
    }
}

// ============================================
// MODE ECONOMIE DE DONNEES
// ============================================
function toggleEcoMode(checkbox) {
    const isChecked = checkbox ? checkbox.checked : false;
    modeEconomieDonnees = isChecked;
    localStorage.setItem('veko_eco_mode', isChecked ? 'true' : 'false');
    
    const toggle = document.getElementById('toggle-eco-mode');
    const toggleDesktop = document.getElementById('toggle-eco-mode-desktop');
    if (toggle) toggle.checked = isChecked;
    if (toggleDesktop) toggleDesktop.checked = isChecked;
    
    if (isChecked) {
        document.body.classList.add('low-data');
        document.documentElement.classList.add('mode-economie');
        afficherNotification('Mode Economie active : Animations reduites', 'success');
    } else {
        document.body.classList.remove('low-data');
        document.documentElement.classList.remove('mode-economie');
    }
    
    hapticFeedback();
}

function toggleModeEconomie() {
    modeEconomieDonnees = document.getElementById('modeEconomie')?.checked || false;
    localStorage.setItem('veko_mode_economie', modeEconomieDonnees);
    applyModeEconomie();
    hapticFeedback();
}

function toggleDataSaver() {
    const toggle = document.getElementById('dataSaverToggle');
    const toggleDesktop = document.getElementById('dataSaverToggleDesktop');
    
    modeEconomieDonnees = toggle?.checked || toggleDesktop?.checked || false;
    localStorage.setItem('veko_mode_economie', modeEconomieDonnees);
    
    if (toggle) toggle.checked = modeEconomieDonnees;
    if (toggleDesktop) toggleDesktop.checked = modeEconomieDonnees;
    
    applyModeEconomie();
    hapticFeedback();
}

function applyModeEconomie() {
    const html = document.documentElement;
    if (modeEconomieDonnees) {
        html.classList.add('mode-economie');
    } else {
        html.classList.remove('mode-economie');
    }
    
    const toggle = document.getElementById('dataSaverToggle');
    const toggleDesktop = document.getElementById('dataSaverToggleDesktop');
    if (toggle) toggle.checked = modeEconomieDonnees;
    if (toggleDesktop) toggleDesktop.checked = modeEconomieDonnees;
}

function loadModeEconomie() {
    modeEconomieDonnees = localStorage.getItem('veko_mode_economie') === 'true';
    const checkbox = document.getElementById('modeEconomie');
    const dataSaver = document.getElementById('dataSaverToggle');
    if (checkbox) checkbox.checked = modeEconomieDonnees;
    if (dataSaver) dataSaver.checked = modeEconomieDonnees;
    applyModeEconomie();
}

// ============================================
// DECONNEXION
// ============================================
async function deconnexion() {
    if(confirm("Voulez-vous vraiment vous d\u00e9connecter ?")) {
        closeProfileDropdown();
        await supabaseClient.auth.signOut();
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authScreen').style.display = 'flex';
        document.getElementById('authForm').style.display = 'block';
        document.getElementById('authEmail').value = '';
        document.getElementById('authMessage').style.display = 'none';
        document.getElementById('authError').style.display = 'none';
        hapticFeedback(50);
    }
}

function deconnecter() {
    deconnexion();
}

// ============================================
// DAILY DIGEST
// ============================================
function showDailyDigest(message) {
    const digest = document.getElementById('dailyDigest');
    const textEl = document.getElementById('dailyDigestText');
    if (textEl) textEl.textContent = message;
    if (digest) {
        digest.classList.add('show');
        setTimeout(() => {
            digest.classList.remove('show');
        }, 5000);
    }
}

function closeDailyDigest() {
    const digest = document.getElementById('dailyDigest');
    if (digest) digest.classList.remove('show');
}

function checkDailyDigest() {
    const today = new Date().toDateString();
    const lastDigest = localStorage.getItem('veko_last_digest');
    
    if (lastDigest !== today) {
        const ventesHier = getVentesParPeriode('hier');
        const ventesAvantHier = getVentesParPeriode('avant-hier');
        
        if (ventesHier.length > ventesAvantHier.length) {
            const diff = ventesHier.length - ventesAvantHier.length;
            setTimeout(() => {
                showDailyDigest('Felicitations ! Vous avez realise ' + diff + ' vente(s) de plus qu\'hier.');
            }, 2000);
        }
        localStorage.setItem('veko_last_digest', today);
    }
}

function getVentesParPeriode(periode) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    return ventes.filter(v => {
        const venteDate = new Date(v.date);
        const venteDateOnly = new Date(venteDate.getFullYear(), venteDate.getMonth(), venteDate.getDate());
        
        if (periode === 'hier') {
            const hier = new Date(today);
            hier.setDate(hier.getDate() - 1);
            return venteDateOnly.getTime() === hier.getTime();
        } else if (periode === 'avant-hier') {
            const avantHier = new Date(today);
            avantHier.setDate(avantHier.getDate() - 2);
            return venteDateOnly.getTime() === avantHier.getTime();
        }
        return false;
    });
}

// ============================================
// HAPTIC FEEDBACK
// ============================================
function hapticFeedback(duration = 10) {
    if (navigator.vibrate) {
        navigator.vibrate(duration);
    }
}

function vibrerSucces() {
    if (navigator.vibrate) {
        navigator.vibrate([50, 50, 50]);
    }
}

// ============================================
// COUNTER ANIMATION
// ============================================
function animateCounter(element, targetValue, duration = 500, suffix = '') {
    if (modeEconomieDonnees) {
        element.textContent = targetValue.toLocaleString() + suffix;
        return;
    }
    
    const startTime = performance.now();
    const startValue = 0;
    element.classList.add('counting');
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeProgress = 1 - Math.pow(1 - progress, 3);
        const currentValue = Math.round(startValue + (targetValue - startValue) * easeProgress);
        
        element.textContent = currentValue.toLocaleString() + suffix;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            element.classList.remove('counting');
        }
    }
    
    requestAnimationFrame(update);
}

// ============================================
// AUTH SUPABASE - LOGIN / SESSION
// ============================================
async function loginWithEmail() {
    const email = document.getElementById('authEmail').value.trim();
    const msgDiv = document.getElementById('authMessage');
    const msgText = document.getElementById('authMessageText');
    const errDiv = document.getElementById('authError');
    const errText = document.getElementById('authErrorText');
    const btn = document.getElementById('authSubmitBtn');
    msgDiv.style.display = 'none';
    errDiv.style.display = 'none';

    if (!email || !email.includes('@')) {
        errText.textContent = 'Veuillez entrer une adresse email valide.';
        errDiv.style.display = 'block';
        return;
    }

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';
    btn.style.pointerEvents = 'none';

    const { error } = await supabaseClient.auth.signInWithOtp({ email: email });
    console.log('signInWithOtp result:', error ? error : 'OK');

    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Recevoir mon acc\u00e8s';
    btn.style.pointerEvents = 'auto';

    if (error) {
        console.log('Auth error:', error);
        errText.textContent = error.message || 'Erreur lors de l\'envoi du lien.';
        errDiv.style.display = 'block';
    } else {
        msgText.innerHTML = 'V\u00e9rifiez votre bo\u00eete mail, le lien d\'acc\u00e8s arrive...<br><strong style="color: #8b5cf6;">' + email + '</strong>';
        msgDiv.style.display = 'block';
        document.getElementById('authForm').style.display = 'none';
    }
}

async function checkSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
        showApp(session.user);
    } else {
        document.getElementById('authScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
    }
}

function showApp(user) {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';

    modeUtilisateur = 'user';
    const badge = document.getElementById('userBadge');
    if (badge) {
        const displayName = user.user_metadata?.full_name || user.email || 'Utilisateur';
        badge.innerHTML = '<i class="fas fa-user-circle"></i> ' + displayName +
            ' <button class="logout-btn" onclick="deconnexion()"><i class="fas fa-sign-out-alt"></i></button>';
        badge.classList.add('user');
        badge.style.display = 'flex';
    }

    initApp();
}

supabaseClient.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
        showApp(session.user);
    }
});

function seDeconnecter() {
    deconnexion();
}

// ============================================
// INITIALISATION APP
// ============================================
function initApp() {
    loadTheme();
    loadModeEconomie();
    chargerDonnees();
    chargerProfil();
    afficherHistorique();
    afficherProjets();
    updateSelectProjet();
    updateChartProduitSelect();
    genererConseilAxis();
    updateMicroBadge();
    updateActivityRing();
    updateProfileDropdown();
    
    showTab('dashboard');
    
    checkMorningBrief();
    checkDailyDigest();
    checkEveningRecall();
    checkSundayStrategy();
    
    setTimeout(() => {
        chargerDashboard();
    }, 100);
}

// ============================================
// PROFIL UTILISATEUR
// ============================================
function chargerProfil() {
    const savedName = localStorage.getItem('veko_user_name');
    const savedObjectif = localStorage.getItem('veko_objectif_jour');
    
    if (savedName) {
        nomUtilisateur = savedName;
        document.getElementById('profileName').textContent = nomUtilisateur;
    }
    
    if (savedObjectif) {
        objectifJournalier = Number(savedObjectif);
    }
}

function sauvegarderProfil() {
    const nom = document.getElementById('inputNomProfil').value.trim();
    const objectif = Number(document.getElementById('inputObjectifJour').value) || 50000;
    
    if (nom) {
        nomUtilisateur = nom;
        localStorage.setItem('veko_user_name', nom);
        document.getElementById('profileName').textContent = nom;
    }
    
    objectifJournalier = objectif;
    localStorage.setItem('veko_objectif_jour', objectif);
    
    hapticFeedback();
    closeModalProfil();
    updateActivityRing();
    afficherNotification('Profil mis a jour !', 'success');
}

function openModalProfil() {
    document.getElementById('inputNomProfil').value = nomUtilisateur;
    document.getElementById('inputObjectifJour').value = objectifJournalier;
    document.getElementById('modalProfil').style.display = 'block';
}

function closeModalProfil() {
    document.getElementById('modalProfil').style.display = 'none';
}

// ============================================
// DAILY DIGEST NOTIFICATION
// ============================================
function showDailyDigest() {
    const aujourdhui = new Date();
    const hier = new Date();
    hier.setDate(hier.getDate() - 1);
    
    const ventesAujourdhui = ventes.filter(v => {
        const dateVente = new Date(v.date);
        return dateVente.toDateString() === aujourdhui.toDateString() && !v.retournee;
    });
    
    const ventesHier = ventes.filter(v => {
        const dateVente = new Date(v.date);
        return dateVente.toDateString() === hier.toDateString() && !v.retournee;
    });
    
    const nbAujourdhui = ventesAujourdhui.length;
    const nbHier = ventesHier.length;
    const diff = nbAujourdhui - nbHier;
    
    if (nbAujourdhui > 0 && diff > 0) {
        afficherNotification(`Bravo ${nomUtilisateur} ! Tu as deja ${nbAujourdhui} vente(s) aujourd'hui, soit ${diff} de plus qu'hier !`, 'success');
        hapticFeedback(100);
    } else if (nbAujourdhui > 0) {
        afficherNotification(`${nbAujourdhui} vente(s) aujourd'hui. Continue sur cette lancee !`, 'info');
    }
}

// ============================================
// MICRO-BADGES
// ============================================
function updateMicroBadge() {
    const beneficeTotal = ventes.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
    const container = document.getElementById('userMicroBadge');
    const previousBadge = localStorage.getItem('veko_badge_level') || 'debutant';
    
    let badge = '';
    let newLevel = 'debutant';
    
    if (beneficeTotal >= 10000000) {
        badge = '<span class="micro-badge badge-diamond"><i class="fas fa-gem"></i> Diamond</span>';
        newLevel = 'diamond';
    } else if (beneficeTotal >= 5000000) {
        badge = '<span class="micro-badge badge-platinum"><i class="fas fa-medal"></i> Platinum</span>';
        newLevel = 'platinum';
    } else if (beneficeTotal >= 1000000) {
        badge = '<span class="micro-badge badge-gold"><i class="fas fa-crown"></i> Gold</span>';
        newLevel = 'gold';
    } else if (beneficeTotal >= 500000) {
        badge = '<span class="micro-badge badge-silver"><i class="fas fa-star"></i> Silver</span>';
        newLevel = 'silver';
    } else if (beneficeTotal >= 100000) {
        badge = '<span class="micro-badge badge-bronze"><i class="fas fa-award"></i> Bronze</span>';
        newLevel = 'bronze';
    } else {
        badge = '<span class="micro-badge" style="background: var(--glass-bg); color: var(--text-muted); border: 1px solid var(--diamond-border);"><i class="fas fa-seedling"></i> Debutant</span>';
        newLevel = 'debutant';
    }
    
    if (newLevel !== previousBadge) {
        const levelOrder = ['debutant', 'bronze', 'silver', 'gold', 'platinum', 'diamond'];
        if (levelOrder.indexOf(newLevel) > levelOrder.indexOf(previousBadge)) {
            hapticFeedback(200);
            afficherNotification('Felicitations ! Vous etes passe au niveau ' + newLevel.toUpperCase() + ' !', 'success');
        }
        localStorage.setItem('veko_badge_level', newLevel);
    }
    
    container.innerHTML = badge;
}

// ============================================
// ACTIVITY RING - Synchronisation Objectif du Jour
// ============================================
function updateActivityRing() {
    const ringBenefice = document.getElementById('ringBenefice');
    const ringCA = document.getElementById('ringCA');
    const ringVentes = document.getElementById('ringVentes');
    const centerValue = document.getElementById('ringCenterValue');
    const objectifActions = document.getElementById('objectifActions');
    const objectifSlideContent = document.getElementById('objectifSlideContent');

    const circumBenefice = 2 * Math.PI * 75;
    const circumCA = 2 * Math.PI * 60;
    const circumVentes = 2 * Math.PI * 45;

    if (!objectifPersonnel) {
        if (ringBenefice) { ringBenefice.style.strokeDashoffset = circumBenefice; ringBenefice.style.filter = 'none'; }
        if (ringCA) ringCA.style.strokeDashoffset = circumCA;
        if (ringVentes) ringVentes.style.strokeDashoffset = circumVentes;
        if (centerValue) centerValue.textContent = '0%';
        if (objectifActions) objectifActions.style.display = 'none';
        if (objectifSlideContent) {
            objectifSlideContent.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <i class="fas fa-bullseye" style="font-size: 32px; color: var(--text-muted); margin-bottom: 12px;"></i>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Aucun objectif defini</p>
                    <button onclick="openModalObjectif()" class="btn btn-primary" style="width: auto; padding: 12px 24px;">
                        <i class="fas fa-plus"></i> Definir un objectif
                    </button>
                </div>
            `;
        }
        return;
    }

    if (objectifActions) objectifActions.style.display = 'flex';

    const aujourdhui = new Date();
    const debutParts = objectifPersonnel.dateDebut.split('-');
    const dateDebutObjectif = new Date(debutParts[0], debutParts[1] - 1, debutParts[2], 0, 0, 0);
    const finParts = objectifPersonnel.dateFin.split('-');
    const dateFin = new Date(finParts[0], finParts[1] - 1, finParts[2], 23, 59, 59);
    const joursRestants = Math.max(0, Math.ceil((dateFin - aujourdhui) / (1000 * 60 * 60 * 24)));
    objectifPersonnel.joursRestants = joursRestants;

    const debutJournee = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth(), aujourdhui.getDate(), 0, 0, 0);
    const finJournee = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth(), aujourdhui.getDate(), 23, 59, 59, 999);

    const ventesJour = ventes.filter(v => {
        const d = new Date(v.date);
        return d >= debutJournee && d <= finJournee && d >= dateDebutObjectif && !v.retournee;
    });

    const beneficeJour = ventesJour.reduce((sum, v) => sum + v.benefice, 0);
    const caJour = ventesJour.reduce((sum, v) => sum + v.ca, 0);
    const nbVentesJour = ventesJour.length;

    const objectifBenefice = objectifPersonnel.montantJournalier || objectifJournalier;
    const objectifCA = objectifBenefice * 2;
    const objectifVentes = Math.ceil(objectifBenefice / 10000) || 5;

    const pctBenefice = objectifBenefice > 0 ? Math.min((beneficeJour / objectifBenefice) * 100, 100) : 0;
    const pctCA = objectifCA > 0 ? Math.min((caJour / objectifCA) * 100, 100) : 0;
    const pctVentes = objectifVentes > 0 ? Math.min((nbVentesJour / objectifVentes) * 100, 100) : 0;

    if (ringBenefice) {
        setTimeout(() => {
            ringBenefice.style.strokeDashoffset = circumBenefice - (circumBenefice * pctBenefice / 100);
        }, 100);
        ringBenefice.style.filter = pctBenefice >= 100 ? 'drop-shadow(0 0 6px var(--accent-green))' : 'none';
    }
    if (ringCA) {
        setTimeout(() => {
            ringCA.style.strokeDashoffset = circumCA - (circumCA * pctCA / 100);
        }, 200);
        ringCA.style.filter = pctCA >= 100 ? 'drop-shadow(0 0 6px var(--accent-blue))' : 'none';
    }
    if (ringVentes) {
        setTimeout(() => {
            ringVentes.style.strokeDashoffset = circumVentes - (circumVentes * pctVentes / 100);
        }, 300);
        ringVentes.style.filter = pctVentes >= 100 ? 'drop-shadow(0 0 6px var(--accent-purple))' : 'none';
    }

    const avgPct = Math.round((pctBenefice + pctCA + pctVentes) / 3);
    if (centerValue) {
        animateCounter(centerValue, avgPct, 800, '%');
    }

    if (objectifSlideContent) {
        const progression = objectifPersonnel.montantJournalier > 0
            ? Math.round((beneficeJour / objectifPersonnel.montantJournalier) * 100) : 0;
        const progressColor = progression >= 100 ? 'var(--accent-green)' : 'var(--accent-orange)';

        objectifSlideContent.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);">${objectifPersonnel.type || 'Objectif'}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">${joursRestants} jours restants</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: 900; color: var(--accent-green);">${Math.round(objectifPersonnel.montantTotal).toLocaleString()} ${deviseActuelle}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">${Math.round(objectifPersonnel.montantJournalier).toLocaleString()} ${deviseActuelle}/jour</div>
                </div>
            </div>
            <div style="background: var(--glass-bg); border-radius: 8px; height: 8px; overflow: hidden;">
                <div style="background: var(--gradient-success); height: 100%; width: ${Math.min(progression, 100)}%; border-radius: 8px; transition: width 0.5s;"></div>
            </div>
            <div style="text-align: center; margin-top: 8px; font-size: 12px; color: ${progressColor}; font-weight: 700;">${progression}% aujourd'hui</div>
        `;
    }
}

function suiviObjectifJour() {
    updateActivityRing();
}

// ============================================
// MORNING BRIEF STORY
// ============================================
function checkMorningBrief() {
    const heure = new Date().getHours();
    const aujourdhui = new Date().toDateString();
    const shownToday = localStorage.getItem('veko_morning_shown');
    
    if (heure >= 5 && heure < 11 && shownToday !== aujourdhui) {
        showMorningBrief();
    }
}

function showMorningBrief() {
    const hier = new Date();
    hier.setDate(hier.getDate() - 1);
    
    const ventesHier = ventes.filter(v => {
        const dateVente = new Date(v.date);
        return dateVente.toDateString() === hier.toDateString();
    });
    
    const benefHier = ventesHier.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
    const nbVentesHier = ventesHier.length;
    const aPubProvisoire = ventesHier.some(v => v.budgetPubProvisoire);
    
    const heure = new Date().getHours();
    let greeting = 'Bonjour';
    if (heure < 8) greeting = 'Debout tot !';
    else if (heure >= 10) greeting = 'Bonne matinee';
    
    document.getElementById('storyGreeting').textContent = greeting;
    document.getElementById('storyUserName').textContent = nomUtilisateur + ' !';
    document.getElementById('storyBenefHier').textContent = Math.round(benefHier).toLocaleString() + ' F';
    document.getElementById('storyVentesHier').textContent = nbVentesHier;
    
    if (aPubProvisoire) {
        document.getElementById('storyAlert').style.display = 'block';
        document.getElementById('storyAlertText').textContent = 'N\'oublie pas de repartir ta pub d\'hier !';
    } else {
        document.getElementById('storyAlert').style.display = 'none';
    }
    
    document.getElementById('morningStory').classList.add('show');
    
    setTimeout(() => {
        document.getElementById('storyProgressFill').style.width = '100%';
    }, 100);
    
    setTimeout(() => {
        closeMorningStory();
    }, 6000);
}

function closeMorningStory() {
    document.getElementById('morningStory').classList.remove('show');
    localStorage.setItem('veko_morning_shown', new Date().toDateString());
}

// ============================================
// EVENING RECALL
// ============================================
function checkEveningRecall() {
    const heure = new Date().getHours();
    const aujourdhui = new Date().toDateString();
    const shownToday = localStorage.getItem('veko_evening_shown');
    
    if (heure >= 19 && heure < 23 && shownToday !== aujourdhui) {
        const ventesAujourdhui = ventes.filter(v => {
            const dateVente = new Date(v.date);
            return dateVente.toDateString() === aujourdhui;
        });
        
        const aPubProvisoire = ventesAujourdhui.some(v => v.budgetPubProvisoire === true);
        
        if (ventesAujourdhui.length > 0 && aPubProvisoire) {
            showEveningRecall();
        }
    }
}

function showEveningRecall() {
    document.getElementById('eveningRecall').classList.add('show');
}

function closeEveningRecall() {
    document.getElementById('eveningRecall').classList.remove('show');
    localStorage.setItem('veko_evening_shown', new Date().toDateString());
}

function submitEveningPub() {
    const devise = document.getElementById('eveningDeviseMeta').value;
    const montant = Number(document.getElementById('eveningBudgetPub').value) || 0;
    
    if (montant <= 0) {
        alert('Veuillez entrer un montant valide !');
        return;
    }
    
    let budgetFCFA = montant;
    if (devise !== 'XAF' && devise !== 'FCFA') {
        budgetFCFA = montant * (tauxDeChange[devise] || 1);
    }
    
    const aujourdhui = new Date();
    const ventesAujourdhui = ventes.filter(v => {
        const dateVente = new Date(v.date);
        return dateVente.toDateString() === aujourdhui.toDateString();
    });
    
    if (ventesAujourdhui.length === 0) {
        alert('Aucune vente aujourd\'hui !');
        return;
    }
    
    const budgetParVente = budgetFCFA / ventesAujourdhui.length;
    
    ventes.forEach(v => {
        const dateVente = new Date(v.date);
        if (dateVente.toDateString() === aujourdhui.toDateString()) {
            v.budgetPub = budgetParVente;
            v.budgetPubProvisoire = false;
            v.depensesTotales = v.coutAcquisition + v.commissionTotale + v.budgetPub + v.fraisLivraisonClient;
            v.benefice = v.ca - v.depensesTotales;
        }
    });
    
    sauvegarderDonnees();
    hapticFeedback();
    closeEveningRecall();
    afficherNotification('Budget pub reparti avec succes !', 'success');
    afficherHistorique();
    chargerDashboard();
    suiviObjectifJour();
}

// ============================================
// SUNDAY STRATEGY
// ============================================
function checkSundayStrategy() {
    const jour = new Date().getDay();
    const heure = new Date().getHours();
    const shownThisWeek = localStorage.getItem('veko_sunday_shown');
    const thisWeek = getWeekNumber(new Date());
    
    if (jour === 0 && heure >= 18 && shownThisWeek !== String(thisWeek)) {
        showTab('simulation');
        afficherNotification('Dimanche soir ! C\'est le moment de planifier ta semaine !', 'info');
        localStorage.setItem('veko_sunday_shown', String(thisWeek));
    }
}

function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// ============================================
// FAB (Floating Action Button)
// ============================================
function toggleFab() {
    const fabMain = document.getElementById('fabMain');
    const fabMenu = document.getElementById('fabMenu');
    
    fabMain.classList.toggle('active');
    fabMenu.classList.toggle('show');
    hapticFeedback(5);
}

// ============================================
// NOTIFICATIONS PANEL
// ============================================
function openNotifPanel() {
    document.getElementById('notifPanel').classList.add('show');
    document.getElementById('notifOverlay').classList.add('show');
    genererConseilAxis();
    updateNotifList();
}

function closeNotifPanel() {
    document.getElementById('notifPanel').classList.remove('show');
    document.getElementById('notifOverlay').classList.remove('show');
}

function switchNotifTab(tab) {
    document.getElementById('tabNotifs').classList.remove('active');
    document.getElementById('tabConseils').classList.remove('active');
    document.getElementById('notifListNotifs').style.display = 'none';
    document.getElementById('notifListConseils').style.display = 'none';
    
    if (tab === 'notifs') {
        document.getElementById('tabNotifs').classList.add('active');
        document.getElementById('notifListNotifs').style.display = 'block';
    } else {
        document.getElementById('tabConseils').classList.add('active');
        document.getElementById('notifListConseils').style.display = 'block';
    }
}

function updateNotifList() {
    const container = document.getElementById('notifListNotifs');
    let html = '';
    
    const aujourdhui = new Date();
    const ventesAujourdhui = ventes.filter(v => {
        const dateVente = new Date(v.date);
        return dateVente.toDateString() === aujourdhui.toDateString();
    });
    
    const aPubProvisoire = ventesAujourdhui.some(v => v.budgetPubProvisoire === true);
    
    if (aPubProvisoire && ventesAujourdhui.length > 0) {
        html += `
            <div class="notif-item" style="border-left: 4px solid var(--accent-orange);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <i class="fas fa-bullhorn" style="color: var(--accent-orange);"></i>
                    <span style="font-weight: 700; color: var(--text-primary);">Budget pub a repartir</span>
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                    ${ventesAujourdhui.length} vente(s) aujourd'hui sans budget pub. N'oublie pas de le repartir !
                </p>
                <button onclick="showTab('historique'); closeNotifPanel();" style="padding: 8px 14px; background: var(--accent-orange); color: white; border: none; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer;">
                    Repartir maintenant
                </button>
            </div>
        `;
    }
    
    projets.forEach(p => {
        const ventesProjet = ventes.filter(v => v.projetId === p.id && !v.retournee);
        const vendus = ventesProjet.reduce((sum, v) => sum + v.nbPieces, 0);
        const restant = (p.nbArticles || 0) - vendus;
        
        if (restant > 0 && restant <= 3) {
            html += `
                <div class="notif-item" style="border-left: 4px solid var(--accent-red);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <i class="fas fa-box" style="color: var(--accent-red);"></i>
                        <span style="font-weight: 700; color: var(--text-primary);">Stock faible: ${p.nom}</span>
                    </div>
                    <p style="font-size: 12px; color: var(--text-muted);">
                        Il ne reste que ${restant} piece(s). Pensez a recommander !
                    </p>
                </div>
            `;
        }
    });
    
    if (html === '') {
        html = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                <p>Aucune alerte pour le moment</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// ============================================
// CONSEILS VEKO
// ============================================
function genererConseilAxis() {
    const container = document.getElementById('notifListConseils');
    if (!container) return;
    
    let conseils = [];
    
    if (ventes.length === 0) {
        conseils.push({
            icon: 'fa-lightbulb',
            color: 'var(--accent-blue)',
            titre: 'Bienvenue sur VEKO !',
            message: 'Commencez par enregistrer vos produits dans l\'onglet Projets, puis ajoutez votre premiere vente.'
        });
    } else {
        const ventesRecentes = ventes.slice(-10);
        const beneficeTotal = ventes.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
        const caTotal = ventes.filter(v => !v.retournee).reduce((sum, v) => sum + v.ca, 0);
        const margeGlobale = caTotal > 0 ? (beneficeTotal / caTotal) * 100 : 0;
        
        if (margeGlobale >= 30) {
            conseils.push({
                icon: 'fa-trophy',
                color: 'var(--accent-green)',
                titre: 'Excellente marge !',
                message: `Votre marge globale de ${margeGlobale.toFixed(1)}% est excellente. Continuez ainsi !`
            });
        } else if (margeGlobale >= 15) {
            conseils.push({
                icon: 'fa-chart-line',
                color: 'var(--accent-orange)',
                titre: 'Marge acceptable',
                message: `Votre marge de ${margeGlobale.toFixed(1)}% est correcte. Essayez d'optimiser vos couts ou d'augmenter vos prix.`
            });
        } else if (margeGlobale > 0) {
            conseils.push({
                icon: 'fa-exclamation-triangle',
                color: 'var(--accent-red)',
                titre: 'Marge faible',
                message: `Attention, votre marge de ${margeGlobale.toFixed(1)}% est trop basse. Revoyez votre strategie de prix.`
            });
        }
        
        if (projets.length > 0) {
            projets.forEach(p => {
                const ventesProjet = ventes.filter(v => v.projetId === p.id && !v.retournee);
                const vendus = ventesProjet.reduce((sum, v) => sum + v.nbPieces, 0);
                const restant = (p.nbArticles || 0) - vendus;
                
                if (restant > 0 && restant <= 3) {
                    conseils.push({
                        icon: 'fa-box',
                        color: 'var(--accent-orange)',
                        titre: `Stock bas: ${p.nom}`,
                        message: `Il ne reste que ${restant} piece(s). Anticipez votre prochaine commande pour ne pas manquer de ventes !`
                    });
                }
            });
        }
        
        const ventesRetournees = ventes.filter(v => v.retournee);
        if (ventesRetournees.length > 0) {
            const pertesTotales = ventesRetournees.reduce((sum, v) => sum + Math.abs(v.benefice), 0);
            conseils.push({
                icon: 'fa-undo',
                color: 'var(--accent-red)',
                titre: 'Retours detectes',
                message: `${ventesRetournees.length} commande(s) retournee(s) pour ${Math.round(pertesTotales).toLocaleString()} F de pertes. Analysez les raisons.`
            });
        }
        
        if (conseils.length === 0) {
            conseils.push({
                icon: 'fa-check-circle',
                color: 'var(--accent-green)',
                titre: 'Tout va bien !',
                message: `Vous avez realise ${ventes.length} vente(s) pour un benefice total de ${Math.round(beneficeTotal).toLocaleString()} F. Continuez !`
            });
        }
    }
    
    let html = conseils.map(c => `
        <div class="notif-item">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <i class="fas ${c.icon}" style="color: ${c.color};"></i>
                <span style="font-weight: 700; color: var(--text-primary);">${c.titre}</span>
            </div>
            <p style="font-size: 12px; color: var(--text-muted);">${c.message}</p>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// ============================================
// NAVIGATION
// ============================================
function showTab(tab) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    document.getElementById('page-' + tab).classList.add('active');
    
    document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.remove('active');
    });
    
    document.querySelectorAll('.desktop-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const desktopItem = document.querySelector(`.desktop-nav-item[data-tab="${tab}"]`);
    if (desktopItem) {
        desktopItem.classList.add('active');
    }
    
    const navMap = {
        'dashboard': 'navDashboard',
        'nouvelle': 'navCalcul',
        'projets': 'navProjets',
        'historique': 'navHistorique',
        'simulation': 'navSimulation'
    };
    
    const navId = navMap[tab];
    if (navId) {
        const navBtn = document.getElementById(navId);
        if (navBtn) {
            navBtn.classList.add('active');
        }
    }
    
    if (tab === 'historique') {
        afficherHistorique();
    }
    
    if (tab === 'simulation') {
        calculerSimulation();
    }
    
    if (tab === 'dashboard') {
        chargerDashboard();
        updateActivityRing();
    }
}

// ============================================
// DEVISE
// ============================================
function openModalDevise() {
    document.getElementById('modalDevise').style.display = 'block';
    document.getElementById('selectDevise').value = deviseActuelle;
}

function closeModalDevise() {
    document.getElementById('modalDevise').style.display = 'none';
}

function saveDevise() {
    deviseActuelle = document.getElementById('selectDevise').value;
    localStorage.setItem('veko_devise', deviseActuelle);
    
    document.querySelectorAll('#deviseActuelle, #deviseActuelleDesktop').forEach(el => {
        el.textContent = deviseActuelle;
    });
    document.querySelectorAll('.devise-label').forEach(el => {
        el.textContent = deviseActuelle;
    });
    
    hapticFeedback();
    closeModalDevise();
    afficherNotification('Devise mise a jour: ' + deviseActuelle, 'success');
    
    chargerDashboard();
    afficherHistorique();
}

// ============================================
// PROJETS
// ============================================
let typeProjet = 'fournisseur';

function changerTypeProjet(type) {
    typeProjet = type;
    const btnF = document.getElementById('btnProjetFournisseur');
    const btnP = document.getElementById('btnProjetProduction');
    const formF = document.getElementById('projetFormFournisseur');
    const formP = document.getElementById('projetFormProduction');
    if (type === 'fournisseur') {
        btnF.className = 'btn btn-primary'; btnF.style.flex = '1'; btnF.style.padding = '12px'; btnF.style.fontSize = '13px';
        btnP.className = 'btn btn-secondary'; btnP.style.flex = '1'; btnP.style.padding = '12px'; btnP.style.fontSize = '13px';
        formF.classList.remove('hidden');
        formP.classList.add('hidden');
    } else {
        btnP.className = 'btn btn-primary'; btnP.style.flex = '1'; btnP.style.padding = '12px'; btnP.style.fontSize = '13px';
        btnF.className = 'btn btn-secondary'; btnF.style.flex = '1'; btnF.style.padding = '12px'; btnF.style.fontSize = '13px';
        formP.classList.remove('hidden');
        formF.classList.add('hidden');
    }
}

function openModalProjet() {
    document.getElementById('modalProjet').style.display = 'block';
    document.getElementById('projetNom').value = '';
    document.getElementById('projetPrixAchat').value = '';
    document.getElementById('projetNbArticles').value = '';
    document.getElementById('projetFraisLivraison').value = '0';
    document.getElementById('projetCoutMatieres').value = '';
    document.getElementById('projetCoutMainOeuvre').value = '';
    document.getElementById('projetAutresFrais').value = '0';
    document.getElementById('projetNbProduits').value = '';
    changerTypeProjet('fournisseur');
}

function closeModalProjet() {
    document.getElementById('modalProjet').style.display = 'none';
}

function sauvegarderProjet() {
    const nom = document.getElementById('projetNom').value.trim();
    
    if (!nom) {
        alert('Veuillez entrer un nom de produit !');
        return;
    }

    let coutTotal, nbArticles, prixRevientCalc, projet;

    if (typeProjet === 'fournisseur') {
        const prixAchat = Number(document.getElementById('projetPrixAchat').value) || 0;
        nbArticles = Number(document.getElementById('projetNbArticles').value) || 0;
        const fraisLivraison = Number(document.getElementById('projetFraisLivraison').value) || 0;
        
        if (prixAchat <= 0 || nbArticles <= 0) {
            alert('Veuillez remplir tous les champs obligatoires !');
            return;
        }
        
        coutTotal = (prixAchat * nbArticles) + fraisLivraison;
        prixRevientCalc = coutTotal / nbArticles;
        
        projet = {
            id: Date.now(),
            nom: nom,
            type: 'fournisseur',
            prixAchat: prixAchat,
            nbArticles: nbArticles,
            fraisLivraison: fraisLivraison,
            prixRevient: prixRevientCalc,
            dateCreation: new Date().toISOString()
        };
    } else {
        const coutMatieres = Number(document.getElementById('projetCoutMatieres').value) || 0;
        const coutMainOeuvre = Number(document.getElementById('projetCoutMainOeuvre').value) || 0;
        const autresFrais = Number(document.getElementById('projetAutresFrais').value) || 0;
        nbArticles = Number(document.getElementById('projetNbProduits').value) || 0;
        
        if (coutMatieres <= 0 || nbArticles <= 0) {
            alert('Veuillez remplir tous les champs obligatoires !');
            return;
        }
        
        coutTotal = coutMatieres + coutMainOeuvre + autresFrais;
        prixRevientCalc = coutTotal / nbArticles;
        
        projet = {
            id: Date.now(),
            nom: nom,
            type: 'production',
            coutMatieres: coutMatieres,
            coutMainOeuvre: coutMainOeuvre,
            autresFrais: autresFrais,
            nbArticles: nbArticles,
            prixRevient: prixRevientCalc,
            dateCreation: new Date().toISOString()
        };
    }
    
    projets.push(projet);
    sauvegarderDonnees();
    
    hapticFeedback();
    closeModalProjet();
    afficherProjets();
    updateSelectProjet();
    updateChartProduitSelect();
    afficherNotification('Produit ajoute: ' + nom, 'success');
}

function afficherProjets() {
    const container = document.getElementById('listeProjets');
    
    if (projets.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>Aucun produit enregistre.<br>Cliquez sur "Nouveau" pour commencer !</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    projets.forEach(p => {
        const ventesProjet = ventes.filter(v => v.projetId === p.id && !v.retournee);
        const vendus = ventesProjet.reduce((sum, v) => sum + v.nbPieces, 0);
        const restant = (p.nbArticles || 0) - vendus;
        const beneficeProjet = ventesProjet.reduce((sum, v) => sum + v.benefice, 0);
        
        const couleurStock = restant <= 0 ? 'var(--accent-red)' : restant <= 3 ? 'var(--accent-orange)' : 'var(--accent-green)';
        
        html += `
            <div class="commande-item" style="border-left: 4px solid ${couleurStock};">
                <div class="commande-header">
                    <div>
                        <div style="font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${p.nom}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">
                            <span style="display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; margin-right: 4px; background: ${p.type === 'production' ? 'rgba(139,92,246,0.15)' : 'rgba(59,130,246,0.15)'}; color: ${p.type === 'production' ? 'var(--accent-purple)' : 'var(--accent-blue)'};">${p.type === 'production' ? 'PRODUCTION' : 'FOURNISSEUR'}</span>
                            Prix revient: ${Math.round(p.prixRevient).toLocaleString()} ${deviseActuelle}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 16px; font-weight: 900; color: ${couleurStock};">
                            ${restant} restant(s)
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted);">
                            sur ${p.nbArticles}
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        ${ventesProjet.length} vente(s) | Benefice: <span style="color: ${beneficeProjet >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 700;">${Math.round(beneficeProjet).toLocaleString()} ${deviseActuelle}</span>
                    </div>
                    <button onclick="supprimerProjet(${p.id})" style="padding: 6px 12px; background: var(--accent-red); color: white; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function supprimerProjet(projetId) {
    if (!confirm('Supprimer ce produit ?')) return;
    
    projets = projets.filter(p => p.id !== projetId);
    sauvegarderDonnees();
    hapticFeedback();
    afficherProjets();
    updateSelectProjet();
    updateChartProduitSelect();
    afficherNotification('Produit supprime', 'success');
}

function updateSelectProjet() {
    const select = document.getElementById('selectProjet');
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Saisie manuelle --</option>';
    
    projets.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.nom} (${Math.round(p.prixRevient).toLocaleString()} F)</option>`;
    });
    
    select.value = currentValue;
}

function updateChartProduitSelect() {
    const select = document.getElementById('chartProduitSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">Tous</option>';
    projets.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.nom}</option>`;
    });
}

function chargerProjetDansCalcul() {
    const projetId = Number(document.getElementById('selectProjet').value);
    
    if (!projetId) {
        document.getElementById('prixAchatUnit').value = '';
        document.getElementById('nbArticlesAchetes').value = '';
        document.getElementById('fraisLivraisonFournisseur').value = '';
        document.getElementById('resultRevient').classList.add('hidden');
        prixRevient = 0;
        return;
    }
    
    const projet = projets.find(p => p.id === projetId);
    
    document.getElementById('prixAchatUnit').value = projet.prixAchat;
    document.getElementById('nbArticlesAchetes').value = projet.nbArticles;
    document.getElementById('fraisLivraisonFournisseur').value = projet.fraisLivraison;
    
    const coutTotal = (projet.prixAchat * projet.nbArticles) + projet.fraisLivraison;
    prixRevient = projet.prixRevient;
    
    document.getElementById('coutTotalAchat').textContent = coutTotal.toLocaleString();
    document.getElementById('prixRevientUnit').textContent = Math.round(prixRevient).toLocaleString();
    document.getElementById('resultRevient').classList.remove('hidden');
}

// ============================================
// CALCUL FOURNISSEUR/PRODUCTION
// ============================================
function changerTypeCalcul(type) {
    typeCalcul = type;
    
    if (type === 'fournisseur') {
        document.getElementById('etape1Title').textContent = 'ETAPE 1 : Calcul Fournisseur';
        document.getElementById('formFournisseur').classList.remove('hidden');
        document.getElementById('formProduction').classList.add('hidden');
        document.getElementById('btnFournisseur').classList.remove('btn-secondary');
        document.getElementById('btnFournisseur').classList.add('btn-primary');
        document.getElementById('btnProduction').classList.remove('btn-primary');
        document.getElementById('btnProduction').classList.add('btn-secondary');
    } else {
        document.getElementById('etape1Title').textContent = 'ETAPE 1 : Cout de Production';
        document.getElementById('formFournisseur').classList.add('hidden');
        document.getElementById('formProduction').classList.remove('hidden');
        document.getElementById('btnFournisseur').classList.remove('btn-primary');
        document.getElementById('btnFournisseur').classList.add('btn-secondary');
        document.getElementById('btnProduction').classList.remove('btn-secondary');
        document.getElementById('btnProduction').classList.add('btn-primary');
    }
    
    document.getElementById('resultRevient').classList.add('hidden');
    prixRevient = 0;
}

function calculerRevient() {
    if (typeCalcul === 'fournisseur') {
        const prixAchatUnit = Number(document.getElementById('prixAchatUnit').value) || 0;
        const nbArticles = Number(document.getElementById('nbArticlesAchetes').value) || 0;
        const fraisLivraison = Number(document.getElementById('fraisLivraisonFournisseur').value) || 0;
        
        if (prixAchatUnit === 0 || nbArticles === 0) {
            document.getElementById('resultRevient').classList.add('hidden');
            return;
        }
        
        const coutTotal = (prixAchatUnit * nbArticles) + fraisLivraison;
        prixRevient = coutTotal / nbArticles;
        
        document.getElementById('coutTotalAchat').textContent = coutTotal.toLocaleString();
        document.getElementById('prixRevientUnit').textContent = Math.round(prixRevient).toLocaleString();
        document.getElementById('resultRevient').classList.remove('hidden');
    } else {
        const coutMatieres = Number(document.getElementById('coutMatieres').value) || 0;
        const coutMainOeuvre = Number(document.getElementById('coutMainOeuvre').value) || 0;
        const autresFrais = Number(document.getElementById('autresFrais').value) || 0;
        const nbProduits = Number(document.getElementById('nbProduitsProduction').value) || 0;
        
        if (nbProduits === 0 || (coutMatieres === 0 && coutMainOeuvre === 0)) {
            document.getElementById('resultRevient').classList.add('hidden');
            return;
        }
        
        const coutTotal = coutMatieres + coutMainOeuvre + autresFrais;
        prixRevient = coutTotal / nbProduits;
        
        document.getElementById('coutTotalAchat').textContent = coutTotal.toLocaleString();
        document.getElementById('prixRevientUnit').textContent = Math.round(prixRevient).toLocaleString();
        document.getElementById('resultRevient').classList.remove('hidden');
    }
    
    calculerCommande();
}

// ============================================
// TOGGLE BUDGET PUB ET COMMISSION
// ============================================
function toggleBudgetPubInput() {
    const option = document.getElementById('budgetPubOption').value;
    const input = document.getElementById('budgetPub');
    if (option === 'aucun') {
        input.value = 0;
        input.disabled = true;
        input.style.opacity = '0.5';
    } else {
        input.disabled = false;
        input.style.opacity = '1';
    }
    calculerCommande();
}

function toggleCommissionInput() {
    const option = document.getElementById('commissionOption').value;
    const input = document.getElementById('commissionStock');
    if (option === 'moi-meme') {
        input.value = 0;
        input.disabled = true;
        input.style.opacity = '0.5';
    } else {
        input.disabled = false;
        input.style.opacity = '1';
    }
    calculerCommande();
}

// ============================================
// CALCUL COMMANDE
// ============================================
function calculerCommande() {
    const nbPieces = Number(document.getElementById('nbPiecesCommande').value) || 0;
    const prixVente = Number(document.getElementById('prixVenteUnit').value) || 0;
    const budgetPub = Number(document.getElementById('budgetPub').value) || 0;
    const fraisLivClient = Number(document.getElementById('fraisLivraisonClient').value) || 0;
    const commissionUnit = Number(document.getElementById('commissionStock').value) || 0;
    
    if (nbPieces === 0 || prixVente === 0 || prixRevient === 0) {
        document.getElementById('resultCommande').classList.add('hidden');
        return;
    }
    
    const ca = nbPieces * prixVente;
    const coutAcquisition = nbPieces * prixRevient;
    const commissionTotale = nbPieces * commissionUnit;
    const depensesTotales = coutAcquisition + commissionTotale + budgetPub + fraisLivClient;
    const benefice = ca - depensesTotales;
    
    document.getElementById('ca').textContent = ca.toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('coutAcquisition').textContent = Math.round(coutAcquisition).toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('commissionTotale').textContent = commissionTotale.toLocaleString() + ' ' + deviseActuelle;
    
    if (budgetPub === 0) {
        document.getElementById('pubTotal').innerHTML = '<span style="color: var(--accent-orange);">0 ' + deviseActuelle + ' (a repartir)</span>';
    } else {
        document.getElementById('pubTotal').textContent = budgetPub.toLocaleString() + ' ' + deviseActuelle;
    }
    
    document.getElementById('livraisonTotal').textContent = fraisLivClient.toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('depensesTotales').textContent = Math.round(depensesTotales).toLocaleString() + ' ' + deviseActuelle;
    
    const beneficeElem = document.getElementById('beneficeNet');
    if (budgetPub === 0) {
        beneficeElem.innerHTML = Math.round(benefice).toLocaleString() + ' ' + deviseActuelle + ' <span style="font-size: 14px; color: var(--accent-orange);">(provisoire)</span>';
    } else {
        beneficeElem.textContent = Math.round(benefice).toLocaleString() + ' ' + deviseActuelle;
    }
    beneficeElem.className = 'result-value ' + (benefice >= 0 ? '' : 'negative');
    
    document.getElementById('resultCommande').classList.remove('hidden');
}

// ============================================
// REINITIALISER ETAPE 2
// ============================================
function reinitialiserEtape2() {
    document.getElementById('nomClient').value = '';
    document.getElementById('telClient').value = '';
    document.getElementById('nbPiecesCommande').value = '';
    document.getElementById('prixVenteUnit').value = '';
    document.getElementById('budgetPub').value = '0';
    document.getElementById('budgetPubOption').value = 'montant';
    document.getElementById('fraisLivraisonClient').value = '0';
    document.getElementById('commissionStock').value = '1000';
    document.getElementById('commissionOption').value = 'montant';
    document.getElementById('resultCommande').classList.add('hidden');
    
    toggleBudgetPubInput();
    toggleCommissionInput();
    
    hapticFeedback();
    afficherNotification('Formulaire reinitialise', 'info');
}

// ============================================
// ENREGISTRER VENTE
// ============================================
function enregistrerVente() {
    const nomClient = document.getElementById('nomClient').value.trim() || 'Client';
    const telClient = document.getElementById('telClient').value.trim() || '';
    const projetId = Number(document.getElementById('selectProjet').value) || null;
    const projetNom = projetId ? projets.find(p => p.id === projetId)?.nom : null;
    const nbPieces = Number(document.getElementById('nbPiecesCommande').value) || 0;
    const prixVente = Number(document.getElementById('prixVenteUnit').value) || 0;
    const budgetPub = Number(document.getElementById('budgetPub').value) || 0;
    const budgetPubOption = document.getElementById('budgetPubOption').value;
    const fraisLivClient = Number(document.getElementById('fraisLivraisonClient').value) || 0;
    const commissionUnit = Number(document.getElementById('commissionStock').value) || 0;
    const commissionOption = document.getElementById('commissionOption').value;
    
    if (nbPieces === 0 || prixVente === 0 || prixRevient === 0) {
        alert('Veuillez completer toutes les informations !');
        return;
    }
    
    const ca = nbPieces * prixVente;
    const coutAcquisition = nbPieces * prixRevient;
    const commissionTotale = nbPieces * commissionUnit;
    const depensesTotales = coutAcquisition + commissionTotale + budgetPub + fraisLivClient;
    const benefice = ca - depensesTotales;
    
    const vente = {
        id: Date.now(),
        date: new Date().toISOString(),
        nomClient: nomClient,
        telClient: telClient,
        projetId: projetId,
        projetNom: projetNom,
        nbPieces: nbPieces,
        prixVenteUnit: prixVente,
        prixRevientUnit: prixRevient,
        ca: ca,
        coutAcquisition: coutAcquisition,
        commissionUnit: commissionUnit,
        commissionTotale: commissionTotale,
        budgetPub: budgetPub,
        budgetPubProvisoire: budgetPubOption !== 'aucun' && budgetPub === 0,
        pasDeFraisPub: budgetPubOption === 'aucun',
        gestionnaireOption: commissionOption,
        fraisLivraisonClient: fraisLivClient,
        depensesTotales: depensesTotales,
        benefice: benefice
    };
    
    ventes.push(vente);
    sauvegarderDonnees();
    suiviObjectifJour();
    
    afficherNotification('Vente enregistree !', 'success');
    
    document.getElementById('nomClient').value = '';
    document.getElementById('telClient').value = '';
    document.getElementById('nbPiecesCommande').value = '';
    document.getElementById('prixVenteUnit').value = '';
    document.getElementById('budgetPub').value = '0';
    document.getElementById('budgetPubOption').value = 'montant';
    document.getElementById('fraisLivraisonClient').value = '0';
    document.getElementById('commissionStock').value = '1000';
    document.getElementById('commissionOption').value = 'montant';
    document.getElementById('resultCommande').classList.add('hidden');
    
    toggleBudgetPubInput();
    toggleCommissionInput();
}

// ============================================
// HISTORIQUE
// ============================================
function filtrerPeriode(periode) {
    periodeActive = periode;
    
    ['jour', 'semaine', 'mois', 'tout'].forEach(p => {
        const btn = document.getElementById('btn-' + p);
        if (btn) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        }
    });
    
    const activeBtn = document.getElementById('btn-' + periode);
    if (activeBtn) {
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
    }
    
    afficherHistorique();
}

function filtrerVentesPeriode() {
    const maintenant = new Date();
    const aujourdhui = new Date(maintenant.getFullYear(), maintenant.getMonth(), maintenant.getDate());
    
    if (periodeActive === 'tout') {
        return ventes;
    }
    
    return ventes.filter(v => {
        const dateVente = new Date(v.date);
        
        if (periodeActive === 'jour') {
            return dateVente >= aujourdhui;
        } else if (periodeActive === 'semaine') {
            const debutSemaine = new Date(aujourdhui);
            debutSemaine.setDate(aujourdhui.getDate() - aujourdhui.getDay() + 1);
            return dateVente >= debutSemaine;
        } else if (periodeActive === 'mois') {
            const debutMois = new Date(maintenant.getFullYear(), maintenant.getMonth(), 1);
            return dateVente >= debutMois;
        }
        
        return true;
    });
}

function getCouleurBenefice(benefice, ca) {
    const marge = ca > 0 ? (benefice / ca) * 100 : 0;
    
    if (benefice < 0) {
        return { color: 'var(--accent-red)', emoji: '', label: 'PERTE' };
    } else if (marge >= 30) {
        return { color: 'var(--accent-green)', emoji: '', label: 'EXCELLENT' };
    } else if (marge >= 15) {
        return { color: 'var(--accent-orange)', emoji: '', label: 'MOYEN' };
    } else {
        return { color: 'var(--accent-red)', emoji: '', label: 'FAIBLE' };
    }
}

function afficherHistorique() {
    const ventesFiltrees = filtrerVentesPeriode();
    
    const ventesAujourdhui = ventes.filter(v => {
        const dateVente = new Date(v.date);
        const aujourdhui = new Date();
        return dateVente.toDateString() === aujourdhui.toDateString();
    });
    
    const aPubProvisoire = ventesAujourdhui.some(v => v.budgetPubProvisoire === true);
    
    const cardRepartir = document.getElementById('cardRepartirPub');
    if (cardRepartir) {
        if (periodeActive === 'jour' && aPubProvisoire && ventesAujourdhui.length > 0) {
            cardRepartir.style.display = 'block';
        } else {
            cardRepartir.style.display = 'none';
        }
    }
    
    const nbVentes = ventesFiltrees.length;
    const beneficeTotal = ventesFiltrees.reduce((sum, v) => sum + v.benefice, 0);
    const caTotal = ventesFiltrees.reduce((sum, v) => sum + v.ca, 0);
    const depensesTotal = ventesFiltrees.reduce((sum, v) => sum + v.depensesTotales, 0);
    const marge = caTotal > 0 ? ((beneficeTotal / caTotal) * 100).toFixed(1) : 0;
    
    const couleurStats = getCouleurBenefice(beneficeTotal, caTotal);
    
    document.getElementById('statNbVentes').textContent = nbVentes;
    
    const beneficeElem = document.getElementById('statBenefice');
    beneficeElem.innerHTML = `<span style="color: ${couleurStats.color};">${couleurStats.emoji} ${Math.round(beneficeTotal).toLocaleString()} ${deviseActuelle}</span>`;
    
    document.getElementById('statCA').textContent = Math.round(caTotal).toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('statDepenses').textContent = Math.round(depensesTotal).toLocaleString() + ' ' + deviseActuelle;
    
    const margeElem = document.getElementById('statMarge');
    margeElem.textContent = marge + '%';
    margeElem.style.color = couleurStats.color;
    
    afficherPerformanceProjets(ventesFiltrees);
    
    const container = document.getElementById('listeVentes');
    
    if (ventesFiltrees.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Aucune vente pour cette periode</p>
            </div>
        `;
        return;
    }
    
    const ventesTries = [...ventesFiltrees].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = '';
    ventesTries.forEach(v => {
        const date = new Date(v.date);
        const dateStr = date.toLocaleDateString('fr-FR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const provisoireTag = v.budgetPubProvisoire ? ' <span class="badge" style="background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); font-size: 9px;">PROVISOIRE</span>' : '';
        const nomClient = v.nomClient || 'Client';
        const projetTag = v.projetNom ? ` <span class="badge" style="font-size: 9px;">${v.projetNom}</span>` : '';
        
        const couleur = getCouleurBenefice(v.benefice, v.ca);
        
        html += `
            <div class="commande-item" style="border-left: 4px solid ${couleur.color};">
                <div class="commande-header">
                    <div>
                        <span class="commande-date">${dateStr}${provisoireTag}${projetTag}</span>
                        <div style="font-size: 12px; color: var(--accent-blue); font-weight: 600; margin-top: 4px;">
                            <i class="fas fa-user" style="font-size: 10px;"></i> ${nomClient}
                        </div>
                    </div>
                    <div>
                        <div class="commande-benefice" style="color: ${couleur.color};">
                            ${couleur.emoji} ${Math.round(v.benefice).toLocaleString()} ${deviseActuelle}
                        </div>
                        <div style="font-size: 9px; color: ${couleur.color}; font-weight: 700; text-align: right; margin-top: 2px;">
                            ${couleur.label}
                        </div>
                    </div>
                </div>
                <div class="commande-details">
                    <strong>${v.nbPieces} piece(s)</strong> vendues a <strong>${v.prixVenteUnit.toLocaleString()} ${deviseActuelle}</strong><br>
                    CA: ${Math.round(v.ca).toLocaleString()} ${deviseActuelle} | Depenses: ${Math.round(v.depensesTotales).toLocaleString()} ${deviseActuelle}
                </div>
                <div style="margin-top: 10px; display: flex; gap: 8px;">
                    <button onclick="marquerRetournee(${v.id})" style="padding: 6px 12px; background: var(--accent-orange); color: white; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-undo"></i> Retournee
                    </button>
                    <button onclick="supprimerVente(${v.id})" style="padding: 6px 12px; background: var(--accent-red); color: white; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function afficherPerformanceProjets(ventesAffichees) {
    const container = document.getElementById('performanceProjets');
    const card = document.getElementById('cardPerformanceProjets');
    
    if (!container || !card) return;
    
    if (projets.length === 0) {
        card.style.display = 'none';
        return;
    }
    
    const statsProjets = {};
    
    projets.forEach(p => {
        const ventesProjet = ventesAffichees.filter(v => v.projetId === p.id);
        if (ventesProjet.length > 0) {
            const benefice = ventesProjet.reduce((sum, v) => sum + v.benefice, 0);
            const ca = ventesProjet.reduce((sum, v) => sum + v.ca, 0);
            statsProjets[p.id] = {
                nom: p.nom,
                prixRevient: p.prixRevient,
                nbVentes: ventesProjet.length,
                benefice: benefice,
                ca: ca
            };
        }
    });
    
    if (Object.keys(statsProjets).length === 0) {
        card.style.display = 'none';
        return;
    }
    
    card.style.display = 'block';
    
    let html = '';
    Object.values(statsProjets).forEach(stat => {
        const couleur = getCouleurBenefice(stat.benefice, stat.ca);
        html += `
            <div class="info-row">
                <div>
                    <div style="font-weight: 700; color: var(--text-primary);">${stat.nom}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">${stat.nbVentes} vente(s) | Revient: ${Math.round(stat.prixRevient).toLocaleString()} ${deviseActuelle}</div>
                </div>
                <div>
                    <div style="font-weight: 900; font-size: 15px; color: ${couleur.color};">
                        ${couleur.emoji} ${Math.round(stat.benefice).toLocaleString()} ${deviseActuelle}
                    </div>
                    <div style="font-size: 9px; color: ${couleur.color}; font-weight: 700; text-align: right;">
                        ${couleur.label}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function supprimerVente(id) {
    if (!confirm('Supprimer cette vente ?')) return;
    
    ventes = ventes.filter(v => v.id !== id);
    sauvegarderDonnees();
    hapticFeedback();
    afficherHistorique();
    updateMicroBadge();
    updateActivityRing();
    suiviObjectifJour();
    afficherNotification('Vente supprimee', 'success');
}

function marquerRetournee(id) {
    const vente = ventes.find(v => v.id === id);
    if (!vente) return;
    
    if (!confirm(`Marquer comme retournee ?\n\nClient: ${vente.nomClient || 'Client'}\nMontant: ${Math.round(vente.ca).toLocaleString()} F`)) {
        return;
    }
    
    vente.retournee = true;
    vente.benefice = -Math.abs(vente.depensesTotales);
    vente.ca = 0;
    
    sauvegarderDonnees();
    hapticFeedback();
    afficherHistorique();
    updateMicroBadge();
    updateActivityRing();
    suiviObjectifJour();
    genererConseilAxis();
    afficherNotification('Commande marquee comme retournee', 'warning');
}

// ============================================
// REPARTIR PUB
// ============================================
function calculerConversionPub() {
    const devise = document.getElementById('deviseMeta').value;
    const montant = Number(document.getElementById('budgetPubJour').value) || 0;
    
    document.getElementById('deviseMetaLabel').textContent = devise;
    
    if (montant > 0 && devise !== 'XAF' && devise !== 'FCFA') {
        const converti = montant * (tauxDeChange[devise] || 1);
        document.getElementById('montantConverti').textContent = Math.round(converti).toLocaleString() + ' FCFA';
        document.getElementById('resultatConversion').style.display = 'block';
    } else {
        document.getElementById('resultatConversion').style.display = 'none';
    }
}

function repartirPubJour() {
    const devise = document.getElementById('deviseMeta').value;
    const montant = Number(document.getElementById('budgetPubJour').value) || 0;
    
    if (montant <= 0) {
        alert('Veuillez entrer un montant valide !');
        return;
    }
    
    let budgetFCFA = montant;
    if (devise !== 'XAF' && devise !== 'FCFA') {
        budgetFCFA = montant * (tauxDeChange[devise] || 1);
    }
    
    const aujourdhui = new Date();
    const ventesAujourdhui = ventes.filter(v => {
        const dateVente = new Date(v.date);
        return dateVente.toDateString() === aujourdhui.toDateString();
    });
    
    if (ventesAujourdhui.length === 0) {
        alert('Aucune vente aujourd\'hui !');
        return;
    }
    
    const budgetParVente = budgetFCFA / ventesAujourdhui.length;
    
    if (!confirm(`Repartir ${Math.round(budgetFCFA).toLocaleString()} FCFA sur ${ventesAujourdhui.length} vente(s) ?\n\nCout pub par vente: ${Math.round(budgetParVente).toLocaleString()} FCFA`)) {
        return;
    }
    
    ventes.forEach(v => {
        const dateVente = new Date(v.date);
        if (dateVente.toDateString() === aujourdhui.toDateString()) {
            v.budgetPub = budgetParVente;
            v.budgetPubProvisoire = false;
            v.depensesTotales = v.coutAcquisition + v.commissionTotale + v.budgetPub + v.fraisLivraisonClient;
            v.benefice = v.ca - v.depensesTotales;
        }
    });
    
    sauvegarderDonnees();
    document.getElementById('budgetPubJour').value = '';
    document.getElementById('resultatConversion').style.display = 'none';
    hapticFeedback(50);
    afficherHistorique();
    updateMicroBadge();
    updateActivityRing();
    suiviObjectifJour();
    afficherNotification('Budget pub reparti !', 'success');
}

// ============================================
// SIMULATION
// ============================================
let typeSimulation = 'fournisseur';

function changerTypeSimulation(type) {
    typeSimulation = type;
    
    if (type === 'fournisseur') {
        document.getElementById('simBtnFournisseur').classList.remove('btn-secondary');
        document.getElementById('simBtnFournisseur').classList.add('btn-primary');
        document.getElementById('simBtnProduction').classList.remove('btn-primary');
        document.getElementById('simBtnProduction').classList.add('btn-secondary');
        document.getElementById('simZoneFournisseur').style.display = 'block';
        document.getElementById('simZoneProduction').style.display = 'none';
    } else {
        document.getElementById('simBtnProduction').classList.remove('btn-secondary');
        document.getElementById('simBtnProduction').classList.add('btn-primary');
        document.getElementById('simBtnFournisseur').classList.remove('btn-primary');
        document.getElementById('simBtnFournisseur').classList.add('btn-secondary');
        document.getElementById('simZoneFournisseur').style.display = 'none';
        document.getElementById('simZoneProduction').style.display = 'block';
    }
    
    calculerSimulation();
}

function calculerSimulation() {
    let prixRevientSim = 0;
    
    if (typeSimulation === 'fournisseur') {
        const prixAchat = Number(document.getElementById('simPrixAchat').value) || 0;
        const quantite = Number(document.getElementById('simQuantite').value) || 0;
        const fraisLiv = Number(document.getElementById('simFraisLivraison').value) || 0;
        
        if (quantite > 0) {
            prixRevientSim = (prixAchat * quantite + fraisLiv) / quantite;
        }
    } else {
        const coutMatieres = Number(document.getElementById('simCoutMatieres').value) || 0;
        const coutMainOeuvre = Number(document.getElementById('simCoutMainOeuvre').value) || 0;
        const autresFrais = Number(document.getElementById('simAutresFrais').value) || 0;
        const quantiteProd = Number(document.getElementById('simQuantiteProd').value) || 0;
        
        if (quantiteProd > 0) {
            prixRevientSim = (coutMatieres + coutMainOeuvre + autresFrais) / quantiteProd;
        }
    }
    
    const prixVente = Number(document.getElementById('simPrixVente').value) || 0;
    const commission = Number(document.getElementById('simCommission').value) || 0;
    const budgetPub = Number(document.getElementById('simBudgetPub').value) || 0;
    const devisePub = document.getElementById('simDevisePub').value;
    const fraisLivClient = Number(document.getElementById('simFraisLivClient').value) || 0;
    const ventesJour = Number(document.getElementById('simVentesJour').value) || 0;
    
    if (prixRevientSim === 0 || prixVente === 0 || ventesJour === 0) {
        document.getElementById('verdictAxis').style.display = 'none';
        document.getElementById('analyseEtSi').style.display = 'none';
        return;
    }
    
    let budgetPubFCFA = budgetPub;
    if (devisePub !== 'XAF' && devisePub !== 'FCFA') {
        budgetPubFCFA = budgetPub * (tauxDeChange[devisePub] || 1);
    }
    
    const pubParVente = budgetPubFCFA / ventesJour;
    const beneficeUnit = prixVente - prixRevientSim - commission - pubParVente - fraisLivClient;
    const ventes7jours = ventesJour * 7;
    const beneficeTotal = beneficeUnit * ventes7jours;
    const marge = (beneficeUnit / prixVente) * 100;
    
    document.getElementById('simPrixRevient').textContent = Math.round(prixRevientSim).toLocaleString() + ' F';
    document.getElementById('simBeneficeUnit').textContent = Math.round(beneficeUnit).toLocaleString() + ' F';
    document.getElementById('simBeneficeUnit').style.color = beneficeUnit > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    document.getElementById('simVentesTotal').textContent = ventes7jours;
    document.getElementById('simBeneficeTotal').textContent = Math.round(beneficeTotal).toLocaleString() + ' F';
    document.getElementById('simBeneficeTotal').style.color = beneficeTotal > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    
    let message = '';
    const nomProduit = document.getElementById('simNomProduit').value.trim() || 'ce produit';
    
    if (marge >= 30) {
        message = `<strong style="color: var(--accent-green);">Excellente strategie !</strong><br><br>Si tu vends ${nomProduit} a ${prixVente.toLocaleString()} F avec cette configuration, tu realiseras une marge de <strong>${marge.toFixed(1)}%</strong>.<br><br>Avec ${ventesJour} vente(s) par jour, tu genereras <strong>${Math.round(beneficeTotal).toLocaleString()} F de benefice en 7 jours</strong>.<br><br><strong>Mon conseil :</strong> Lance-toi ! Cette configuration est solide.`;
    } else if (marge >= 15) {
        message = `<strong style="color: var(--accent-orange);">Strategie acceptable</strong><br><br>Avec une marge de ${marge.toFixed(1)}%, tu es dans la moyenne. En 7 jours, tu ferais ${Math.round(beneficeTotal).toLocaleString()} F.<br><br><strong>Suggestions :</strong><br>- Reduire ton budget pub de ${Math.round(budgetPubFCFA * 0.2).toLocaleString()} F<br>- Ou augmenter le prix a ${Math.round(prixVente * 1.1).toLocaleString()} F`;
    } else if (marge > 0) {
        message = `<strong style="color: var(--accent-red);">Marge trop faible : ${marge.toFixed(1)}%</strong><br><br>Tu gagneras seulement ${Math.round(beneficeUnit).toLocaleString()} F par vente. Sur 7 jours: ${Math.round(beneficeTotal).toLocaleString()} F.<br><br><strong>Solutions :</strong><br>1. Augmente le prix a ${Math.round(prixVente * 1.2).toLocaleString()} F<br>2. Reduis le budget pub a ${Math.round(budgetPubFCFA * 0.5).toLocaleString()} F<br>3. Trouve un fournisseur moins cher`;
    } else {
        message = `<strong style="color: var(--accent-red);">ATTENTION : Tu vas perdre de l'argent !</strong><br><br>Avec cette configuration, tu perdrais ${Math.abs(Math.round(beneficeUnit)).toLocaleString()} F a chaque vente. Sur 7 jours: <strong>-${Math.abs(Math.round(beneficeTotal)).toLocaleString()} F</strong> !<br><br><strong>Ne lance PAS ce produit avant d'avoir :</strong><br>- Reduit drastiquement ton budget pub<br>- Augmente significativement ton prix de vente<br>- Trouve un meilleur fournisseur`;
    }
    
    document.getElementById('simMessageAxis').innerHTML = message;
    document.getElementById('verdictAxis').style.display = 'block';
    
    const ventesOpt = Math.round(ventes7jours * 1.3);
    const benefOpt = Math.round(beneficeUnit * ventesOpt);
    const ventesReal = ventes7jours;
    const benefReal = Math.round(beneficeTotal);
    const ventesPess = Math.round(ventes7jours * 0.7);
    const benefPess = Math.round(beneficeUnit * ventesPess);
    
    document.getElementById('etSiOptVentes').textContent = ventesOpt;
    document.getElementById('etSiOptBenef').textContent = benefOpt.toLocaleString() + ' F';
    document.getElementById('etSiRealVentes').textContent = ventesReal;
    document.getElementById('etSiRealBenef').textContent = benefReal.toLocaleString() + ' F';
    document.getElementById('etSiPessVentes').textContent = ventesPess;
    document.getElementById('etSiPessBenef').textContent = benefPess.toLocaleString() + ' F';
    
    document.getElementById('analyseEtSi').style.display = 'block';
}

function sauvegarderStrategie() {
    afficherNotification('Strategie enregistree dans vos notes !', 'success');
}

// ============================================
// FIXATEUR DE PRIX
// ============================================
let fixateurData = {};

function fixToggleInconnu() {
    const checkbox = document.getElementById('fixConcurrenceInconnu');
    const input = document.getElementById('fixPrixConcurrence');
    if (checkbox.checked) {
        input.value = '';
        input.disabled = true;
        input.style.opacity = '0.4';
    } else {
        input.disabled = false;
        input.style.opacity = '1';
    }
}

function fixToggleConcurrence() {
    const input = document.getElementById('fixPrixConcurrence');
    const checkbox = document.getElementById('fixConcurrenceInconnu');
    if (input.value) {
        checkbox.checked = false;
        input.disabled = false;
        input.style.opacity = '1';
    }
}

function fixAllerEtape2() {
    const nom = document.getElementById('fixNomProduit').value.trim();
    const prixObjectif = Number(document.getElementById('fixPrixObjectif').value) || 0;
    const prixConcurrence = Number(document.getElementById('fixPrixConcurrence').value) || null;
    const concurrenceInconnu = document.getElementById('fixConcurrenceInconnu').checked;

    if (!nom) {
        afficherNotification('Entrez le nom du produit', 'error');
        return;
    }
    if (prixObjectif <= 0) {
        afficherNotification('Entrez votre prix de vente souhaite', 'error');
        return;
    }

    fixateurData = {
        nom: nom,
        prixObjectif: prixObjectif,
        prixConcurrence: concurrenceInconnu ? null : prixConcurrence,
        concurrenceInconnu: concurrenceInconnu
    };

    document.getElementById('fixEtape1').classList.add('hidden');
    document.getElementById('fixEtape2').classList.remove('hidden');
    document.getElementById('fixNomProduitEtape2').textContent = nom;

    document.getElementById('fixProgressBar1').style.width = '100%';
    document.getElementById('fixStep2Dot').style.background = 'linear-gradient(135deg, #8b5cf6, #ec4899)';
    document.getElementById('fixStep2Dot').style.border = 'none';
    document.getElementById('fixStep2Dot').style.color = 'white';

    fixateurData.sourceType = null;
    hapticFeedback();
}

function fixRetourEtape1() {
    document.getElementById('fixEtape2').classList.add('hidden');
    document.getElementById('fixEtape1').classList.remove('hidden');

    document.getElementById('fixProgressBar1').style.width = '0%';
    document.getElementById('fixStep2Dot').style.background = 'var(--glass-bg)';
    document.getElementById('fixStep2Dot').style.border = '2px solid var(--diamond-border)';
    document.getElementById('fixStep2Dot').style.color = 'var(--text-muted)';
    hapticFeedback();
}

function fixChoisirSource(type) {
    fixateurData.sourceType = type;
    const gradActive = 'linear-gradient(135deg, rgba(139,92,246,0.15), rgba(236,72,153,0.15))';
    const borderActive = '#8b5cf6';

    ['local', 'import', 'production'].forEach(t => {
        const radio = document.getElementById('fixRadio' + t.charAt(0).toUpperCase() + t.slice(1));
        const dot = document.getElementById('fixDot' + t.charAt(0).toUpperCase() + t.slice(1));
        const inner = document.getElementById('fixDot' + t.charAt(0).toUpperCase() + t.slice(1) + 'Inner');
        if (t === type) {
            radio.style.background = gradActive;
            radio.style.borderColor = borderActive;
            dot.style.borderColor = borderActive;
            if (inner) { inner.style.display = 'block'; inner.style.background = '#8b5cf6'; inner.style.borderRadius = '50%'; }
        } else {
            radio.style.background = 'var(--glass-bg)';
            radio.style.borderColor = 'var(--diamond-border)';
            dot.style.borderColor = 'var(--diamond-border)';
            if (inner) inner.style.display = 'none';
        }
    });

    document.getElementById('fixZoneLocal').classList.add('hidden');
    document.getElementById('fixZoneImport').classList.add('hidden');
    document.getElementById('fixZoneProduction').classList.add('hidden');

    if (type === 'local') document.getElementById('fixZoneLocal').classList.remove('hidden');
    else if (type === 'import') document.getElementById('fixZoneImport').classList.remove('hidden');
    else if (type === 'production') document.getElementById('fixZoneProduction').classList.remove('hidden');

    hapticFeedback();
}

function fixChoisirTransport(choix) {
    fixateurData.transportType = choix;
    const gratuit = document.getElementById('fixRadioTransportGratuit');
    const paye = document.getElementById('fixRadioTransportPaye');
    const dotG = document.getElementById('fixDotTransGratuit');
    const dotP = document.getElementById('fixDotTransPaye');

    if (choix === 'gratuit') {
        gratuit.style.borderColor = '#8b5cf6';
        gratuit.style.background = 'linear-gradient(135deg, rgba(139,92,246,0.15), rgba(236,72,153,0.15))';
        dotG.style.borderColor = '#8b5cf6'; dotG.style.background = '#8b5cf6';
        paye.style.borderColor = 'var(--diamond-border)'; paye.style.background = 'var(--glass-bg)';
        dotP.style.borderColor = 'var(--diamond-border)'; dotP.style.background = 'transparent';
        document.getElementById('fixZoneTransportPaye').classList.add('hidden');
    } else {
        paye.style.borderColor = '#8b5cf6';
        paye.style.background = 'linear-gradient(135deg, rgba(139,92,246,0.15), rgba(236,72,153,0.15))';
        dotP.style.borderColor = '#8b5cf6'; dotP.style.background = '#8b5cf6';
        gratuit.style.borderColor = 'var(--diamond-border)'; gratuit.style.background = 'var(--glass-bg)';
        dotG.style.borderColor = 'var(--diamond-border)'; dotG.style.background = 'transparent';
        document.getElementById('fixZoneTransportPaye').classList.remove('hidden');
    }
    hapticFeedback();
}

function fixChoisirImportMode(mode) {
    fixateurData.importMode = mode;
    const btnG = document.getElementById('fixBtnImportGlobal');
    const btnD = document.getElementById('fixBtnImportDetail');
    if (mode === 'global') {
        btnG.className = 'btn btn-primary'; btnG.style.flex = '1'; btnG.style.padding = '12px'; btnG.style.fontSize = '12px';
        btnD.className = 'btn btn-secondary'; btnD.style.flex = '1'; btnD.style.padding = '12px'; btnD.style.fontSize = '12px';
        document.getElementById('fixZoneImportGlobal').classList.remove('hidden');
        document.getElementById('fixZoneImportDetail').classList.add('hidden');
    } else {
        btnD.className = 'btn btn-primary'; btnD.style.flex = '1'; btnD.style.padding = '12px'; btnD.style.fontSize = '12px';
        btnG.className = 'btn btn-secondary'; btnG.style.flex = '1'; btnG.style.padding = '12px'; btnG.style.fontSize = '12px';
        document.getElementById('fixZoneImportDetail').classList.remove('hidden');
        document.getElementById('fixZoneImportGlobal').classList.add('hidden');
    }
    hapticFeedback();
}

function fixToggleTemps() {
    const checked = document.getElementById('fixProdFacturerTemps').checked;
    if (checked) {
        document.getElementById('fixZoneTemps').classList.remove('hidden');
    } else {
        document.getElementById('fixZoneTemps').classList.add('hidden');
    }
}

function fixAllerEtape3() {
    if (!fixateurData.sourceType) {
        afficherNotification('Choisissez votre source d\'acquisition', 'error');
        return;
    }

    if (fixateurData.sourceType === 'local') {
        const prix = Number(document.getElementById('fixLocalPrixAchat').value) || 0;
        if (prix <= 0) { afficherNotification('Entrez le prix d\'achat unitaire', 'error'); return; }
        fixateurData.prixAchatUnit = prix;
        fixateurData.transportFrais = 0;
        if (fixateurData.transportType === 'paye') {
            const montant = Number(document.getElementById('fixLocalTransportMontant').value) || 0;
            const nb = Number(document.getElementById('fixLocalTransportNb').value) || 0;
            if (montant <= 0 || nb <= 0) { afficherNotification('Remplissez les frais de transport', 'error'); return; }
            fixateurData.transportFrais = montant / nb;
        }
    } else if (fixateurData.sourceType === 'import') {
        if (!fixateurData.importMode) { afficherNotification('Choisissez Cout Global ou Detail', 'error'); return; }
        if (fixateurData.importMode === 'global') {
            const cout = Number(document.getElementById('fixImportCoutGlobal').value) || 0;
            const nb = Number(document.getElementById('fixImportNbGlobal').value) || 0;
            if (cout <= 0 || nb <= 0) { afficherNotification('Remplissez le cout et le nombre d\'articles', 'error'); return; }
            fixateurData.prixAchatUnit = cout / nb;
        } else {
            const prixUnit = Number(document.getElementById('fixImportPrixUnit').value) || 0;
            const fraisLog = Number(document.getElementById('fixImportFraisLog').value) || 0;
            const nb = Number(document.getElementById('fixImportNbDetail').value) || 0;
            if (prixUnit <= 0 || nb <= 0) { afficherNotification('Remplissez tous les champs', 'error'); return; }
            fixateurData.prixAchatUnit = prixUnit + (fraisLog / nb);
        }
    } else if (fixateurData.sourceType === 'production') {
        const coutMat = Number(document.getElementById('fixProdCoutMateriaux').value) || 0;
        if (coutMat <= 0) { afficherNotification('Entrez le cout des materiaux', 'error'); return; }
        let coutTemps = 0;
        if (document.getElementById('fixProdFacturerTemps').checked) {
            const heures = Number(document.getElementById('fixProdHeures').value) || 0;
            const prixH = Number(document.getElementById('fixProdPrixHeure').value) || 0;
            if (heures <= 0 || prixH <= 0) { afficherNotification('Remplissez le temps et le prix horaire', 'error'); return; }
            coutTemps = heures * prixH;
        }
        fixateurData.prixAchatUnit = coutMat + coutTemps;
    }

    document.getElementById('fixProgressBar2').style.width = '100%';
    document.getElementById('fixStep3Dot').style.background = 'linear-gradient(135deg, #8b5cf6, #ec4899)';
    document.getElementById('fixStep3Dot').style.border = 'none';
    document.getElementById('fixStep3Dot').style.color = 'white';

    document.getElementById('fixEtape2').classList.add('hidden');
    document.getElementById('fixEtape3').classList.remove('hidden');
    document.getElementById('fixNomProduitEtape3').textContent = fixateurData.nom;

    hapticFeedback();
}

function fixRetourEtape2() {
    document.getElementById('fixEtape3').classList.add('hidden');
    document.getElementById('fixEtape2').classList.remove('hidden');

    document.getElementById('fixProgressBar2').style.width = '0%';
    document.getElementById('fixStep3Dot').style.background = 'var(--glass-bg)';
    document.getElementById('fixStep3Dot').style.border = '2px solid var(--diamond-border)';
    document.getElementById('fixStep3Dot').style.color = 'var(--text-muted)';
    hapticFeedback();
}

function fixCocherLesDeux() {
    document.getElementById('fixCanalBoutique').checked = true;
    document.getElementById('fixCanalEnLigne').checked = true;
    fixToggleCanal();
    hapticFeedback();
}

function fixToggleCanal() {
    const boutique = document.getElementById('fixCanalBoutique').checked;
    const enLigne = document.getElementById('fixCanalEnLigne').checked;
    const lblB = document.getElementById('fixCanalBoutiqueLabel');
    const lblE = document.getElementById('fixCanalEnLigneLabel');

    if (boutique) {
        document.getElementById('fixZoneBoutique').classList.remove('hidden');
        lblB.style.borderColor = '#8b5cf6';
        lblB.style.background = 'linear-gradient(135deg, rgba(139,92,246,0.1), rgba(236,72,153,0.1))';
    } else {
        document.getElementById('fixZoneBoutique').classList.add('hidden');
        lblB.style.borderColor = 'var(--diamond-border)';
        lblB.style.background = 'var(--glass-bg)';
    }

    if (enLigne) {
        document.getElementById('fixZoneEnLigne').classList.remove('hidden');
        lblE.style.borderColor = '#8b5cf6';
        lblE.style.background = 'linear-gradient(135deg, rgba(139,92,246,0.1), rgba(236,72,153,0.1))';
    } else {
        document.getElementById('fixZoneEnLigne').classList.add('hidden');
        lblE.style.borderColor = 'var(--diamond-border)';
        lblE.style.background = 'var(--glass-bg)';
    }
}

function fixChoisirProduitSeul(choix) {
    fixateurData.produitSeul = choix;
    const btnOui = document.getElementById('fixBtnProduitSeulOui');
    const btnNon = document.getElementById('fixBtnProduitSeulNon');
    if (choix === 'oui') {
        btnOui.className = 'btn btn-primary'; btnOui.style.flex = '1'; btnOui.style.padding = '10px'; btnOui.style.fontSize = '12px';
        btnNon.className = 'btn btn-secondary'; btnNon.style.flex = '1'; btnNon.style.padding = '10px'; btnNon.style.fontSize = '12px';
        document.getElementById('fixZoneProduitSeul').classList.remove('hidden');
        document.getElementById('fixZoneProduitMultiple').classList.add('hidden');
    } else {
        btnNon.className = 'btn btn-primary'; btnNon.style.flex = '1'; btnNon.style.padding = '10px'; btnNon.style.fontSize = '12px';
        btnOui.className = 'btn btn-secondary'; btnOui.style.flex = '1'; btnOui.style.padding = '10px'; btnOui.style.fontSize = '12px';
        document.getElementById('fixZoneProduitMultiple').classList.remove('hidden');
        document.getElementById('fixZoneProduitSeul').classList.add('hidden');
    }
    hapticFeedback();
}

function fixChoisirPalier(nb) {
    fixateurData.palierProduits = nb;
    const container = document.getElementById('fixPaliersAutresProduits');
    container.querySelectorAll('button').forEach(btn => {
        btn.className = 'btn btn-secondary';
        btn.style.padding = '8px 14px'; btn.style.fontSize = '11px';
    });
    const idx = { 10: 0, 20: 1, 50: 2, 100: 3, '-1': 4 }[nb];
    if (idx !== undefined && container.children[idx]) {
        container.children[idx].className = 'btn btn-primary';
        container.children[idx].style.padding = '8px 14px'; container.children[idx].style.fontSize = '11px';
    }
    if (nb === -1) {
        document.getElementById('fixZonePourcentLoyer').classList.remove('hidden');
    } else {
        document.getElementById('fixZonePourcentLoyer').classList.add('hidden');
        fixateurData.loyerPourcent = null;
    }
    hapticFeedback();
}

function fixChoisirPourcent(pct) {
    fixateurData.loyerPourcent = pct;
    const container = document.getElementById('fixPourcentBtns');
    container.querySelectorAll('button').forEach(btn => {
        btn.className = 'btn btn-secondary';
        btn.style.flex = '1'; btn.style.padding = '10px'; btn.style.fontSize = '12px';
    });
    const idx = { 5: 0, 10: 1, 20: 2, 50: 3 }[pct];
    if (idx !== undefined && container.children[idx]) {
        container.children[idx].className = 'btn btn-primary';
        container.children[idx].style.flex = '1'; container.children[idx].style.padding = '10px'; container.children[idx].style.fontSize = '12px';
    }
    hapticFeedback();
}

function fixTogglePubInconnu() {
    const checked = document.getElementById('fixPubInconnu').checked;
    const input = document.getElementById('fixEnLigneBudgetPub');
    if (checked) {
        input.value = '';
        input.disabled = true;
        input.style.opacity = '0.4';
        document.getElementById('fixZonePubJour').classList.remove('hidden');
    } else {
        input.disabled = false;
        input.style.opacity = '1';
        document.getElementById('fixZonePubJour').classList.add('hidden');
    }
}

function fixTogglePubInput() {
    const input = document.getElementById('fixEnLigneBudgetPub');
    if (input.value) {
        document.getElementById('fixPubInconnu').checked = false;
        input.disabled = false;
        input.style.opacity = '1';
        document.getElementById('fixZonePubJour').classList.add('hidden');
    }
}

function fixChoisirPub(choix) {
    fixateurData.faitPub = choix;
    const btnO = document.getElementById('fixBtnPubOui');
    const btnN = document.getElementById('fixBtnPubNon');
    if (choix === 'oui') {
        btnO.className = 'btn btn-primary'; btnO.style.flex = '1'; btnO.style.padding = '10px'; btnO.style.fontSize = '12px';
        btnN.className = 'btn btn-secondary'; btnN.style.flex = '1'; btnN.style.padding = '10px'; btnN.style.fontSize = '12px';
        document.getElementById('fixZonePubOui').classList.remove('hidden');
        document.getElementById('fixZonePubNon').classList.add('hidden');
    } else {
        btnN.className = 'btn btn-primary'; btnN.style.flex = '1'; btnN.style.padding = '10px'; btnN.style.fontSize = '12px';
        btnO.className = 'btn btn-secondary'; btnO.style.flex = '1'; btnO.style.padding = '10px'; btnO.style.fontSize = '12px';
        document.getElementById('fixZonePubNon').classList.remove('hidden');
        document.getElementById('fixZonePubOui').classList.add('hidden');
    }
    hapticFeedback();
}

function fixToggleVolumeInconnu() {
    fixateurData.volumeInconnu = true;
    const input = document.getElementById('fixEnLigneVolume');
    const btn = document.getElementById('fixBtnVolumeInconnu');
    input.value = '';
    input.disabled = true;
    input.style.opacity = '0.4';
    btn.className = 'btn btn-primary';
    btn.style.padding = '8px 12px'; btn.style.fontSize = '10px';
    document.getElementById('fixZoneVolumeInconnu').classList.remove('hidden');
    hapticFeedback();
}

function fixToggleVolumeInput() {
    const input = document.getElementById('fixEnLigneVolume');
    if (input.value) {
        fixateurData.volumeInconnu = false;
        input.disabled = false;
        input.style.opacity = '1';
        const btn = document.getElementById('fixBtnVolumeInconnu');
        btn.className = 'btn btn-secondary';
        btn.style.padding = '8px 12px'; btn.style.fontSize = '10px';
        document.getElementById('fixZoneVolumeInconnu').classList.add('hidden');
    }
}

function fixChoisirStaff(type) {
    fixateurData.staffType = type;
    ['fixBtnStaffNon', 'fixBtnStaffSalaire', 'fixBtnStaffCommission'].forEach(id => {
        const el = document.getElementById(id);
        el.className = 'btn btn-secondary';
        el.style.padding = '10px'; el.style.fontSize = '12px'; el.style.textAlign = 'left';
    });
    const btnId = type === 'non' ? 'fixBtnStaffNon' : type === 'salaire' ? 'fixBtnStaffSalaire' : 'fixBtnStaffCommission';
    const btn = document.getElementById(btnId);
    btn.className = 'btn btn-primary';
    btn.style.padding = '10px'; btn.style.fontSize = '12px'; btn.style.textAlign = 'left';

    document.getElementById('fixZoneStaffSalaire').classList.add('hidden');
    document.getElementById('fixZoneStaffCommission').classList.add('hidden');
    if (type === 'salaire') document.getElementById('fixZoneStaffSalaire').classList.remove('hidden');
    if (type === 'commission') document.getElementById('fixZoneStaffCommission').classList.remove('hidden');
    hapticFeedback();
}

function fixValiderEtape3() {
    const boutique = document.getElementById('fixCanalBoutique').checked;
    const enLigne = document.getElementById('fixCanalEnLigne').checked;

    if (!boutique && !enLigne) {
        afficherNotification('Choisissez au moins un canal de vente', 'error');
        return;
    }

    fixateurData.canaux = {};

    if (boutique) {
        const loyer = Number(document.getElementById('fixBoutiqueLoyerMensuel').value) || 0;
        if (loyer <= 0) { afficherNotification('Entrez le montant du loyer mensuel', 'error'); return; }
        if (!fixateurData.produitSeul) { afficherNotification('Indiquez si ce produit est le seul en boutique', 'error'); return; }

        fixateurData.canaux.boutique = { loyerMensuel: loyer };

        if (fixateurData.produitSeul === 'oui') {
            const vol = Number(document.getElementById('fixBoutiqueVolumeSeul').value) || 0;
            if (vol <= 0) { afficherNotification('Entrez le volume de vente prevu', 'error'); return; }
            fixateurData.canaux.boutique.loyerParArticle = loyer / vol;
        } else {
            if (!fixateurData.palierProduits) { afficherNotification('Choisissez le nombre de produits en boutique', 'error'); return; }
            if (fixateurData.palierProduits === -1) {
                if (!fixateurData.loyerPourcent) { afficherNotification('Choisissez le pourcentage du loyer', 'error'); return; }
                fixateurData.canaux.boutique.loyerParArticle = (loyer * fixateurData.loyerPourcent / 100);
            } else {
                fixateurData.canaux.boutique.loyerParArticle = loyer / (fixateurData.palierProduits + 1);
            }
        }
    }

    if (enLigne) {
        if (!fixateurData.faitPub) { afficherNotification('Indiquez si vous faites de la pub ou non', 'error'); return; }
        let budgetPub = 0;
        if (fixateurData.faitPub === 'oui') {
            const pubInconnu = document.getElementById('fixPubInconnu').checked;
            if (pubInconnu) {
                const pubJour = Number(document.getElementById('fixEnLignePubJour').value) || 0;
                if (pubJour <= 0) { afficherNotification('Entrez votre budget pub journalier', 'error'); return; }
                budgetPub = pubJour * 30;
            } else {
                budgetPub = Number(document.getElementById('fixEnLigneBudgetPub').value) || 0;
                if (budgetPub <= 0) { afficherNotification('Entrez le budget pub ou cochez "Je ne sais pas trop"', 'error'); return; }
            }
        }

        let volume = Number(document.getElementById('fixEnLigneVolume').value) || 0;
        if (fixateurData.volumeInconnu) {
            volume = 10;
        } else if (volume <= 0) {
            afficherNotification('Entrez le volume de vente ou cliquez "Je ne sais pas"', 'error'); return;
        }

        fixateurData.canaux.enLigne = {
            budgetPub: budgetPub,
            volume: volume,
            pubParArticle: volume > 0 ? budgetPub / volume : 0
        };
    }

    fixateurData.staff = { type: fixateurData.staffType || 'non', salaireMensuel: 0, commissionParVente: 0 };
    if (fixateurData.staffType === 'salaire') {
        const sal = Number(document.getElementById('fixStaffSalaireMontant').value) || 0;
        if (sal <= 0) { afficherNotification('Entrez le montant des salaires mensuels', 'error'); return; }
        fixateurData.staff.salaireMensuel = sal;
    } else if (fixateurData.staffType === 'commission') {
        const com = Number(document.getElementById('fixStaffCommissionMontant').value) || 0;
        if (com <= 0) { afficherNotification('Entrez le montant de la commission par vente', 'error'); return; }
        fixateurData.staff.commissionParVente = com;
    }

    hapticFeedback();
    fixGenererRapport();
}

function fixGenererRapport() {
    const d = fixateurData;
    let coutRevient = d.prixAchatUnit || 0;
    let detailCouts = [];

    detailCouts.push({ label: 'Prix acquisition / fabrication', montant: d.prixAchatUnit || 0 });

    if (d.sourceType === 'local' && d.transportFrais > 0) {
        coutRevient += d.transportFrais;
        detailCouts.push({ label: 'Transport / article', montant: d.transportFrais });
    }

    let loyerUnit = 0;
    if (d.canaux && d.canaux.boutique) {
        loyerUnit = d.canaux.boutique.loyerParArticle || 0;
        if (loyerUnit > 0) {
            coutRevient += loyerUnit;
            detailCouts.push({ label: 'Loyer & charges / article', montant: loyerUnit });
        }
    }

    let pubUnit = 0;
    if (d.canaux && d.canaux.enLigne) {
        pubUnit = d.canaux.enLigne.pubParArticle || 0;
        if (pubUnit > 0) {
            coutRevient += pubUnit;
            detailCouts.push({ label: 'Pub / article', montant: pubUnit });
        }
    }

    let staffUnit = 0;
    if (d.staff) {
        if (d.staff.commissionParVente > 0) {
            staffUnit = d.staff.commissionParVente;
            coutRevient += staffUnit;
            detailCouts.push({ label: 'Commission staff / vente', montant: staffUnit });
        }
    }

    const prixSouhaite = d.prixObjectif;
    const benefice = prixSouhaite - coutRevient;
    const marge = prixSouhaite > 0 ? (benefice / prixSouhaite) * 100 : 0;

    document.getElementById('fixEtape3').classList.add('hidden');
    document.getElementById('fixRapport').classList.remove('hidden');
    document.getElementById('fixRapportNom').textContent = d.nom;

    document.getElementById('fixRapportCoutRevient').textContent = Math.round(coutRevient).toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('fixRapportPrixSouhaite').textContent = Math.round(prixSouhaite).toLocaleString() + ' ' + deviseActuelle;

    const benefElem = document.getElementById('fixRapportBenefUnit');
    benefElem.textContent = Math.round(benefice).toLocaleString() + ' ' + deviseActuelle;
    benefElem.style.color = benefice >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

    const margePctElem = document.getElementById('fixRapportMargePct');
    margePctElem.textContent = 'Marge : ' + Math.round(marge) + '%';
    margePctElem.style.color = marge >= 30 ? 'var(--accent-green)' : marge >= 15 ? 'var(--accent-orange)' : 'var(--accent-red)';

    if (benefice > 0) {
        document.getElementById('fixRapportMargeVoulue').textContent = 'Vous gagnez ' + Math.round(benefice).toLocaleString() + ' par vente';
    } else if (benefice === 0) {
        document.getElementById('fixRapportMargeVoulue').textContent = 'Aucun benefice a ce prix';
    } else {
        document.getElementById('fixRapportMargeVoulue').textContent = 'Vous perdez ' + Math.round(Math.abs(benefice)).toLocaleString() + ' par vente';
    }

    const analysePrix = document.getElementById('fixAnalysePrix');
    if (benefice > 0 && marge >= 30) {
        analysePrix.style.background = 'rgba(16,185,129,0.08)';
        analysePrix.style.border = '1px solid rgba(16,185,129,0.2)';
        analysePrix.innerHTML = '<div style="font-size: 12px; font-weight: 700; color: var(--accent-green);"><i class="fas fa-check-circle" style="margin-right: 6px;"></i>Prix realiste</div><div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Votre prix de ' + Math.round(prixSouhaite).toLocaleString() + ' ' + deviseActuelle + ' vous laisse une bonne marge de ' + Math.round(marge) + '%. C\'est viable.</div>';
    } else if (benefice > 0 && marge >= 10) {
        analysePrix.style.background = 'rgba(245,158,11,0.08)';
        analysePrix.style.border = '1px solid rgba(245,158,11,0.2)';
        analysePrix.innerHTML = '<div style="font-size: 12px; font-weight: 700; color: var(--accent-orange);"><i class="fas fa-exclamation-circle" style="margin-right: 6px;"></i>Prix serr\u00e9</div><div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Votre marge de ' + Math.round(marge) + '% est faible. Le moindre imprevue rogne vos gains. Visez au minimum ' + Math.round(coutRevient / 0.65).toLocaleString() + ' ' + deviseActuelle + '.</div>';
    } else {
        analysePrix.style.background = 'rgba(239,68,68,0.08)';
        analysePrix.style.border = '1px solid rgba(239,68,68,0.2)';
        analysePrix.innerHTML = '<div style="font-size: 12px; font-weight: 700; color: var(--accent-red);"><i class="fas fa-times-circle" style="margin-right: 6px;"></i>Prix non viable</div><div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">A ' + Math.round(prixSouhaite).toLocaleString() + ' ' + deviseActuelle + ', vous ' + (benefice < 0 ? 'perdez ' + Math.round(Math.abs(benefice)).toLocaleString() + ' ' + deviseActuelle + ' par vente' : 'ne gagnez quasiment rien') + '. Votre cout reel est de ' + Math.round(coutRevient).toLocaleString() + ' ' + deviseActuelle + '.</div>';
    }

    const alerteConc = document.getElementById('fixAlerteConcurrence');
    const concBox = document.getElementById('fixRapportConcurrentBox');
    alerteConc.classList.add('hidden');
    concBox.style.display = 'none';

    if (d.prixConcurrence && d.prixConcurrence > 0) {
        concBox.style.display = 'block';
        document.getElementById('fixRapportPrixConcurrent').textContent = Math.round(d.prixConcurrence).toLocaleString() + ' ' + deviseActuelle;
        const ecart = d.prixConcurrence - coutRevient;
        const ecartElem = document.getElementById('fixRapportEcartConcurrent');
        if (ecart > 0) {
            ecartElem.textContent = 'Marge possible : ' + Math.round(ecart).toLocaleString() + ' ' + deviseActuelle;
            ecartElem.style.color = 'var(--accent-green)';
        } else {
            ecartElem.textContent = 'Impossible de s\'aligner';
            ecartElem.style.color = 'var(--accent-red)';
        }

        if (coutRevient > d.prixConcurrence) {
            alerteConc.classList.remove('hidden');
            document.getElementById('fixAlerteConcurrenceMsg').textContent = 'Votre cout de revient (' + Math.round(coutRevient).toLocaleString() + ' ' + deviseActuelle + ') depasse le prix concurrent (' + Math.round(d.prixConcurrence).toLocaleString() + ' ' + deviseActuelle + '). Impossible de s\'aligner sans perte.';
        }
    }

    let detailHtml = '';
    detailCouts.forEach(c => {
        detailHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--diamond-border);"><span style="font-size: 11px; color: var(--text-secondary);">' + c.label + '</span><span style="font-size: 12px; font-weight: 700; color: var(--text-primary);">' + Math.round(c.montant).toLocaleString() + ' ' + deviseActuelle + '</span></div>';
    });
    detailHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; margin-top: 4px;"><span style="font-size: 12px; font-weight: 800; color: var(--text-primary);">TOTAL (Cout reel)</span><span style="font-size: 14px; font-weight: 900; color: var(--accent-red);">' + Math.round(coutRevient).toLocaleString() + ' ' + deviseActuelle + '</span></div>';
    document.getElementById('fixDetailCouts').innerHTML = detailHtml;

    const breakeven = Math.round(coutRevient);
    const securite = Math.round(coutRevient / 0.85);
    let conseille = Math.round(coutRevient / 0.65);
    let conseilleDesc = 'Marge 30-40% - le juste milieu';
    if (d.prixConcurrence && d.prixConcurrence > coutRevient) {
        const margeConcurrent = ((d.prixConcurrence - coutRevient) / d.prixConcurrence) * 100;
        if (margeConcurrent >= 15) {
            conseille = Math.round(d.prixConcurrence * 0.95);
            conseilleDesc = 'Alignement concurrent (-5%) - marge ' + Math.round(((conseille - coutRevient) / conseille) * 100) + '%';
        }
    }
    const premium = Math.round(coutRevient / 0.40);

    document.getElementById('fixPrixBreakeven').textContent = breakeven.toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('fixPrixSecurite').textContent = securite.toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('fixPrixConseille').textContent = conseille.toLocaleString() + ' ' + deviseActuelle;
    document.getElementById('fixPrixConseilleDesc').textContent = conseilleDesc;
    document.getElementById('fixPrixPremium').textContent = premium.toLocaleString() + ' ' + deviseActuelle;

    let chargesFixes = 0;
    if (d.canaux && d.canaux.boutique && d.canaux.boutique.loyerMensuel) chargesFixes += d.canaux.boutique.loyerMensuel;
    if (d.canaux && d.canaux.enLigne && d.canaux.enLigne.budgetPub) chargesFixes += d.canaux.enLigne.budgetPub;
    if (d.staff && d.staff.salaireMensuel > 0) {
        chargesFixes += d.staff.salaireMensuel;
        detailCouts.push({ label: 'Salaire staff (mensuel dilue)', montant: d.staff.salaireMensuel });
    }

    const benefParVenteSansFixes = prixSouhaite - (d.prixAchatUnit || 0) - (d.sourceType === 'local' ? (d.transportFrais || 0) : 0) - staffUnit;
    let seuilRentabilite = 0;
    if (benefParVenteSansFixes > 0 && chargesFixes > 0) {
        seuilRentabilite = Math.ceil(chargesFixes / benefParVenteSansFixes);
    }

    const pointMortEl = document.getElementById('fixPointMort');
    const pointMortMsg = document.getElementById('fixPointMortMsg');
    if (benefParVenteSansFixes > 0 && chargesFixes > 0) {
        pointMortEl.style.display = 'block';
        pointMortMsg.innerHTML = 'Au prix de <strong>' + Math.round(prixSouhaite).toLocaleString() + ' ' + deviseActuelle + '</strong>, vous devez vendre <strong style="color: var(--accent-blue); font-size: 16px;">' + seuilRentabilite + ' articles</strong> par mois pour couvrir vos charges fixes (' + Math.round(chargesFixes).toLocaleString() + ' ' + deviseActuelle + ') et commencer a faire du benefice.';
        if (d.volumeInconnu) {
            pointMortMsg.innerHTML += '<br><span style="font-size: 11px; color: var(--accent-orange);"><i class="fas fa-exclamation-circle" style="margin-right: 4px;"></i>Volume inconnu : les calculs utilisent 10 unites/mois comme base prudente. Votre objectif reel est de ' + seuilRentabilite + ' ventes minimum.</span>';
        }
    } else if (benefice <= 0) {
        pointMortEl.style.display = 'block';
        pointMortMsg.innerHTML = '<span style="color: var(--accent-red);">A ce prix, chaque vente vous fait perdre de l\'argent. Aucun volume ne compensera. Augmentez votre prix de vente.</span>';
    } else {
        pointMortEl.style.display = 'none';
    }

    const grilleEl = document.getElementById('fixGrilleBenefices');
    const grilleContenu = document.getElementById('fixGrilleContenu');
    if (benefice > 0) {
        grilleEl.style.display = 'block';
        const paliers = [5, 10, 20, 50, 100];
        let gHtml = '';
        paliers.forEach(n => {
            const revenu = n * prixSouhaite;
            const coutVar = n * coutRevient;
            const benef = revenu - coutVar;
            const couleur = benef > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const rentable = chargesFixes > 0 && n >= seuilRentabilite;
            const badge = rentable ? ' <span style="font-size: 8px; padding: 2px 5px; background: rgba(16,185,129,0.15); color: var(--accent-green); border-radius: 4px; font-weight: 700;">RENTABLE</span>' : '';
            gHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--diamond-border);"><span style="font-size: 12px; color: var(--text-secondary);">Si vous vendez <strong style="color: var(--text-primary);">' + n + '</strong> articles' + badge + '</span><span style="font-size: 13px; font-weight: 800; color: ' + couleur + ';">' + Math.round(benef).toLocaleString() + ' ' + deviseActuelle + '</span></div>';
        });
        grilleContenu.innerHTML = gHtml;
    } else {
        grilleEl.style.display = 'none';
    }

    let conseil = '';
    if (benefice < 0) {
        conseil = 'Votre prix de vente ne couvre meme pas vos couts. Vous perdez ' + Math.round(Math.abs(benefice)).toLocaleString() + ' ' + deviseActuelle + ' a chaque vente. Il faut soit augmenter le prix a minimum ' + securite.toLocaleString() + ' ' + deviseActuelle + ', soit reduire vos charges.';
    } else if (marge < 15) {
        conseil = 'Votre marge est tres faible (' + Math.round(marge) + '%). Le moindre imprevue (retour, casse, remise) vous met en perte. Visez au moins ' + securite.toLocaleString() + ' ' + deviseActuelle + ' pour etre en securite.';
    } else if (marge < 30) {
        conseil = 'Votre marge de ' + Math.round(marge) + '% est correcte mais laisse peu de place pour investir. Pour accelerer votre croissance, visez ' + conseille.toLocaleString() + ' ' + deviseActuelle + '.';
    } else {
        conseil = 'Bonne strategie ! A ' + Math.round(prixSouhaite).toLocaleString() + ' ' + deviseActuelle + ' avec une marge de ' + Math.round(marge) + '%, vous avez un business solide.';
    }

    if (seuilRentabilite > 30) {
        conseil += ' Votre loyer est trop eleve pour ce produit seul. Vous devez vendre ' + seuilRentabilite + ' articles/mois pour etre rentable. Envisagez de vendre d\'autres articles ou d\'augmenter votre marge.';
    }
    if (loyerUnit > 0 && loyerUnit > d.prixAchatUnit * 0.3) {
        conseil += ' Vos charges fixes (loyer) representent une part importante de vos couts. Augmentez votre volume de vente pour diluer ce poids.';
    }
    if (pubUnit > 0 && pubUnit > d.prixAchatUnit * 0.5) {
        conseil += ' Votre budget pub est eleve par rapport au cout produit. Optimisez vos campagnes pour reduire le cout par vente.';
    }
    if (d.prixConcurrence && d.prixConcurrence > 0 && prixSouhaite > d.prixConcurrence * 1.3) {
        conseil += ' Votre prix est 30%+ au-dessus des concurrents. Assurez-vous d\'avoir un argument de valeur fort (qualite, service, marque).';
    }
    if (d.prixConcurrence && d.prixConcurrence > 0 && prixSouhaite < d.prixConcurrence * 0.7 && benefice > 0) {
        const pctHausse = Math.round(((d.prixConcurrence - prixSouhaite) / prixSouhaite) * 100);
        conseil += ' Vous etes tres en-dessous du prix concurrent ! Vous pouvez augmenter votre prix de ' + pctHausse + '% pour valoriser votre image et maximiser vos gains.';
    }
    if (d.volumeInconnu) {
        conseil += ' Comme votre volume est incertain, concentrez-vous sur le seuil de ' + seuilRentabilite + ' ventes/mois minimum. En-dessous, vous ne couvrez pas vos frais fixes.';
    }

    document.getElementById('fixConseilVeko').textContent = conseil;

    const scenarioAligne = document.getElementById('fixScenarioAligne');
    if (d.prixConcurrence && d.prixConcurrence > 0) {
        scenarioAligne.style.display = 'block';
        const benefAligne = d.prixConcurrence - coutRevient;
        const aligneMsg = document.getElementById('fixScenarioAligneMsg');
        if (benefAligne > 0) {
            aligneMsg.innerHTML = 'En vous alignant a <strong>' + Math.round(d.prixConcurrence).toLocaleString() + ' ' + deviseActuelle + '</strong>, votre benefice net serait de <strong style="color: var(--accent-green);">' + Math.round(benefAligne).toLocaleString() + ' ' + deviseActuelle + '</strong> par vente (marge ' + Math.round((benefAligne / d.prixConcurrence) * 100) + '%).';
        } else {
            aligneMsg.innerHTML = '<span style="color: var(--accent-red); font-weight: 700;">Alerte : S\'aligner sur la concurrence (' + Math.round(d.prixConcurrence).toLocaleString() + ' ' + deviseActuelle + ') vous fera perdre ' + Math.round(Math.abs(benefAligne)).toLocaleString() + ' ' + deviseActuelle + ' par vente. Votre cout reel est trop eleve pour ce marche.</span>';
        }
    } else {
        scenarioAligne.style.display = 'none';
    }

    const prixEquilibre = Math.round(coutRevient / 0.80);
    document.getElementById('fixScenarioEquilibreMsg').innerHTML = 'Pour couvrir tous vos frais avec <strong>20% de marge de securite</strong> pour les imprevus (retours, casse, remises), vendez a minimum <strong style="color: var(--accent-blue); font-size: 14px;">' + prixEquilibre.toLocaleString() + ' ' + deviseActuelle + '</strong>. Benefice net: ' + Math.round(prixEquilibre - coutRevient).toLocaleString() + ' ' + deviseActuelle + '/vente.';

    fixateurData._coutRevient = coutRevient;
    document.getElementById('fixScenarioPocheInput').value = '';
    document.getElementById('fixScenarioPocheMsg').textContent = '';

    const justifEl = document.getElementById('fixJustifierPrix');
    const justifContenu = document.getElementById('fixJustifierContenu');
    const prixConseilleFinal = conseille;
    if (d.prixConcurrence && d.prixConcurrence > 0 && prixConseilleFinal > d.prixConcurrence) {
        justifEl.style.display = 'block';
        const tips = [
            { icon: 'fa-truck', color: 'var(--accent-green)', text: 'Offrez la livraison gratuite pour justifier le prix et eliminer une friction d\'achat.' },
            { icon: 'fa-box-open', color: 'var(--accent-purple)', text: 'Ameliorez le packaging : un emballage premium augmente la valeur percue de 20 a 40%.' },
            { icon: 'fa-headset', color: 'var(--accent-blue)', text: 'Misez sur le SAV : un suivi client exceptionnel (WhatsApp, echange rapide) fidlise et justifie un prix plus eleve.' },
            { icon: 'fa-gift', color: 'var(--accent-orange)', text: 'Ajoutez un bonus ou cadeau : un petit extra surprise cree un effet "wow" qui desactive la comparaison de prix.' },
            { icon: 'fa-certificate', color: '#ec4899', text: 'Creez une marque / identite forte : les clients paient plus cher pour une marque en qui ils ont confiance.' },
            { icon: 'fa-clock', color: 'var(--accent-cyan)', text: 'Proposez une livraison express : la rapidite est un argument de vente puissant que vos concurrents n\'ont peut-etre pas.' }
        ];
        let tHtml = '';
        tips.forEach(t => {
            tHtml += '<div style="display: flex; align-items: flex-start; gap: 10px;"><i class="fas ' + t.icon + '" style="color: ' + t.color + '; font-size: 14px; margin-top: 2px; flex-shrink: 0;"></i><span style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;">' + t.text + '</span></div>';
        });
        justifContenu.innerHTML = tHtml;
    } else {
        justifEl.style.display = 'none';
    }
}

function fixCalculerPoche() {
    const montantNet = Number(document.getElementById('fixScenarioPocheInput').value) || 0;
    const msg = document.getElementById('fixScenarioPocheMsg');
    if (montantNet <= 0 || !fixateurData._coutRevient) {
        msg.textContent = '';
        return;
    }
    const prixPoche = Math.round(fixateurData._coutRevient + montantNet);
    const margePoche = Math.round((montantNet / prixPoche) * 100);
    msg.innerHTML = 'Pour garder <strong>' + Math.round(montantNet).toLocaleString() + ' ' + deviseActuelle + ' net</strong> dans votre poche, vous devez vendre a <strong style="color: var(--accent-green); font-size: 14px;">' + prixPoche.toLocaleString() + ' ' + deviseActuelle + '</strong> (marge ' + margePoche + '%).';
    if (fixateurData.prixConcurrence && prixPoche > fixateurData.prixConcurrence) {
        msg.innerHTML += '<br><span style="font-size: 10px; color: var(--accent-orange);"><i class="fas fa-exclamation-circle" style="margin-right: 4px;"></i>Ce prix est au-dessus du concurrent (' + Math.round(fixateurData.prixConcurrence).toLocaleString() + ' ' + deviseActuelle + '). Consultez les conseils de justification ci-dessous.</span>';
    }
}

function fixRecommencer() {
    document.getElementById('fixRapport').classList.add('hidden');
    document.getElementById('fixEtape1').classList.remove('hidden');
    document.getElementById('fixEtape2').classList.add('hidden');
    document.getElementById('fixEtape3').classList.add('hidden');

    document.getElementById('fixProgressBar1').style.width = '0%';
    document.getElementById('fixProgressBar2').style.width = '0%';
    ['fixStep2Dot', 'fixStep3Dot'].forEach(id => {
        const el = document.getElementById(id);
        el.style.background = 'var(--glass-bg)';
        el.style.border = '2px solid var(--diamond-border)';
        el.style.color = 'var(--text-muted)';
    });

    document.getElementById('fixNomProduit').value = '';
    document.getElementById('fixPrixObjectif').value = '';
    document.getElementById('fixPrixConcurrence').value = '';
    document.getElementById('fixPrixConcurrence').disabled = false;
    document.getElementById('fixPrixConcurrence').style.opacity = '1';
    document.getElementById('fixConcurrenceInconnu').checked = false;

    document.getElementById('fixLocalPrixAchat').value = '';
    document.getElementById('fixLocalTransportMontant').value = '';
    document.getElementById('fixLocalTransportNb').value = '';
    document.getElementById('fixImportCoutGlobal').value = '';
    document.getElementById('fixImportNbGlobal').value = '';
    document.getElementById('fixImportPrixUnit').value = '';
    document.getElementById('fixImportFraisLog').value = '';
    document.getElementById('fixImportNbDetail').value = '';
    document.getElementById('fixProdCoutMateriaux').value = '';
    document.getElementById('fixProdHeures').value = '';
    document.getElementById('fixProdPrixHeure').value = '';
    document.getElementById('fixProdFacturerTemps').checked = false;

    ['fixZoneLocal', 'fixZoneImport', 'fixZoneProduction', 'fixZoneTransportPaye',
     'fixZoneImportGlobal', 'fixZoneImportDetail', 'fixZoneTemps'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });

    ['fixRadioLocal', 'fixRadioImport', 'fixRadioProduction'].forEach(id => {
        const el = document.getElementById(id);
        el.style.background = 'var(--glass-bg)';
        el.style.borderColor = 'var(--diamond-border)';
    });
    ['fixDotLocalInner', 'fixDotImportInner', 'fixDotProductionInner'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    ['fixDotLocal', 'fixDotImport', 'fixDotProduction'].forEach(id => {
        document.getElementById(id).style.borderColor = 'var(--diamond-border)';
    });
    ['fixRadioTransportGratuit', 'fixRadioTransportPaye'].forEach(id => {
        const el = document.getElementById(id);
        el.style.borderColor = 'var(--diamond-border)';
        el.style.background = 'var(--glass-bg)';
    });
    ['fixDotTransGratuit', 'fixDotTransPaye'].forEach(id => {
        const el = document.getElementById(id);
        el.style.borderColor = 'var(--diamond-border)';
        el.style.background = 'transparent';
    });
    ['fixBtnImportGlobal', 'fixBtnImportDetail'].forEach(id => {
        const el = document.getElementById(id);
        el.className = 'btn btn-secondary';
        el.style.flex = '1'; el.style.padding = '12px'; el.style.fontSize = '12px';
    });

    document.getElementById('fixCanalBoutique').checked = false;
    document.getElementById('fixCanalEnLigne').checked = false;
    ['fixZoneBoutique', 'fixZoneEnLigne'].forEach(id => document.getElementById(id).classList.add('hidden'));
    ['fixCanalBoutiqueLabel', 'fixCanalEnLigneLabel'].forEach(id => {
        const el = document.getElementById(id);
        el.style.borderColor = 'var(--diamond-border)';
        el.style.background = 'var(--glass-bg)';
    });

    document.getElementById('fixBoutiqueLoyerMensuel').value = '';
    document.getElementById('fixBoutiqueVolumeSeul').value = '';
    ['fixZoneProduitSeul', 'fixZoneProduitMultiple', 'fixZonePourcentLoyer'].forEach(id => document.getElementById(id).classList.add('hidden'));
    ['fixBtnProduitSeulOui', 'fixBtnProduitSeulNon'].forEach(id => {
        const el = document.getElementById(id);
        el.className = 'btn btn-secondary';
        el.style.flex = '1'; el.style.padding = '10px'; el.style.fontSize = '12px';
    });
    document.getElementById('fixPaliersAutresProduits').querySelectorAll('button').forEach(btn => {
        btn.className = 'btn btn-secondary';
        btn.style.padding = '8px 14px'; btn.style.fontSize = '11px';
    });
    document.getElementById('fixPourcentBtns').querySelectorAll('button').forEach(btn => {
        btn.className = 'btn btn-secondary';
        btn.style.flex = '1'; btn.style.padding = '10px'; btn.style.fontSize = '12px';
    });

    ['fixBtnPubOui', 'fixBtnPubNon'].forEach(id => {
        const el = document.getElementById(id);
        el.className = 'btn btn-secondary';
        el.style.flex = '1'; el.style.padding = '10px'; el.style.fontSize = '12px';
    });
    ['fixZonePubOui', 'fixZonePubNon', 'fixZonePubJour', 'fixZoneVolumeInconnu'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('fixEnLigneBudgetPub').value = '';
    document.getElementById('fixEnLigneBudgetPub').disabled = false;
    document.getElementById('fixEnLigneBudgetPub').style.opacity = '1';
    document.getElementById('fixPubInconnu').checked = false;
    document.getElementById('fixEnLignePubJour').value = '';
    document.getElementById('fixEnLigneVolume').value = '';
    document.getElementById('fixEnLigneVolume').disabled = false;
    document.getElementById('fixEnLigneVolume').style.opacity = '1';
    const volBtn = document.getElementById('fixBtnVolumeInconnu');
    volBtn.className = 'btn btn-secondary';
    volBtn.style.padding = '8px 12px'; volBtn.style.fontSize = '10px';

    ['fixBtnStaffNon', 'fixBtnStaffSalaire', 'fixBtnStaffCommission'].forEach(id => {
        const el = document.getElementById(id);
        el.className = 'btn btn-secondary';
        el.style.padding = '10px'; el.style.fontSize = '12px'; el.style.textAlign = 'left';
    });
    ['fixZoneStaffSalaire', 'fixZoneStaffCommission'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('fixStaffSalaireMontant').value = '';
    document.getElementById('fixStaffCommissionMontant').value = '';

    document.getElementById('fixScenarioPocheInput').value = '';

    fixateurData = {};
    hapticFeedback();
}

// ============================================
// DASHBOARD CEO
// ============================================
let chartEvolution = null;
let chartRepartition = null;
let periodeKPIActive = 'mois';

function changerPeriodeKPI(periode) {
    periodeKPIActive = periode;
    
    document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    const dateRangeSelector = document.getElementById('dateRangeSelector');
    if (periode === 'personnalise') {
        dateRangeSelector.style.display = 'block';
    } else {
        dateRangeSelector.style.display = 'none';
    }
    
    updateKPILabels(periode);
    updateKPIsByPeriod(periode);
    hapticFeedback();
}

// ============================================
// KPI EXPLAIN MODAL
// ============================================
function showKPIExplain(type) {
    const modal = document.getElementById('kpiExplainModal');
    const overlay = document.getElementById('kpiExplainOverlay');
    const titleEl = document.getElementById('kpiExplainTitle');
    const contentEl = document.getElementById('kpiExplainContent');
    
    const caValue = document.getElementById('kpiCaMois').textContent;
    const benefValue = document.getElementById('kpiBeneficeMois').textContent;
    const margeValue = document.getElementById('kpiMargeMoyenne').textContent;
    const ventesValue = document.getElementById('kpiNbVentes').textContent;
    
    const explains = {
        ca: {
            icon: 'fa-chart-line',
            color: 'var(--accent-blue)',
            title: 'Chiffre d\'Affaires (CA)',
            content: `<p><strong>Votre CA actuel: ${caValue}</strong></p>
                <p>Le Chiffre d\'Affaires represente le total de vos recettes generees par les ventes sur la periode selectionnee.</p>
                <div class="kpi-explain-formula">CA = Prix de vente x Quantite vendue</div>
                <p>C\'est le montant brut que vous avez encaisse avant deduction des charges. Il indique le volume d\'activite de votre entreprise.</p>`
        },
        benefice: {
            icon: 'fa-coins',
            color: 'var(--accent-green)',
            title: 'Benefice Net',
            content: `<p><strong>Votre Benefice: ${benefValue}</strong></p>
                <p>Le Benefice Net est ce qu\'il vous reste apres avoir paye toutes vos charges: achat marchandise, pub, livraison, commission.</p>
                <div class="kpi-explain-formula">Benefice = CA - (Cout achat + Pub + Livraison + Commission)</div>
                <p>C\'est l\'argent reel que vous gagnez. Un benefice positif signifie que votre activite est rentable.</p>`
        },
        marge: {
            icon: 'fa-percentage',
            color: 'var(--accent-orange)',
            title: 'Marge Moyenne',
            content: `<p><strong>Votre Marge: ${margeValue}</strong></p>
                <p>La Marge Moyenne represente le pourcentage de benefice que vous realisez en moyenne sur chaque vente.</p>
                <div class="kpi-explain-formula">Marge = (Benefice / CA) x 100</div>
                <p>Une marge de 30% signifie que pour 100F de CA, vous gagnez 30F net. Plus la marge est elevee, plus vous etes rentable.</p>`
        },
        ventes: {
            icon: 'fa-shopping-bag',
            color: 'var(--accent-purple)',
            title: 'Nombre de Ventes',
            content: `<p><strong>Vos Ventes: ${ventesValue}</strong></p>
                <p>C\'est le nombre total de transactions effectuees sur la periode selectionnee.</p>
                <div class="kpi-explain-formula">Ventes = Nombre de commandes enregistrees</div>
                <p>Un nombre eleve de ventes avec un CA faible peut indiquer des prix trop bas. L\'ideal est d\'augmenter les deux.</p>`
        }
    };
    
    const data = explains[type];
    titleEl.innerHTML = `<i class="fas ${data.icon}" style="color: ${data.color};"></i><span>${data.title}</span>`;
    contentEl.innerHTML = data.content;
    
    modal.classList.add('show');
    overlay.classList.add('show');
}

function closeKPIExplain() {
    document.getElementById('kpiExplainModal').classList.remove('show');
    document.getElementById('kpiExplainOverlay').classList.remove('show');
}

// ============================================
// KPI PERIOD MANAGEMENT
// ============================================
function updateKPILabels(periode) {
    const labels = {
        'jour': { ca: 'CA du Jour', benefice: 'Benefice Jour', ventes: 'Ventes Jour' },
        'semaine': { ca: 'CA Semaine', benefice: 'Benefice Semaine', ventes: 'Ventes Semaine' },
        'mois': { ca: 'CA du Mois', benefice: 'Benefice Mois', ventes: 'Ventes Mois' },
        'personnalise': { ca: 'CA Periode', benefice: 'Benefice Periode', ventes: 'Ventes Periode' }
    };
    
    const l = labels[periode] || labels['mois'];
    const caLabel = document.getElementById('kpiCaLabel');
    const benefLabel = document.getElementById('kpiBeneficeLabel');
    const ventesLabel = document.getElementById('kpiVentesLabel');
    
    if (caLabel) caLabel.textContent = l.ca;
    if (benefLabel) benefLabel.textContent = l.benefice;
    if (ventesLabel) ventesLabel.textContent = l.ventes;
}

function updateKPIsByPeriod(periode) {
    const now = new Date();
    let dateDebut, dateFin;
    
    if (periode === 'jour') {
        dateDebut = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        dateFin = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
    } else if (periode === 'semaine') {
        const dayOfWeek = now.getDay();
        const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        dateDebut = new Date(now.setDate(diff));
        dateDebut.setHours(0, 0, 0, 0);
        dateFin = new Date(dateDebut);
        dateFin.setDate(dateFin.getDate() + 6);
        dateFin.setHours(23, 59, 59);
    } else if (periode === 'mois') {
        dateDebut = new Date(now.getFullYear(), now.getMonth(), 1);
        dateFin = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
    } else {
        return;
    }
    
    updateKPIsWithDates(dateDebut, dateFin);
}

function updateKPIsByDateRange() {
    const debutInput = document.getElementById('kpiDateDebut').value;
    const finInput = document.getElementById('kpiDateFin').value;
    
    if (!debutInput || !finInput) return;
    
    const dateDebut = new Date(debutInput);
    const dateFin = new Date(finInput);
    dateFin.setHours(23, 59, 59);
    
    updateKPIsWithDates(dateDebut, dateFin);
}

function updateKPIsWithDates(dateDebut, dateFin) {
    const ventesPeriode = ventes.filter(v => {
        const date = new Date(v.date);
        return date >= dateDebut && date <= dateFin;
    });
    
    const ca = ventesPeriode.reduce((sum, v) => sum + v.ca, 0);
    const benefice = ventesPeriode.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
    const marge = ca > 0 ? (benefice / ca * 100) : 0;
    const nbVentes = ventesPeriode.length;
    
    const kpiCa = document.getElementById('kpiCaMois');
    const kpiBenef = document.getElementById('kpiBeneficeMois');
    const kpiMarge = document.getElementById('kpiMargeMoyenne');
    const kpiVentes = document.getElementById('kpiNbVentes');
    
    if (kpiCa) animateCounter(kpiCa, Math.round(ca), 500, ' ' + deviseActuelle);
    if (kpiBenef) {
        animateCounter(kpiBenef, Math.round(benefice), 500, ' ' + deviseActuelle);
        kpiBenef.style.color = benefice >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    }
    if (kpiMarge) animateCounter(kpiMarge, Math.round(marge * 10) / 10, 500, '%');
    if (kpiVentes) animateCounter(kpiVentes, nbVentes, 500, '');
}

function chargerDashboard() {
    const maintenant = new Date();
    const moisActuel = maintenant.getMonth();
    const anneeActuelle = maintenant.getFullYear();
    
    const ventesMois = ventes.filter(v => {
        const date = new Date(v.date);
        return date.getMonth() === moisActuel && date.getFullYear() === anneeActuelle;
    });
    
    const caMois = ventesMois.reduce((sum, v) => sum + v.ca, 0);
    const kpiCa = document.getElementById('kpiCaMois');
    if (kpiCa) {
        animateCounter(kpiCa, Math.round(caMois), 1000, ' ' + deviseActuelle);
    }
    
    const beneficeMois = ventesMois.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
    const kpiBenef = document.getElementById('kpiBeneficeMois');
    if (kpiBenef) {
        animateCounter(kpiBenef, Math.round(beneficeMois), 1000, ' ' + deviseActuelle);
        kpiBenef.style.color = beneficeMois >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    }
    
    const margeMoyenne = caMois > 0 ? (beneficeMois / caMois * 100) : 0;
    const kpiMarge = document.getElementById('kpiMargeMoyenne');
    if (kpiMarge) {
        kpiMarge.textContent = margeMoyenne.toFixed(1) + '%';
        kpiMarge.style.color = margeMoyenne >= 30 ? 'var(--accent-green)' : margeMoyenne >= 15 ? 'var(--accent-orange)' : 'var(--accent-red)';
    }
    
    const kpiNb = document.getElementById('kpiNbVentes');
    if (kpiNb) {
        animateCounter(kpiNb, ventesMois.length, 800, '');
    }
    
    afficherObjectifMensuel();
    afficherProduitTop(ventesMois);
    afficherTauxRetour(ventesMois);
    
    chargerGraphiqueEvolution();
    
    if (projets.length > 0 && ventesMois.length > 0) {
        document.getElementById('cardRepartitionCA').style.display = 'block';
        chargerGraphiqueRepartition(ventesMois);
    } else {
        document.getElementById('cardRepartitionCA').style.display = 'none';
    }
    
    chargerProduitsRisque();
    updateObjectiveSlide();
    updateRecapSlide();
}

function afficherObjectifMensuel() {
    const objectifMensuel = JSON.parse(localStorage.getItem('veko_objectif') || 'null');
    const cardObjectif = document.getElementById('cardObjectif');
    
    if (!objectifMensuel) {
        cardObjectif.style.display = 'none';
        return;
    }
    
    const maintenant = new Date();
    if (objectifMensuel.mois !== maintenant.getMonth() || objectifMensuel.annee !== maintenant.getFullYear()) {
        cardObjectif.style.display = 'none';
        return;
    }
    
    cardObjectif.style.display = 'block';
    
    const ventesMois = ventes.filter(v => {
        const date = new Date(v.date);
        return date.getMonth() === maintenant.getMonth() && date.getFullYear() === maintenant.getFullYear();
    });
    
    const valeurActuelle = objectifMensuel.type === 'CA' 
        ? ventesMois.reduce((sum, v) => sum + v.ca, 0)
        : ventesMois.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
    
    const progression = Math.min((valeurActuelle / objectifMensuel.montant) * 100, 100);
    const couleur = progression >= 100 ? 'var(--accent-green)' : progression >= 75 ? 'var(--accent-orange)' : 'var(--accent-blue)';
    
    document.getElementById('objectifDetails').innerHTML = `
        <div style="margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 12px; color: var(--text-muted);">${objectifMensuel.type}</span>
                <span style="font-size: 12px; font-weight: 700; color: ${couleur};">${progression.toFixed(0)}%</span>
            </div>
            <div style="background: var(--diamond-border); height: 10px; border-radius: 5px; overflow: hidden;">
                <div style="background: ${couleur}; height: 100%; width: ${progression}%; transition: all 0.5s; border-radius: 5px;"></div>
            </div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
            <span>${Math.round(valeurActuelle).toLocaleString()} ${deviseActuelle}</span>
            <span>${Math.round(objectifMensuel.montant).toLocaleString()} ${deviseActuelle}</span>
        </div>
    `;
}

function afficherProduitTop(ventesMois) {
    const container = document.getElementById('produitTopPerf');
    
    if (projets.length === 0) {
        container.innerHTML = `<p style="color: var(--text-muted); font-size: 12px;">Creez des projets d'abord</p>`;
        return;
    }
    
    const statsProj = {};
    projets.forEach(p => {
        const ventesP = ventesMois.filter(v => v.projetId === p.id && !v.retournee);
        const benefP = ventesP.reduce((sum, v) => sum + v.benefice, 0);
        statsProj[p.id] = { nom: p.nom, benef: benefP, nb: ventesP.length };
    });
    
    const meilleur = Object.values(statsProj).sort((a, b) => b.benef - a.benef)[0];
    
    if (meilleur && meilleur.nb > 0) {
        container.innerHTML = `
            <div style="background: var(--gradient-success); color: white; padding: 14px; border-radius: 12px;">
                <div style="font-size: 16px; font-weight: 900; margin-bottom: 4px;">${meilleur.nom}</div>
                <div style="font-size: 12px; opacity: 0.9;">${meilleur.nb} vente(s) | ${Math.round(meilleur.benef).toLocaleString()} ${deviseActuelle}</div>
            </div>
        `;
    } else {
        container.innerHTML = `<p style="color: var(--text-muted); font-size: 12px;">Aucune vente ce mois</p>`;
    }
}

function afficherTauxRetour(ventesMois) {
    const container = document.getElementById('tauxRetour');
    
    const nbRetours = ventesMois.filter(v => v.retournee).length;
    const tauxRetour = ventesMois.length > 0 ? (nbRetours / ventesMois.length * 100) : 0;
    const couleurRetour = tauxRetour >= 10 ? 'var(--accent-red)' : tauxRetour >= 5 ? 'var(--accent-orange)' : 'var(--accent-green)';
    
    container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 12px; color: var(--text-muted);">${nbRetours} retour(s) sur ${ventesMois.length} vente(s)</span>
            <span style="font-size: 22px; font-weight: 900; color: ${couleurRetour};">${tauxRetour.toFixed(1)}%</span>
        </div>
    `;
}

function chargerGraphiqueEvolution() {
    const ctx = document.getElementById('chartEvolution7j');
    if (!ctx) return;
    
    if (chartEvolution) {
        chartEvolution.destroy();
    }
    
    const nbJours = Number(document.getElementById('chartPeriodSelect').value) || 7;
    const projetIdFilter = document.getElementById('chartProduitSelect').value;
    
    const labels = [];
    const dataCA = [];
    const dataBenef = [];
    
    for (let i = nbJours - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
        labels.push(dateStr);
        
        let ventesJour = ventes.filter(v => {
            const dv = new Date(v.date);
            return dv.toDateString() === date.toDateString();
        });
        
        if (projetIdFilter) {
            ventesJour = ventesJour.filter(v => v.projetId === Number(projetIdFilter));
        }
        
        dataCA.push(ventesJour.reduce((sum, v) => sum + v.ca, 0));
        dataBenef.push(ventesJour.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0));
    }
    
    const totalCA = dataCA.reduce((a, b) => a + b, 0);
    const totalBenef = dataBenef.reduce((a, b) => a + b, 0);
    const moyenneCA = totalCA / nbJours;
    const moyenneBenef = totalBenef / nbJours;
    
    const statsContainer = document.getElementById('chartStatsContainer');
    if (statsContainer) {
        statsContainer.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; padding: 12px; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--diamond-border);">
                <div style="text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Total CA</div>
                    <div style="font-size: 14px; font-weight: 900; color: var(--accent-blue);">${Math.round(totalCA).toLocaleString()}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Total Benef</div>
                    <div style="font-size: 14px; font-weight: 900; color: ${totalBenef >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${Math.round(totalBenef).toLocaleString()}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Moy CA/j</div>
                    <div style="font-size: 14px; font-weight: 900; color: var(--accent-blue);">${Math.round(moyenneCA).toLocaleString()}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Moy Benef/j</div>
                    <div style="font-size: 14px; font-weight: 900; color: ${moyenneBenef >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${Math.round(moyenneBenef).toLocaleString()}</div>
                </div>
            </div>
        `;
    }
    
    const couleursProduits = [
        { border: 'rgba(59, 130, 246, 1)', bg: 'rgba(59, 130, 246, 0.1)' },
        { border: 'rgba(16, 185, 129, 1)', bg: 'rgba(16, 185, 129, 0.1)' },
        { border: 'rgba(139, 92, 246, 1)', bg: 'rgba(139, 92, 246, 0.1)' },
        { border: 'rgba(245, 158, 11, 1)', bg: 'rgba(245, 158, 11, 0.1)' },
        { border: 'rgba(239, 68, 68, 1)', bg: 'rgba(239, 68, 68, 0.1)' },
        { border: 'rgba(6, 182, 212, 1)', bg: 'rgba(6, 182, 212, 0.1)' },
        { border: 'rgba(236, 72, 153, 1)', bg: 'rgba(236, 72, 153, 0.1)' },
        { border: 'rgba(34, 197, 94, 1)', bg: 'rgba(34, 197, 94, 0.1)' }
    ];
    
    let datasets = [];
    
    if (!projetIdFilter && projets.length > 1) {
        projets.forEach((projet, index) => {
            const couleur = couleursProduits[index % couleursProduits.length];
            const dataProjet = [];
            
            for (let i = nbJours - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                const ventesJour = ventes.filter(v => {
                    const dv = new Date(v.date);
                    return dv.toDateString() === date.toDateString() && v.projetId === projet.id && !v.retournee;
                });
                
                dataProjet.push(ventesJour.reduce((sum, v) => sum + v.benefice, 0));
            }
            
            const hasData = dataProjet.some(d => d !== 0);
            if (hasData) {
                datasets.push({
                    label: projet.nom,
                    data: dataProjet,
                    borderColor: couleur.border,
                    backgroundColor: couleur.bg,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 4,
                    pointBackgroundColor: couleur.border,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    borderWidth: 2
                });
            }
        });
        
        datasets.push({
            label: 'CA Total',
            data: dataCA,
            borderColor: 'rgba(255, 255, 255, 0.5)',
            backgroundColor: 'rgba(255, 255, 255, 0.05)',
            tension: 0.4,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: 'rgba(255, 255, 255, 0.5)',
            pointBorderColor: '#fff',
            pointBorderWidth: 1,
            borderWidth: 1,
            borderDash: [5, 5]
        });
    } else {
        datasets = [{
            label: 'CA (Chiffre d\'Affaires)',
            data: dataCA,
            borderColor: 'rgba(59, 130, 246, 1)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }, {
            label: 'Benefice Net',
            data: dataBenef,
            borderColor: 'rgba(16, 185, 129, 1)',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointBackgroundColor: 'rgba(16, 185, 129, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }];
    }
    
    chartEvolution = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: { 
                        color: 'rgba(255,255,255,0.7)', 
                        font: { size: 11, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(18, 26, 46, 0.95)',
                    titleColor: '#fff',
                    bodyColor: 'rgba(255,255,255,0.8)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' ' + deviseActuelle;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                },
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'rgba(255,255,255,0.5)', 
                        font: { size: 10 },
                        callback: function(value) {
                            if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                            if (value >= 1000) return (value/1000).toFixed(0) + 'K';
                            return value;
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                }
            }
        }
    });
}

function chargerGraphiqueRepartition(ventesMois) {
    const ctx = document.getElementById('chartRepartitionCA');
    if (!ctx) return;
    
    if (chartRepartition) {
        chartRepartition.destroy();
    }
    
    const caParProjet = {};
    projets.forEach(p => {
        const caP = ventesMois.filter(v => v.projetId === p.id).reduce((sum, v) => sum + v.ca, 0);
        if (caP > 0) {
            caParProjet[p.nom] = caP;
        }
    });
    
    const caSansProjet = ventesMois.filter(v => !v.projetId).reduce((sum, v) => sum + v.ca, 0);
    if (caSansProjet > 0) {
        caParProjet['Sans projet'] = caSansProjet;
    }
    
    chartRepartition = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(caParProjet),
            datasets: [{
                data: Object.values(caParProjet),
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'],
                borderWidth: 2,
                borderColor: 'rgba(10, 15, 30, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%',
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: { 
                        color: 'rgba(255,255,255,0.7)', 
                        font: { size: 11, weight: 'bold' },
                        padding: 12,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return data.labels.map((label, i) => {
                                const value = data.datasets[0].data[i];
                                const pct = ((value / total) * 100).toFixed(1);
                                return {
                                    text: label + ': ' + value.toLocaleString() + ' F (' + pct + '%)',
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    strokeStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(18, 26, 46, 0.95)',
                    titleColor: '#fff',
                    bodyColor: 'rgba(255,255,255,0.8)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const pct = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed.toLocaleString() + ' F (' + pct + '%)';
                        }
                    }
                }
            }
        }
    });
}

function chargerProduitsRisque() {
    const cardProduitsRisque = document.getElementById('cardProduitsRisque');
    const produitsRisque = document.getElementById('produitsRisque');
    
    if (projets.length === 0) {
        cardProduitsRisque.style.display = 'none';
        return;
    }
    
    const produitsProbleme = [];
    
    projets.forEach(p => {
        const ventesRecentes = ventes.filter(v => {
            const date = new Date(v.date);
            const il30j = new Date();
            il30j.setDate(il30j.getDate() - 30);
            return v.projetId === p.id && date >= il30j && !v.retournee;
        });
        
        if (ventesRecentes.length >= 3) {
            const margeMoyenne = ventesRecentes.reduce((sum, v) => sum + (v.benefice / v.ca * 100), 0) / ventesRecentes.length;
            
            if (margeMoyenne < 15) {
                produitsProbleme.push({ nom: p.nom, marge: margeMoyenne });
            }
        }
    });
    
    if (produitsProbleme.length > 0) {
        cardProduitsRisque.style.display = 'block';
        produitsRisque.innerHTML = produitsProbleme.map(p => `
            <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--accent-red);">
                <div style="font-weight: 700; color: var(--accent-red); margin-bottom: 4px;">${p.nom}</div>
                <div style="font-size: 11px; color: var(--text-muted);">Marge: ${p.marge.toFixed(1)}% (en dessous du seuil)</div>
            </div>
        `).join('');
    } else {
        cardProduitsRisque.style.display = 'none';
    }
}

// ============================================
// OBJECTIF MENSUEL
// ============================================
function saveObjectif() {
    const type = document.getElementById('objectifType').value;
    const montant = document.getElementById('objectifMontant').value;
    const dateDebut = document.getElementById('objectifDateDebut').value;
    const dateFin = document.getElementById('objectifDateFin').value;
    
    if (!montant || isNaN(montant) || Number(montant) <= 0) {
        afficherNotification('Veuillez entrer un montant valide', 'error');
        return;
    }
    
    if (!dateDebut || !dateFin) {
        afficherNotification('Veuillez selectionner les dates', 'error');
        return;
    }
    
    if (new Date(dateFin) < new Date(dateDebut)) {
        afficherNotification('La date de fin doit etre apres la date de debut', 'error');
        return;
    }
    
    const debut = new Date(dateDebut);
    const fin = new Date(dateFin);
    const joursTotal = Math.ceil((fin - debut) / (1000 * 60 * 60 * 24)) + 1;
    const aujourdhui = new Date();
    const joursRestants = Math.max(0, Math.ceil((fin - aujourdhui) / (1000 * 60 * 60 * 24)));
    const montantJournalier = Number(montant) / joursTotal;
    
    objectifPersonnel = {
        type: type,
        montantTotal: Number(montant),
        montantJournalier: montantJournalier,
        dateDebut: dateDebut,
        dateFin: dateFin,
        joursTotal: joursTotal,
        joursRestants: joursRestants
    };
    
    localStorage.setItem('veko_objectif_personnel', JSON.stringify(objectifPersonnel));
    objectifJournalier = montantJournalier;
    
    closeModalObjectif();
    hapticFeedback(30);
    afficherNotification('Objectif defini: ' + Number(montant).toLocaleString() + ' ' + deviseActuelle + ' en ' + joursTotal + ' jours', 'success');
    updateActivityRing();
}

function supprimerObjectif() {
    if (confirm('Voulez-vous vraiment supprimer cet objectif ?')) {
        objectifPersonnel = null;
        localStorage.removeItem('veko_objectif_personnel');
        objectifJournalier = 50000;
        hapticFeedback(30);
        afficherNotification('Objectif supprime', 'success');
        updateActivityRing();
    }
}

function openModalObjectif() {
    const modal = document.getElementById('modalObjectif');
    if (modal) {
        if (objectifPersonnel) {
            document.getElementById('objectifType').value = objectifPersonnel.type || 'Benefice';
            document.getElementById('objectifMontant').value = objectifPersonnel.montantTotal || '';
            document.getElementById('objectifDateDebut').value = objectifPersonnel.dateDebut || '';
            document.getElementById('objectifDateFin').value = objectifPersonnel.dateFin || '';
        } else {
            document.getElementById('objectifType').value = 'Benefice';
            document.getElementById('objectifMontant').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('objectifDateDebut').value = today;
            document.getElementById('objectifDateFin').value = '';
        }
        modal.style.display = 'block';
    }
}

function closeModalObjectif() {
    const modal = document.getElementById('modalObjectif');
    if (modal) modal.style.display = 'none';
}

// ============================================
// OBJECTIVE SLIDER
// ============================================
function slideToObjective(index) {
    const slides = document.querySelectorAll('.objective-slide');
    const dots = document.querySelectorAll('.slider-dot');
    
    slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === index);
    });
    
    dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
    });
}

function updateObjectiveSlide() {
    const container = document.getElementById('objectifSlideContent');
    if (!container) return;
    
    const objectifData = JSON.parse(localStorage.getItem('veko_objectif_perso') || 'null');
    
    if (!objectifData || !objectifData.montant) {
        container.innerHTML = `
            <div class="objective-empty">
                <div class="objective-empty-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px;">Aucun objectif defini</div>
                <button class="objective-empty-btn" onclick="definirObjectif()">
                    <i class="fas fa-bullseye"></i>
                    Se fixer un objectif
                </button>
            </div>
        `;
    } else {
        const now = new Date();
        let progression = 0;
        let valeurActuelle = 0;
        
        if (objectifData.type === 'CA') {
            valeurActuelle = ventes.reduce((sum, v) => sum + v.ca, 0);
        } else if (objectifData.type === 'Benefice') {
            valeurActuelle = ventes.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
        } else {
            valeurActuelle = ventes.length;
        }
        
        progression = Math.min((valeurActuelle / objectifData.montant) * 100, 100);
        
        container.innerHTML = `
            <div style="text-align: center; padding: 10px 0;">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                    ${objectifData.type}: ${Number(objectifData.montant).toLocaleString()} ${deviseActuelle}
                </div>
                <div style="position: relative; width: 100%; height: 12px; background: var(--diamond-border); border-radius: 6px; overflow: hidden;">
                    <div style="height: 100%; width: ${progression}%; background: var(--gradient-primary); border-radius: 6px; transition: width 0.5s;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px;">
                    <span style="color: var(--text-muted);">Actuel: ${Math.round(valeurActuelle).toLocaleString()} ${objectifData.type !== 'Ventes' ? deviseActuelle : ''}</span>
                    <span style="color: var(--accent-blue); font-weight: 700;">${progression.toFixed(0)}%</span>
                </div>
                <button onclick="definirObjectif()" style="margin-top: 12px; padding: 8px 16px; background: var(--glass-bg); border: 1px solid var(--diamond-border); border-radius: 8px; color: var(--text-secondary); font-size: 11px; cursor: pointer;">
                    <i class="fas fa-edit"></i> Modifier
                </button>
            </div>
        `;
    }
}

function updateRecapSlide() {
    const recapCA = document.getElementById('recapCA');
    const recapBenefice = document.getElementById('recapBenefice');
    
    if (!recapCA || !recapBenefice) return;
    
    const aujourdhui = new Date();
    const ventesJour = ventes.filter(v => {
        const dateVente = new Date(v.date);
        return dateVente.toDateString() === aujourdhui.toDateString();
    });
    
    const caJour = ventesJour.reduce((sum, v) => sum + v.ca, 0);
    const benefJour = ventesJour.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
    
    animateCounter(recapCA, Math.round(caJour), 500, ' ' + deviseActuelle);
    animateCounter(recapBenefice, Math.round(benefJour), 500, ' ' + deviseActuelle);
    
    recapBenefice.style.color = benefJour >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
}

// ============================================
// EXPORT PDF
// ============================================
function genererRapportPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const maintenant = new Date();
        const moisNom = maintenant.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        
        const ventesMois = ventes.filter(v => {
            const date = new Date(v.date);
            return date.getMonth() === maintenant.getMonth() && date.getFullYear() === maintenant.getFullYear();
        });
        
        const caMois = ventesMois.reduce((sum, v) => sum + v.ca, 0);
        const beneficeMois = ventesMois.filter(v => !v.retournee).reduce((sum, v) => sum + v.benefice, 0);
        const margeMois = caMois > 0 ? (beneficeMois / caMois * 100) : 0;
        const nbVentes = ventesMois.length;
        const nbRetours = ventesMois.filter(v => v.retournee).length;
        const totalPub = ventesMois.reduce((sum, v) => sum + (v.budgetPub || 0), 0);
        const totalPieces = ventesMois.reduce((sum, v) => sum + (v.nbPieces || 0), 0);
        const totalCoutAcquisition = ventesMois.reduce((sum, v) => sum + (v.coutAcquisition || 0), 0);
        const totalCommissions = ventesMois.reduce((sum, v) => sum + (v.commissionTotale || 0), 0);
        const totalLivraison = ventesMois.reduce((sum, v) => sum + (v.fraisLivraisonClient || 0), 0);
        
        doc.setFillColor(59, 130, 246);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(28);
        doc.setFont('helvetica', 'bold');
        doc.text('VEKO', 20, 25);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Rapport Mensuel - ' + moisNom, 70, 25);
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Recapitulatif Financier', 20, 55);
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        
        let y = 70;
        doc.text('Chiffre d\'Affaires Total: ' + Math.round(caMois).toLocaleString() + ' ' + deviseActuelle, 25, y);
        y += 8;
        
        doc.setTextColor(beneficeMois >= 0 ? 16 : 239, beneficeMois >= 0 ? 185 : 68, beneficeMois >= 0 ? 129 : 68);
        doc.text('Benefice Net Total: ' + Math.round(beneficeMois).toLocaleString() + ' ' + deviseActuelle, 25, y);
        y += 8;
        
        doc.setTextColor(0, 0, 0);
        doc.text('Marge Nette Moyenne: ' + margeMois.toFixed(1) + '%', 25, y);
        y += 12;
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Statistiques des Ventes', 20, y);
        y += 12;
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.text('Nombre total de ventes: ' + nbVentes, 25, y);
        y += 8;
        doc.text('Nombre d\'articles vendus: ' + totalPieces, 25, y);
        y += 8;
        doc.text('Ventes retournees: ' + nbRetours, 25, y);
        y += 12;
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Detail des Depenses', 20, y);
        y += 12;
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(239, 68, 68);
        doc.text('Cout d\'Achat Total: ' + Math.round(totalCoutAcquisition).toLocaleString() + ' ' + deviseActuelle, 25, y);
        y += 8;
        doc.text('Budget Publicite Total: ' + Math.round(totalPub).toLocaleString() + ' ' + deviseActuelle, 25, y);
        y += 8;
        doc.text('Commissions Gestionnaire: ' + Math.round(totalCommissions).toLocaleString() + ' ' + deviseActuelle, 25, y);
        y += 8;
        doc.text('Frais de Livraison: ' + Math.round(totalLivraison).toLocaleString() + ' ' + deviseActuelle, 25, y);
        y += 12;
        
        doc.setTextColor(0, 0, 0);
        if (projets.length > 0) {
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Performance par Produit', 20, y);
            y += 12;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const statsProjets = projets.map(p => {
                const ventesP = ventesMois.filter(v => v.projetId === p.id && !v.retournee);
                const benefP = ventesP.reduce((sum, v) => sum + v.benefice, 0);
                const caP = ventesP.reduce((sum, v) => sum + v.ca, 0);
                return { nom: p.nom, nb: ventesP.length, benef: benefP, ca: caP };
            }).sort((a, b) => b.benef - a.benef);
            
            statsProjets.forEach(stat => {
                if (stat.nb > 0) {
                    doc.setTextColor(stat.benef >= 0 ? 16 : 239, stat.benef >= 0 ? 185 : 68, stat.benef >= 0 ? 129 : 68);
                    doc.text(stat.nom + ': ' + stat.nb + ' vente(s) - CA: ' + Math.round(stat.ca).toLocaleString() + ' - Benef: ' + Math.round(stat.benef).toLocaleString() + ' ' + deviseActuelle, 25, y);
                    y += 8;
                }
            });
        }
        
        // PAGE 2: Graphiques
        doc.addPage();
        
        doc.setFillColor(59, 130, 246);
        doc.rect(0, 0, 210, 25, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Graphiques et Analyses', 20, 17);
        
        doc.setTextColor(0, 0, 0);
        y = 35;
        
        // Graphique Evolution
        if (chartEvolution) {
            try {
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Evolution CA et Benefices', 20, y);
                y += 5;
                
                const chartEvolutionImg = chartEvolution.toBase64Image('image/png', 1);
                doc.addImage(chartEvolutionImg, 'PNG', 15, y, 180, 80);
                y += 90;
            } catch (e) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Graphique d\'evolution non disponible', 25, y);
                y += 15;
            }
        }
        
        // Graphique Repartition
        if (chartRepartition && projets.length > 0) {
            try {
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Repartition du CA par Produit', 20, y);
                y += 5;
                
                const chartRepartitionImg = chartRepartition.toBase64Image('image/png', 1);
                doc.addImage(chartRepartitionImg, 'PNG', 40, y, 130, 80);
                y += 90;
            } catch (e) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Graphique de repartition non disponible', 25, y);
                y += 15;
            }
        }
        
        // Footer page 2
        doc.setTextColor(128, 128, 128);
        doc.setFontSize(9);
        doc.text('Page 2/2', 100, 285);
        
        // Footer page 1
        doc.setPage(1);
        doc.setTextColor(128, 128, 128);
        doc.setFontSize(9);
        doc.text('Rapport genere automatiquement par VEKO', 20, 280);
        doc.text('Date: ' + maintenant.toLocaleDateString('fr-FR') + ' a ' + maintenant.toLocaleTimeString('fr-FR'), 20, 286);
        doc.text('Page 1/2', 100, 285);
        
        doc.save('VEKO_Rapport_' + moisNom.replace(' ', '_') + '.pdf');
        
        hapticFeedback(50);
        afficherNotification('Rapport PDF genere avec succes !', 'success');
        
    } catch (error) {
        console.error('Erreur PDF:', error);
        alert('Erreur lors de la generation du PDF. Verifiez que jsPDF est charge.');
    }
}

// ============================================
// EXPORT / IMPORT DONNEES
// ============================================
function exporterDonnees() {
    const data = {
        ventes: ventes,
        projets: projets,
        devise: deviseActuelle,
        nomUtilisateur: nomUtilisateur,
        objectifJour: objectifJournalier,
        dateExport: new Date().toISOString(),
        version: 'VEKO-V2.0'
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `veko-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    hapticFeedback();
    afficherNotification('Donnees exportees !', 'success');
}

function importerDonnees() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                
                if (!confirm(`Importer ${data.ventes?.length || 0} ventes et ${data.projets?.length || 0} projets ?\n\nCela remplacera vos donnees actuelles !`)) {
                    return;
                }
                
                ventes = data.ventes || [];
                projets = data.projets || [];
                if (data.devise) {
                    deviseActuelle = data.devise;
                    document.getElementById('deviseActuelle').textContent = deviseActuelle;
                }
                if (data.nomUtilisateur) {
                    nomUtilisateur = data.nomUtilisateur;
                    localStorage.setItem('veko_user_name', nomUtilisateur);
                }
                if (data.objectifJour) {
                    objectifJournalier = data.objectifJour;
                    localStorage.setItem('veko_objectif_jour', objectifJournalier);
                }
                
                sauvegarderDonnees();
                hapticFeedback(50);
                afficherNotification('Import reussi !', 'success');
                location.reload();
                
            } catch (error) {
                alert('Fichier invalide');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// ============================================
// SAUVEGARDE LOCALE
// ============================================
function sauvegarderDonnees() {
    localStorage.setItem('nzoi_ventes', JSON.stringify(ventes));
    localStorage.setItem('nzoi_projets', JSON.stringify(projets));
}

function chargerDonnees() {
    const dataVentes = localStorage.getItem('nzoi_ventes');
    const dataProjets = localStorage.getItem('nzoi_projets');
    const dataDevise = localStorage.getItem('veko_devise');
    const dataObjectif = localStorage.getItem('veko_objectif_personnel');
    
    if (dataVentes) {
        ventes = JSON.parse(dataVentes);
    }
    if (dataProjets) {
        projets = JSON.parse(dataProjets);
    }
    if (dataDevise) {
        deviseActuelle = dataDevise;
        document.querySelectorAll('#deviseActuelle, #deviseActuelleDesktop').forEach(el => {
            el.textContent = deviseActuelle;
        });
    }
    if (dataObjectif) {
        objectifPersonnel = JSON.parse(dataObjectif);
        if (objectifPersonnel) {
            const fin = new Date(objectifPersonnel.dateFin);
            const aujourdhui = new Date();
            objectifPersonnel.joursRestants = Math.max(0, Math.ceil((fin - aujourdhui) / (1000 * 60 * 60 * 24)));
            objectifJournalier = objectifPersonnel.montantJournalier || 50000;
        }
    }
}

// ============================================
// NOTIFICATIONS SYSTEME
// ============================================
function afficherNotification(message, type = 'info') {
    const couleurs = {
        success: 'var(--accent-green)',
        warning: 'var(--accent-orange)',
        error: 'var(--accent-red)',
        info: 'var(--accent-blue)'
    };
    
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${couleurs[type]};
        color: white;
        padding: 14px 18px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        z-index: 9999;
        font-size: 13px;
        font-weight: 600;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
    `;
    notif.textContent = message;
    
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateX(100px)';
        notif.style.transition = 'all 0.3s ease-out';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}

// ============================================
// MODE UTILISATEUR
// ============================================
function toggleModeUtilisateur() {
    openModalProfil();
}

// ============================================
// EVENTS
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    checkSession();
    const emailInput = document.getElementById('authEmail');
    if (emailInput) {
        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginWithEmail();
        });
    }
});

window.addEventListener('resize', () => {
    const sidebar = document.querySelector('.desktop-sidebar');
    if (sidebar) {
        if (window.innerWidth >= 1024) {
            sidebar.style.display = 'block';
        } else {
            sidebar.style.display = 'none';
        }
    }
});

window.addEventListener('load', () => {
    const sidebar = document.querySelector('.desktop-sidebar');
    if (sidebar && window.innerWidth >= 1024) {
        sidebar.style.display = 'block';
    }
});

document.addEventListener('click', function(e) {
    const fabMain = document.getElementById('fabMain');
    const fabMenu = document.getElementById('fabMenu');
    
    if (fabMain && fabMenu && !fabMain.contains(e.target) && !fabMenu.contains(e.target)) {
        fabMain.classList.remove('active');
        fabMenu.classList.remove('show');
    }
});

</script>

</body>
</html>
